# H∆Ø·ªöNG D·∫™N T√çCH H·ª¢P THANH TO√ÅN OFFLINE VIETQR

## üìã T·ªîNG QUAN

T√†i li·ªáu n√†y m√¥ t·∫£ chi ti·∫øt c√°ch t√≠ch h·ª£p v√† s·ª≠ d·ª•ng VietQR cho thanh to√°n offline trong h·ªá th·ªëng POS (Point of Sale) c·ªßa c·ª≠a h√†ng hoa.

### üéØ M·ª•c ƒë√≠ch

- Cho ph√©p kh√°ch h√†ng thanh to√°n b·∫±ng c√°ch qu√©t QR code chuy·ªÉn kho·∫£n ng√¢n h√†ng
- T·ª± ƒë·ªông t·∫°o QR code theo chu·∫©n VietQR
- X·ª≠ l√Ω x√°c nh·∫≠n thanh to√°n th·ªß c√¥ng t·ª´ nh√¢n vi√™n
- H·ªó tr·ª£ in QR code cho kh√°ch h√†ng

---

## üèóÔ∏è KI·∫æN TR√öC H·ªÜ TH·ªêNG

### Lu·ªìng thanh to√°n offline VietQR:

```
1. Kh√°ch h√†ng ch·ªçn s·∫£n ph·∫©m ‚Üí Gi·ªè h√†ng (Session)
2. Nh√¢n vi√™n ch·ªçn "Thanh to√°n QR" ‚Üí POST /pos/checkout
3. H·ªá th·ªëng t·∫°o ƒë∆°n h√†ng v·ªõi status "Ch·ªù thanh to√°n"
4. G·ªçi VietQR API ƒë·ªÉ sinh QR chuy·ªÉn kho·∫£n
5. L∆∞u QR path v√†o session ‚Üí Redirect /pos/payment-qr
6. Hi·ªÉn th·ªã QR code v·ªõi countdown 15 ph√∫t
7. Kh√°ch h√†ng scan QR v√† chuy·ªÉn kho·∫£n
8. Nh√¢n vi√™n x√°c nh·∫≠n thanh to√°n ‚Üí POST /pos/manual-confirm-payment
9. C·∫≠p nh·∫≠t status = "Ho√†n t·∫•t" ‚Üí Redirect /pos/bill
10. In h√≥a ƒë∆°n
```

---

## üíª IMPLEMENTATION CHI TI·∫æT

### 1. QRCodeService - Service x·ª≠ l√Ω t·∫°o QR

**File**: `src/main/java/com/datn/Service/QRCodeService.java`

#### 1.1 C·∫•u h√¨nh c∆° b·∫£n

```java
@Service
public class QRCodeService {
    private static final String QR_CODE_IMAGE_PATH = "target/classes/static/images/qr/";

    // T·∫°o th∆∞ m·ª•c l∆∞u QR n·∫øu ch∆∞a t·ªìn t·∫°i
    File directory = new File(QR_CODE_IMAGE_PATH);
    if (!directory.exists()) {
        directory.mkdirs();
    }
}
```

#### 1.2 Method t·∫°o QR chuy·ªÉn kho·∫£n VietQR

```java
public String generateBankTransferQR(String orderCode, double amount,
    String bankAccount, String bankCode, String accountName) {

    // Th√¥ng tin ng√¢n h√†ng Techcombank
    String acqId = "970407";  // M√£ ng√¢n h√†ng TCB
    String addInfo = "Thanh toan don hang " + orderCode;
    String apiUrl = "https://api.vietqr.io/v2/generate";

    // T·∫°o JSON request body
    String jsonBody = String.format(
        "{\"accountNo\":\"%s\",\"accountName\":\"%s\",\"acqId\":\"%s\"," +
        "\"amount\":%.0f,\"addInfo\":\"%s\",\"format\":\"png\"}",
        bankAccount, accountName, acqId, amount, addInfo
    );

    // G·ªçi API VietQR
    // ... (x·ª≠ l√Ω HTTP request)

    // Parse base64 image t·ª´ response v√† l∆∞u file
    byte[] imageBytes = Base64.getDecoder().decode(base64);
    String fileName = "transfer_" + orderCode + ".png";
    Path path = Paths.get(QR_CODE_IMAGE_PATH + fileName);
    Files.write(path, imageBytes);

    return "/images/qr/" + fileName;
}
```

### 2. PosController - Controller x·ª≠ l√Ω thanh to√°n

**File**: `src/main/java/com/datn/Controller/user/PosController.java`

#### 2.1 Endpoint thanh to√°n

```java
@PostMapping("/checkout")
public String checkout(@RequestParam String paymentMethod,
    HttpSession session, Model model) {

    // Ki·ªÉm tra gi·ªè h√†ng
    List<CartItemDTO> cart = (List<CartItemDTO>) session.getAttribute("cart");
    if (cart == null || cart.isEmpty()) {
        return "redirect:/pos?error=empty_cart";
    }

    // T·∫°o ƒë∆°n h√†ng
    Order order = new Order();
    order.setPaymentMethod("PAYOS");
    order.setStatus("Ch·ªù thanh to√°n");
    order.setPaymentStatus("Ch∆∞a thanh to√°n");

    // X·ª≠ l√Ω QR code thanh to√°n
    if ("qr_code".equalsIgnoreCase(paymentMethod)) {
        String bankAccount = "19039778212018";
        String bankCode = "TCB";
        String accountName = "BUI ANH THIEN";

        String qrCodePath = qrCodeService.generateBankTransferQR(
            orderCode, total, bankAccount, bankCode, accountName);

        if (qrCodePath != null) {
            session.setAttribute("qrCodePath", qrCodePath);
            return "redirect:/pos/payment-qr?orderCode=" + orderCode;
        }
    }
}
```

#### 2.2 Hi·ªÉn th·ªã trang QR thanh to√°n

```java
@GetMapping("/payment-qr")
public String showPaymentQR(@RequestParam String orderCode,
    Model model, HttpSession session) {

    // Validate ƒë∆°n h√†ng
    Optional<Order> orderOpt = orderDAO.findByOrderCode(orderCode);
    if (orderOpt.isEmpty() || !"Ch·ªù thanh to√°n".equals(order.getStatus())) {
        return "redirect:/pos";
    }

    // L·∫•y ƒë∆∞·ªùng d·∫´n QR t·ª´ session
    String qrCodePath = (String) session.getAttribute("qrCodePath");

    model.addAttribute("qrCodePath", qrCodePath);
    model.addAttribute("orderCode", orderCode);
    model.addAttribute("totalAmount", order.getTotalAmount());
    model.addAttribute("orderDetails", order.getOrderDetails());

    return "layouts/pos-layout";
}
```

#### 2.3 X√°c nh·∫≠n thanh to√°n th·ªß c√¥ng

```java
@PostMapping("/manual-confirm-payment")
@ResponseBody
public Map<String, Object> manualConfirmPayment(
    @RequestBody Map<String, String> requestBody) {

    String orderCode = requestBody.get("orderCode");
    Optional<Order> orderOpt = orderDAO.findByOrderCode(orderCode);

    if (orderOpt.isPresent()) {
        Order order = orderOpt.get();
        order.setStatus("Ho√†n t·∫•t");
        order.setPaymentStatus("ƒê√£ thanh to√°n");
        orderDAO.save(order);

        response.put("success", true);
        response.put("redirectUrl", "/pos/bill?orderCode=" + orderCode);
    }

    return response;
}
```

### 3. Frontend - Giao di·ªán thanh to√°n QR

**File**: `src/main/resources/templates/pos-payment-qr.html`

#### 3.1 HTML hi·ªÉn th·ªã QR code

```html
<div class="qr-left">
  <div class="qr-title">
    <i class="fas fa-qrcode"></i> Qu√©t m√£ QR ƒë·ªÉ thanh to√°n
  </div>

  <!-- Hi·ªÉn th·ªã QR code -->
  <img
    th:src="${qrCodePath}"
    alt="QR Code thanh to√°n"
    class="qr-img"
    onerror="this.style.display='none'; this.nextElementSibling.style.display='block';"
  />

  <!-- Fallback khi QR kh√¥ng load ƒë∆∞·ª£c -->
  <div id="qr-fallback" style="display: none;">
    <p>Kh√¥ng th·ªÉ t·∫£i QR Code</p>
    <a th:href="${qrCodePath}" target="_blank" class="btn btn-sm btn-primary">
      Xem QR tr·ª±c ti·∫øp
    </a>
  </div>

  <!-- Th√¥ng tin ƒë∆°n h√†ng -->
  <div class="qr-order-info">
    <div class="info-block">
      <div class="info-label">M√£ ƒë∆°n</div>
      <div class="info-value" th:text="${orderCode}"></div>
    </div>
    <div class="info-block">
      <div class="info-label">S·ªë ti·ªÅn</div>
      <div
        class="info-value text-danger"
        th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'"
      ></div>
    </div>
  </div>
</div>
```

#### 3.2 Countdown timer 15 ph√∫t

```html
<div class="qr-countdown">
  <span id="countdown">15:00</span>
  <div>Th·ªùi gian ch·ªù thanh to√°n</div>
  <div class="progress">
    <div
      id="progressBar"
      class="progress-bar progress-bar-animated bg-warning"
    ></div>
  </div>
</div>
```

#### 3.3 C√°c n√∫t h√†nh ƒë·ªông

```html
<div class="qr-actions">
  <!-- X√°c nh·∫≠n thanh to√°n -->
  <button
    class="btn btn-success"
    data-bs-toggle="modal"
    data-bs-target="#confirmPaymentModal"
  >
    <i class="fas fa-check"></i> X√°c nh·∫≠n ƒë√£ thanh to√°n
  </button>

  <!-- In QR code -->
  <button class="btn btn-info" id="printQRBtn">
    <i class="fas fa-print"></i> In m√£ QR
  </button>

  <!-- H·ªßy ƒë∆°n h√†ng -->
  <button
    class="btn btn-outline-danger"
    data-bs-toggle="modal"
    data-bs-target="#cancelOrderModal"
  >
    <i class="fas fa-times"></i> H·ªßy & Quay l·∫°i POS
  </button>
</div>
```

### 4. JavaScript - X·ª≠ l√Ω frontend

**File**: `src/main/resources/static/js/pos-payment-qr.js`

#### 4.1 Countdown timer

```javascript
let timeLeft = 15 * 60; // 15 ph√∫t
let totalTime = 15 * 60;

function updateCountdown() {
  const minutes = Math.floor(timeLeft / 60);
  const seconds = timeLeft % 60;

  document.getElementById("countdown").textContent = `${minutes}:${seconds
    .toString()
    .padStart(2, "0")}`;

  // C·∫≠p nh·∫≠t progress bar
  const percentage = (timeLeft / totalTime) * 100;
  document.getElementById("progressBar").style.width = percentage + "%";

  if (timeLeft <= 0) {
    // H·∫øt th·ªùi gian, t·ª± ƒë·ªông h·ªßy ƒë∆°n
    window.location.href = "/pos/cancel-order?orderCode=" + orderCode;
  }

  timeLeft--;
}

setInterval(updateCountdown, 1000);
```

#### 4.2 X√°c nh·∫≠n thanh to√°n

```javascript
function confirmPayment(orderCode) {
  fetch("/pos/manual-confirm-payment", {
    method: "POST",
    headers: { "Content-Type": "application/json" },
    body: JSON.stringify({ orderCode: orderCode }),
  })
    .then((res) => res.json())
    .then((data) => {
      if (data.success) {
        alert("‚úÖ X√°c nh·∫≠n thanh to√°n th√†nh c√¥ng!");
        window.location.href = data.redirectUrl;
      } else {
        alert("‚ùå L·ªói: " + data.message);
      }
    });
}
```

#### 4.3 In QR code

```javascript
document.getElementById("printQRBtn").addEventListener("click", function () {
  const qrImage = document.querySelector('img[alt="QR Code thanh to√°n"]');

  // Convert image th√†nh base64 ƒë·ªÉ in
  fetch(qrImage.src)
    .then((res) => res.blob())
    .then((blob) => {
      const reader = new FileReader();
      reader.onloadend = function () {
        printQR(`<img src="${reader.result}" alt="QR Code">`);
      };
      reader.readAsDataURL(blob);
    });

  function printQR(qrImageHtml) {
    const printWindow = window.open("", "_blank");
    printWindow.document.write(`
            <html>
            <head>
                <title>In m√£ QR - ${orderCode}</title>
                <style>
                    body { text-align: center; padding: 20px; }
                    .qr-container { border: 2px solid #333; padding: 20px; }
                    img { max-width: 300px; margin: 20px 0; }
                </style>
            </head>
            <body>
                <div class="qr-container">
                    <h2>üå∏ C·ª≠a H√†ng Hoa</h2>
                    <div>M√£ ƒë∆°n h√†ng: <strong>${orderCode}</strong></div>
                    ${qrImageHtml}
                    <div>T·ªïng ti·ªÅn: ${totalAmount}</div>
                    <div>Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</div>
                </div>
            </body>
            </html>
        `);
    printWindow.print();
  }
});
```

---

## üîß C·∫§U H√åNH V√Ä THI·∫æT L·∫¨P

### 1. Th√¥ng tin ng√¢n h√†ng

```java
// Trong PosController.checkout()
String bankAccount = "19039778212018";    // S·ªë t√†i kho·∫£n
String bankCode = "TCB";                  // M√£ ng√¢n h√†ng Techcombank
String accountName = "BUI ANH THIEN";     // T√™n ch·ªß t√†i kho·∫£n
String acqId = "970407";                  // M√£ AcqId c·ªßa Techcombank
```

### 2. VietQR API Configuration

```java
// API Endpoint
String apiUrl = "https://api.vietqr.io/v2/generate";

// Request format
{
    "accountNo": "19039778212018",
    "accountName": "BUI ANH THIEN",
    "acqId": "970407",
    "amount": 150000,
    "addInfo": "Thanh toan don hang POS123",
    "format": "png"
}
```

### 3. File v√† th∆∞ m·ª•c

```
target/classes/static/images/qr/     # Th∆∞ m·ª•c l∆∞u QR code
‚îú‚îÄ‚îÄ transfer_POS123.png              # QR chuy·ªÉn kho·∫£n
‚îî‚îÄ‚îÄ payment_POS456.png               # QR thanh to√°n kh√°c
```

---

## üõ†Ô∏è WORKFLOW CHI TI·∫æT

### 1. T·∫°o ƒë∆°n h√†ng v√† QR code

```java
// 1. Nh√¢n vi√™n ch·ªçn "Thanh to√°n QR"
// 2. H·ªá th·ªëng t·∫°o order v·ªõi status "Ch·ªù thanh to√°n"
Order order = new Order();
order.setPaymentMethod("PAYOS");
order.setStatus("Ch·ªù thanh to√°n");
order.setPaymentStatus("Ch∆∞a thanh to√°n");

// 3. G·ªçi VietQR API t·∫°o QR
String qrCodePath = qrCodeService.generateBankTransferQR(
    orderCode, total, bankAccount, bankCode, accountName);

// 4. L∆∞u path v√†o session v√† redirect
session.setAttribute("qrCodePath", qrCodePath);
return "redirect:/pos/payment-qr?orderCode=" + orderCode;
```

### 2. Hi·ªÉn th·ªã trang thanh to√°n

```java
// 1. Validate ƒë∆°n h√†ng c√≥ t·ªìn t·∫°i
// 2. Ki·ªÉm tra status = "Ch·ªù thanh to√°n"
// 3. L·∫•y QR path t·ª´ session
// 4. Hi·ªÉn th·ªã QR + countdown 15 ph√∫t
// 5. C√°c n√∫t: X√°c nh·∫≠n, In QR, H·ªßy ƒë∆°n
```

### 3. X·ª≠ l√Ω thanh to√°n

```javascript
// 1. Kh√°ch h√†ng scan QR v√† chuy·ªÉn kho·∫£n
// 2. Nh√¢n vi√™n ki·ªÉm tra app ng√¢n h√†ng
// 3. Click "X√°c nh·∫≠n ƒë√£ thanh to√°n"
// 4. AJAX call ƒë·∫øn /pos/manual-confirm-payment
// 5. Backend update status = "Ho√†n t·∫•t"
// 6. Redirect ƒë·∫øn trang in h√≥a ƒë∆°n
```

---

## üé® GIAO DI·ªÜN NG∆Ø·ªúI D√ôNG

### 1. Layout trang thanh to√°n QR

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¨‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ   QR CODE       ‚îÇ   CHI TI·∫æT ƒê∆†N    ‚îÇ
‚îÇ   ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê   ‚îÇ   ‚Ä¢ S·∫£n ph·∫©m A    ‚îÇ
‚îÇ   ‚îÇ  QR IMG ‚îÇ   ‚îÇ   ‚Ä¢ S·∫£n ph·∫©m B    ‚îÇ
‚îÇ   ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò   ‚îÇ   ‚Ä¢ T·ªïng: 150K    ‚îÇ
‚îÇ                 ‚îÇ                   ‚îÇ
‚îÇ   M√£: POS123    ‚îÇ   ‚è∞ COUNTDOWN     ‚îÇ
‚îÇ   S·ªë ti·ªÅn: 150K ‚îÇ   [‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà‚ñà] 15:00‚îÇ
‚îÇ                 ‚îÇ                   ‚îÇ
‚îÇ   [X√°c nh·∫≠n]    ‚îÇ   [In QR] [H·ªßy]   ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚î¥‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2. H∆∞·ªõng d·∫´n thanh to√°n

```html
<div class="qr-instructions">
  <h6><i class="fas fa-mobile-alt"></i> H∆∞·ªõng d·∫´n thanh to√°n:</h6>
  <ol>
    <li>M·ªü ·ª©ng d·ª•ng ng√¢n h√†ng tr√™n ƒëi·ªán tho·∫°i</li>
    <li>Ch·ªçn ch·ª©c nƒÉng "Qu√©t QR" ho·∫∑c "Chuy·ªÉn kho·∫£n QR"</li>
    <li>Qu√©t m√£ QR tr√™n m√†n h√¨nh</li>
    <li>X√°c nh·∫≠n th√¥ng tin v√† ho√†n t·∫•t thanh to√°n</li>
  </ol>
</div>
```

---

## üîç DEBUGGING V√Ä TROUBLESHOOTING

### 1. L·ªói th∆∞·ªùng g·∫∑p

#### QR kh√¥ng hi·ªÉn th·ªã

```java
// Check log
System.err.println("VietQR API error: HTTP " + code);
System.err.println("Kh√¥ng t√¨m th·∫•y ·∫£nh QR trong ph·∫£n h·ªìi API VietQR!");

// Ki·ªÉm tra th∆∞ m·ª•c
File directory = new File(QR_CODE_IMAGE_PATH);
if (!directory.exists()) {
    directory.mkdirs();
}
```

#### Countdown kh√¥ng ho·∫°t ƒë·ªông

```javascript
// Ki·ªÉm tra JS console
console.log("Time left:", timeLeft);
console.log("Progress:", percentage + "%");
```

### 2. Test cases

#### Test t·∫°o QR th√†nh c√¥ng

```java
// Input: orderCode="POS123", amount=150000
// Expected: QR file t·∫°i /images/qr/transfer_POS123.png
// Verify: File exists v√† valid PNG format
```

#### Test x√°c nh·∫≠n thanh to√°n

```javascript
// Input: {orderCode: "POS123"}
// Expected: {success: true, redirectUrl: "/pos/bill?orderCode=POS123"}
// Verify: Order status changed to "Ho√†n t·∫•t"
```

---

## üìä PERFORMANCE V√Ä MONITORING

### 1. Metrics c·∫ßn theo d√µi

- **QR generation time**: < 3 seconds
- **VietQR API response time**: < 2 seconds
- **Session timeout**: 15 minutes countdown
- **File size**: QR images ~ 10-50KB

### 2. Error handling

```java
try {
    String qrCodePath = qrCodeService.generateBankTransferQR(...);
    if (qrCodePath != null) {
        // Success path
    } else {
        return "redirect:/pos?error=qr_generation_failed";
    }
} catch (Exception e) {
    e.printStackTrace();
    return "redirect:/pos?error=qr_generation_failed";
}
```

---

## üîí B·∫¢O M·∫¨T V√Ä AN TO√ÄN

### 1. Validate input

```java
// Escape special characters
String safeAccountName = accountName.replace("\"", "");
String safeAddInfo = addInfo.replace("\"", "");
```

### 2. Session security

```java
// QR path ch·ªâ l∆∞u trong session, kh√¥ng expose
session.setAttribute("qrCodePath", qrCodePath);

// Validate order ownership
if (!"Ch·ªù thanh to√°n".equals(order.getStatus())) {
    return "redirect:/pos";
}
```

### 3. File cleanup

```java
// Auto cleanup QR files sau 24h (c√≥ th·ªÉ implement)
// Ho·∫∑c cleanup khi order completed
```

---

## üìù K·∫æT LU·∫¨N

H·ªá th·ªëng thanh to√°n offline VietQR ƒë∆∞·ª£c thi·∫øt k·∫ø v·ªõi:

- **T√≠nh ƒë∆°n gi·∫£n**: Nh√¢n vi√™n ch·ªâ c·∫ßn click "Thanh to√°n QR"
- **T√≠nh tin c·∫≠y**: Validate ƒë·∫ßy ƒë·ªß, error handling t·ªët
- **Tr·∫£i nghi·ªám t·ªët**: Countdown timer, h∆∞·ªõng d·∫´n r√µ r√†ng
- **T√≠nh linh ho·∫°t**: C√≥ th·ªÉ in QR, h·ªßy ƒë∆°n, x√°c nh·∫≠n th·ªß c√¥ng

### Lu·ªìng ho√†n ch·ªânh:

```
Cart ‚Üí Checkout ‚Üí Generate QR ‚Üí Display QR ‚Üí Customer Pay ‚Üí Manual Confirm ‚Üí Print Bill
```

H·ªá th·ªëng ƒë√°p ·ª©ng ƒë·∫ßy ƒë·ªß nhu c·∫ßu b√°n h√†ng offline v·ªõi kh·∫£ nƒÉng m·ªü r·ªông v√† b·∫£o tr√¨ t·ªët.
