<style>
  /* Danh s√°ch b√¨nh lu·∫≠n */
  .commentlist {
    list-style: none;
    padding: 0;
    margin: 0;
  }
  .review-item {
    border-bottom: 1px solid #eee;
    padding: 18px 0;
    display: flex;
    align-items: flex-start;
    gap: 12px;
  }
  .comment-container {
    display: flex;
    align-items: flex-start;
    gap: 14px;
  }
  .review-avatar img {
    width: 48px;
    height: 48px;
    border-radius: 50%;
    object-fit: cover;
    margin-right: 8px;
    border: 1px solid #eee;
    background: #fafafa;
  }
  .review-content {
    flex-grow: 1;
  }
  .meta {
    font-size: 14px;
    color: #666;
    margin: 2px 0 8px 0;
  }
  .review-author {
    font-weight: bolder;
    color: gray;
    font-size: 20px;

  }
  .review-date {
    color: #888;
    font-size: 12px;
    margin-left: 6px;
  }
  .review-text {
    font-size: 15px;
    color: #333;
    margin-top: 2px;
    line-height: 1.5;
  }

  /* Card th√™m ƒë√°nh gi√° */
  .card.p-4 {
    background: linear-gradient(135deg, #fdfdfd, #f5fafa);
    border-radius: 12px;
    box-shadow: 0 8px 20px rgba(0, 0, 0, 0.05);
    padding: 25px 20px !important;
  }
  .card.p-4 h4 {
    font-size: 20px;
    font-weight: bold;
    color: gray;
    margin-bottom: 18px;
  }

  /* Form ƒë√°nh gi√° */
  .form-label {
    font-weight: 500;
    color: #333;
    margin-bottom: 6px;
  }
  .form-control,
  textarea.form-control {
    border-radius: 8px !important;
    border: 1px solid #d0d7de;
    padding: 10px 14px;
    font-size: 1rem;
    background: #fafbfc;
    transition: border 0.2s;
    min-height: 80px;
  }
  .form-control:focus,
  textarea.form-control:focus {
    border-color: #009688;
    background: #fff;
    box-shadow: 0 0 0 2px #00968822;
  }

  /* Star rating */
  .star-rating-custom {
    display: flex;
    gap: 4px;
    font-size: 2rem;
    cursor: pointer;
    margin-bottom: 8px;
  }
  .star-rating-custom span {
    color: #ddd;
    transition: color 0.2s;
  }
  .star-rating-custom .selected,
  .star-rating-custom span:hover,
  .star-rating-custom span:hover ~ span {
    color: #ffc107;
  }
  .error.text-danger {
    font-size: 0.97rem;
    margin-top: 2px;
    display: block;
  }
  /* Danh s√°ch b√¨nh lu·∫≠n */
.commentlist {
  list-style: none;
  padding: 0;
  margin: 0;
}

.review-item {
  border-bottom: 1px solid #eee;
  padding: 15px 0;
  display: flex;
  align-items: flex-start;
  gap: 12px;
}

.comment-container {
  display: flex;
  flex-direction: column;
  width: 100%;
}


.review-content .meta {
  font-size: 0.9rem;
  color: #666;
  margin-bottom: 6px;
}

.review-author {
  font-weight: bold;
  color: #333;
}

.review-date {
  font-style: italic;
  color: #999;
}

.review-text {
  margin: 0;
  color: #444;
  line-height: 1.5;
}

</style>

<link
  href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
  rel="stylesheet"
/>

<!-- Font Awesome -->
<link
  rel="stylesheet"
  href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0-beta3/css/all.min.css"
/>

<!-- AOS Animate On Scroll -->
<link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet" />

<div class="container m-5">
  <h5 class="mb-4 mau">L·ªãch S·ª≠ Mua H√†ng</h5>
  <div
    class="success alert alert-success"
    th:if="${message}"
    th:text="${message}"
  ></div>
  <div class="accordion" id="orderHistory">
    <!-- L·∫∑p qua danh s√°ch ƒë∆°n h√†ng -->
    <div class="accordion-item" th:each="order, iterStat : ${orders}">
      <h2 class="accordion-header" th:id="'heading' + ${iterStat.index}">
        <button
          class="accordion-button"
          type="button"
          data-bs-toggle="collapse"
          th:attr="data-bs-target='#order' + ${iterStat.index}"
        >
          üÜî ƒê∆°n h√†ng <span th:text="${order.id}"></span> - üìÖ
          <span
            th:text="${#dates.format(order.createDate, 'dd/MM/yyyy')}"
          ></span>
          <span
            style="width: 25%"
            class="badge bg-dark ms-2 mx-3"
            th:text="${order.status}"
          ></span>
          <span
            class="fw-bold text-primary"
            th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VND'"
          >
          </span>
        </button>
      </h2>
      <div
        th:id="'order' + ${iterStat.index}"
        class="accordion-collapse collapse"
        data-bs-parent="#orderHistory"
      >
        <div class="accordion-body">
          <table class="table table-borderless">
            <thead>
              <tr>
                <th>S·∫£n ph·∫©m</th>
                <th>H√¨nh ·∫£nh</th>
                <th>S·ªë l∆∞·ª£ng</th>
                <th>ƒê∆°n gi√°</th>
                <th>Th√†nh ti·ªÅn</th>
              </tr>
            </thead>
            <tbody>
              <!-- L·∫∑p qua danh s√°ch OrderDetail trong t·ª´ng Order -->
              <tr th:each="detail : ${order.orderDetails}">
                <td th:text="${detail.product.name}"></td>
                <td>
                  <a th:href="@{/detail(id=${detail.product.id})}">
                    <img
                      th:src="@{/images/{image}(image=${detail.product.image_url})}"
                      alt=""
                      width="50px"
                      height="50px"
                      class="rounded me-2"
                    />
                  </a>
                </td>

                <td th:text="${detail.quantity}"></td>
                <td
                  th:text="${#numbers.formatDecimal(detail.price, 0, 'COMMA', 0, 'POINT')} + ' VND'"
                ></td>
                <td
                  th:text="${#numbers.formatDecimal(detail.price * detail.quantity, 0, 'COMMA', 0, 'POINT')} + ' VND'"
                ></td>
              </tr>
            </tbody>
          </table>
          <button
            class="btn btn-danger"
            th:if="${order.status == 'Ch∆∞a x√°c nh·∫≠n'}"
            onclick="confirmDelete(this)"
            th:data-url="@{/history/delete/{orderId}(orderId=${order.id})}"
          >
            H·ªßy ƒë∆°n h√†ng
          </button>

          <div th:if="${order.status == 'ƒê√£ giao'}">
            <div class="accordion-item rounded-0">
              <h2 class="accordion-header">
                <button
                  class="accordion-button collapsed rounded-0"
                  type="button"
                  data-bs-toggle="collapse"
                  data-bs-target="#collapseThree"
                >
                  ƒê√°nh gi√°
                </button>
              </h2>
              <div
                id="collapseThree"
                class="accordion-collapse collapse"
                data-bs-parent="#productAccordion"
              >
                <div class="accordion-body row">
                  <div class="col-md-7">
                    <h4 class="fw-bold mb-3">ƒê√°nh gi√° c·ªßa b·∫°n</h4>
                    <ol class="commentlist" th:each="item:${order.comments}">
                      <li class="review-item">
                        <div class="comment-container">
                         
                          <div class="review-content">
                            <p class="meta">
                               
                              <strong
                                class="review-author"
                                th:text="${item.user.name}"
                              ></strong>
                              -
                              <time
                                class="review-date"
                                th:text="${#temporals.format(item.createdAt, 'dd/MM/yyyy')}"
                              ></time>
                            </p>
                            N·ªôi dung: 
                            <p class="review-text" th:text="${item.content}">
                              T∆∞ v·∫•n nhi·ªát t√¨nh, d·ªãch v·ª• kh√° h√†i l√≤ng.
                            </p>
                          </div>
                        </div>
                      </li>
                    </ol>
                  </div>
                  <div th:if="${order.comments.size() == 0}" class="col-md-5">
                    <div class="card p-4">
                      <h4 class="fw-bold">Th√™m ƒë√°nh gi√°</h4>
                      <form th:action="@{/history/comment}" method="post">
                        <div class="star-rating">
                          
                          <!-- ƒê·ªïi id th√†nh class -->
                          <div class="star-rating-custom">
                            <span data-value="1">&#9733;</span>
                            <span data-value="2">&#9733;</span>
                            <span data-value="3">&#9733;</span>
                            <span data-value="4">&#9733;</span>
                            <span data-value="5">&#9733;</span>
                          </div>
                          <input type="hidden" name="rating" class="ratingInput" required />
                        </div>
                        <i
                          class="error text-danger"
                          th:if="${error}"
                          th:text="${error}"
                        ></i>
                        <div class="mb-3">
                          <label
                            for="comment"
                            class="form-label fw-bolder small"
                            >Nh·∫≠n x√©t c·ªßa b·∫°n
                            <span class="text-danger">*</span></label
                          >
                          <textarea
                            id="comment"
                            name="comment"
                            class="form-control"
                            rows="3"
                          ></textarea>
                          <input
                            type="hidden"
                            name="orderId"
                            th:value="${order.id}"
                          />
                        </div>
                        <div
                          class="d-flex justify-content-center"
                          th:if="${session.user}"
                        >
                          <button
                            type="submit"
                            class="btn btn-primary btn-lg px-4 py-2 fw-bold rounded-3 shadow-sm w-50 mt-3"
                            style="letter-spacing: 1px"
                          >
                            <i class="fas fa-paper-plane me-2"></i>G·ª¨I ƒêI
                          </button>
                        </div>
                        <div
                          class="d-flex justify-content-center text-danger fw-bold"
                          th:if="!${session.user}"
                        >
                          <i>(ƒêƒÉng nh·∫≠p ƒë·ªÉ b√¨nh lu·∫≠n)</i>
                        </div>
                      </form>
                    </div>
                  </div>
                </div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </div>
</div>

<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<script>
  AOS.init();

  document.addEventListener("DOMContentLoaded", function () {
      // Duy·ªát t·ª´ng form ƒë√°nh gi√°
      document.querySelectorAll('form[th\\:action="@{/history/comment}"], form[action="/history/comment"]').forEach(function (reviewForm) {
        const stars = reviewForm.querySelectorAll(".star-rating-custom span");
        const ratingInput = reviewForm.querySelector(".ratingInput");
        let selected = 0;

        reviewForm.addEventListener("submit", function (e) {
          if (
            !ratingInput.value ||
            isNaN(ratingInput.value) ||
            ratingInput.value < 1 ||
            ratingInput.value > 5
          ) {
            e.preventDefault();
            alert("Vui l√≤ng ch·ªçn s·ªë sao ƒë√°nh gi√°!");
            return false;
          }
        });

        stars.forEach((star, idx) => {
          star.addEventListener("mouseenter", function () {
            stars.forEach((s, i) => {
              s.style.color = i <= idx ? "#ffc107" : "#ddd";
            });
          });
          star.addEventListener("mouseleave", function () {
            stars.forEach((s, i) => {
              s.style.color = i < selected ? "#ffc107" : "#ddd";
            });
          });
          star.addEventListener("click", function () {
            selected = idx + 1;
            ratingInput.value = selected;
            stars.forEach((s, i) => {
              s.style.color = i < selected ? "#ffc107" : "#ddd";
            });
          });
        });
      });
    });
</script>
