<!-- file: service-management.html -->
<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <meta charset="UTF-8" />
    <title>Quản Lý Dịch Vụ</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />
  </head>
  <body class="p-4">
    <!-- Tabs -->
    <ul class="nav nav-tabs" id="serviceTab" role="tablist">
      <li class="nav-item">
        <button
          class="nav-link active"
          id="tab-requests"
          data-bs-toggle="tab"
          data-bs-target="#requests"
          type="button"
        >
          Yêu Cầu Dịch Vụ
        </button>
      </li>
      <li class="nav-item">
        <button
          class="nav-link"
          id="tab-orders"
          data-bs-toggle="tab"
          data-bs-target="#orders"
          type="button"
        >
          Đơn Hàng Dịch Vụ
        </button>
      </li>
    </ul>

    <div class="tab-content mt-3">
      <!-- YÊU CẦU DỊCH VỤ -->
      <div class="tab-pane fade show active" id="requests" role="tabpanel">
        <form class="row g-3 mb-3">
          <!-- Bộ lọc nếu cần -->
        </form>

        <table class="table table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th>Tên KH</th>
              <th>Email</th>
              <th>SĐT</th>
              <th>Dịch vụ</th>
              <th>Ngày tạo</th>
              <th>Trạng thái</th>
              <th>Thao tác</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="request : ${requests}">
              <td th:text="${request.fullName}"></td>
              <td th:text="${request.email}"></td>
              <td th:text="${request.phone}"></td>
              <td th:text="${request.service.name}"></td>
              <td
                th:text="${#temporals.format(request.createdAt, 'dd/MM/yyyy HH:mm')}"
              >
                23/07/2025
              </td>
              <td>
                <span
                  th:class="'badge bg-' + 
                             (request.status == 'PENDING' ? 'warning text-dark' : 
                             (request.status == 'CONTACTED' ? 'primary' : 
                             (request.status == 'CONFIRMED' ? 'success' : 'secondary')))"
                  th:text="${request.status}"
                >
                </span>
              </td>
              <td>
                <button
                  class="btn btn-sm btn-outline-primary"
                  data-bs-toggle="modal"
                  data-bs-target="#quoteModal"
                  th:attr="data-id=${request.id}"
                >
                  Liên hệ
                </button>
                <a
                  th:href="@{'/admin/orders/create?requestId=' + ${request.id}}"
                  class="btn btn-sm btn-success"
                  >Tạo đơn</a
                >
                <form
                  th:action="@{'/admin/service-requests/' + ${request.id} + '/cancel'}"
                  method="post"
                  style="display: inline"
                >
                  <button
                    type="submit"
                    class="btn btn-sm btn-outline-danger"
                    onclick="return confirm('Bạn có chắc muốn huỷ yêu cầu này?')"
                  >
                    Huỷ
                  </button>
                </form>
              </td>
            </tr>
          </tbody>
        </table>
      </div>

      <!-- ĐƠN HÀNG DỊCH VỤ -->
      <div class="tab-pane fade" id="orders" role="tabpanel">
        <table class="table table-bordered align-middle">
          <thead class="table-light">
            <tr>
              <th>Mã đơn</th>
              <th>Tên KH</th>
              <th>Dịch vụ</th>
              <th>Giá</th>
              <th>Ngày xác nhận</th>
              <th>Trạng thái</th>
              <th>Thanh toán</th>
              <th>Thao tác</th>
            </tr>
          </thead>
          <tbody>
            <tr th:each="order : ${orders}">
              <td th:text="${order.code}"></td>
              <td th:text="${order.fullName}"></td>
              <td th:text="${order.service.name}"></td>
              <td
                th:text="${#numbers.formatDecimal(order.totalPrice, 0, 'POINT')} + ' đ'"
              ></td>
              <td
                th:text="${#temporals.format(request.createdAt, 'dd/MM/yyyy')}"
              ></td>
              <td>
                <span class="badge bg-info" th:text="${order.status}"></span>
              </td>
              <td>
                <span
                  th:class="'badge ' + (${order.paid} ? 'bg-success' : 'bg-danger')"
                  th:text="${order.paid ? 'Đã thanh toán' : 'Chưa thanh toán'}"
                ></span>
              </td>
              <td>
                <a
                  th:href="@{'/admin/orders/complete/' + ${order.id}}"
                  class="btn btn-sm btn-outline-success"
                  >Hoàn tất</a
                >
                <a
                  th:href="@{'/admin/orders/confirm-payment/' + ${order.id}}"
                  class="btn btn-sm btn-outline-primary"
                  >Xác nhận thanh toán</a
                >
                <a
                  th:href="@{'/admin/orders/cancel/' + ${order.id}}"
                  class="btn btn-sm btn-outline-danger"
                  >Huỷ</a
                >
              </td>
            </tr>
          </tbody>
        </table>
      </div>
    </div>

    <!-- Modal báo giá -->
    <div class="modal fade" id="quoteModal" tabindex="-1">
      <div class="modal-dialog">
        <form id="quoteForm" method="post" class="modal-content">
          <div class="modal-header">
            <h5 class="modal-title">Nhập báo giá</h5>
            <button
              type="button"
              class="btn-close"
              data-bs-dismiss="modal"
            ></button>
          </div>
          <div class="modal-body">
            <label class="form-label">Giá đề xuất (VNĐ)</label>
            <input
              type="number"
              class="form-control"
              name="quotedPrice"
              required
            />
          </div>
          <div class="modal-footer">
            <button type="submit" class="btn btn-primary">
              Xác nhận báo giá
            </button>
          </div>
        </form>
      </div>
    </div>

    <script>
      const quoteModal = document.getElementById("quoteModal");
      quoteModal.addEventListener("show.bs.modal", function (event) {
        const button = event.relatedTarget;
        const requestId = button.getAttribute("data-id");
        const form = document.getElementById("quoteForm");

        // Cập nhật form action theo request ID
        form.setAttribute(
          "action",
          `/admin/service-requests/${requestId}/contact`
        );
      });
    </script>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>
  </body>
</html>
