<!DOCTYPE html>
<html lang="vi">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Trang Thống Kê</title>
    <link
      href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css"
      rel="stylesheet"
    />

    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <!-- Style css -->
    <link rel="stylesheet" th:href="@{/css/statistical.css}" />
    <link
      rel="stylesheet"
      href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.3/font/bootstrap-icons.min.css"
    />
  </head>
  <body>
    <h4>Thống kê cửa hàng</h4>
    <hr />
    <div
      class="success alert alert-success"
      th:if="${success}"
      th:text="${success}"
    ></div>

    <!-- Tab Navigation -->
    <div class="filter-section p-2">
      <div class="filter-container">
        <div class="filter-group">
          <label for="yearSelect" class="filter-label"> Năm </label>
          <select id="yearSelect" class="filter-select">
            <option value="2024" th:selected="${selectedYear == 2024}">
              2024
            </option>
            <option value="2025" th:selected="${selectedYear == 2025}">
              2025
            </option>
          </select>
        </div>
        <div class="filter-group">
          <label for="monthSelect" class="filter-label"> Tháng </label>
          <select id="monthSelect" class="filter-select">
            <option value="1" th:selected="${selectedMonth == 1}">
              Tháng 1
            </option>
            <option value="2" th:selected="${selectedMonth == 2}">
              Tháng 2
            </option>
            <option value="3" th:selected="${selectedMonth == 3}">
              Tháng 3
            </option>
            <option value="4" th:selected="${selectedMonth == 4}">
              Tháng 4
            </option>
            <option value="5" th:selected="${selectedMonth == 5}">
              Tháng 5
            </option>
            <option value="6" th:selected="${selectedMonth == 6}">
              Tháng 6
            </option>
            <option value="7" th:selected="${selectedMonth == 7}">
              Tháng 7
            </option>
            <option value="8" th:selected="${selectedMonth == 8}">
              Tháng 8
            </option>
            <option value="9" th:selected="${selectedMonth == 9}">
              Tháng 9
            </option>
            <option value="10" th:selected="${selectedMonth == 10}">
              Tháng 10
            </option>
            <option value="11" th:selected="${selectedMonth == 11}">
              Tháng 11
            </option>
            <option value="12" th:selected="${selectedMonth == 12}">
              Tháng 12
            </option>
          </select>
        </div>
      </div>
    </div>
    <ul class="nav nav-tabs border-bottom-0" id="UserTab" role="tablist">
      <li class="nav-item" role="presentation">
        <button
          class="nav-link active fw-medium text-dark px-4 py-2"
          id="edit-tab"
          data-bs-toggle="tab"
          data-bs-target="#edit"
          type="button"
          role="tab"
          aria-controls="edit"
          aria-selected="true"
          style="font-size: 16px; transition: all 0.2s ease-in-out"
        >
          Thống kê trong tháng
        </button>
      </li>
      <li class="nav-item" role="presentation">
        <button
          class="nav-link fw-medium text-dark px-4 py-2"
          id="list-tab"
          data-bs-toggle="tab"
          data-bs-target="#list"
          type="button"
          role="tab"
          aria-controls="list"
          aria-selected="false"
          style="font-size: 16px; transition: all 0.2s ease-in-out"
        >
          Thống kê trong năm
        </button>
      </li>
    </ul>

    <script>
      document
        .getElementById("monthSelect")
        .addEventListener("change", redirectToStatistical);
      document
        .getElementById("yearSelect")
        .addEventListener("change", redirectToStatistical);

      function redirectToStatistical() {
        const month = document.getElementById("monthSelect").value;
        const year = document.getElementById("yearSelect").value;
        window.location.href = `/statistical?month=${month}&year=${year}`;
      }
    </script>

    <!-- Tab Content -->
    <!-- Tab Content -->
    <div class="tab-content" id="UserTabContent">
      <i class="error" th:if="${error}" th:text="${error}"></i>

      <!-- Tab: tháng -->
      <div
        class="tab-pane fade show active"
        id="edit"
        role="tabpanel"
        aria-labelledby="edit-tab"
      >
        <!--   4 thẻ tháng-->
        <!-- 4 thẻ thống kê tháng -->
        <div class="statistics-dashboard">
          <div class="stats-grid">
            <!-- Tổng doanh thu tháng -->
            <div class="stat-card revenue">
              <div class="stat-content">
                <div class="stat-icon">
                  <i class="bi bi-cash-stack"></i>
                </div>
                <div class="stat-info">
                  <div
                    class="stat-value revenue-value"
                    id="monthlyRevenue"
                    th:text="${#numbers.formatDecimal(monthlyRevenue, 0, 'COMMA', 0, 'POINT')} + ' đ'"
                  >
                    0 đ
                  </div>
                  <div class="stat-label">Tổng doanh thu</div>
                </div>
              </div>
            </div>

            <!-- Đơn dịch vụ tháng -->
            <div class="stat-card services">
              <div class="stat-content">
                <div class="stat-icon">
                  <i class="bi bi-gift"></i>
                </div>
                <div class="stat-info">
                  <div
                    class="stat-value"
                    id="totalOrdersByMonth"
                    th:text="${totalOrdersByMonth}"
                  >
                    0
                  </div>
                  <div class="stat-label">Đơn dịch vụ</div>
                </div>
              </div>
            </div>

            <!-- Đơn đặt hàng tháng -->
            <div class="stat-card sales">
              <div class="stat-content">
                <div class="stat-icon">
                  <i class="bi bi-bag"></i>
                </div>
                <div class="stat-info">
                  <div
                    class="stat-value"
                    id="totalOrders"
                    th:text="${totalOrders}"
                  >
                    0
                  </div>
                  <div class="stat-label">Tổng đơn đặt hàng</div>
                </div>
              </div>
            </div>
            <!-- Đơn giao thành công tháng -->
            <div class="stat-card orders">
              <div class="stat-content">
                <div class="stat-icon">
                  <i class="bi bi-check2-circle"></i>
                </div>
                <div class="stat-info">
                  <div
                    class="stat-value"
                    id="canceledOrders"
                    th:text="${canceledOrders}"
                  >
                    0
                  </div>

                  <div class="stat-label">Đơn hàng hoàn tất</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Biểu đồ doanh thu theo ngày trong tháng -->
        <div class="container">
          <div class="row">
            <div class="col-md-8 mb-4">
              <div class="chart-card">
                <h5 class="text-center">Xu hướng doanh số</h5>

                <canvas
                  style="width: 100%; height: 430px; position: relative"
                  id="dailyRevenueChart"
                ></canvas>
              </div>
            </div>
            <div class="col-md-4 mb-4">
              <div class="chart-card">
                <h5 class="text-center">Top Danh mục bán chạy</h5>
                <div
                  style="
                    max-width: 300px;
                    margin: 0 auto;
                    height: 300px;
                    position: relative;
                  "
                >
                  <canvas id="topProductsByMonthChart"></canvas>
                </div>
                <div id="customLegendByMonth" class="legend-grid mt-3"></div>
              </div>
            </div>
          </div>
        </div>
      </div>

      <!-- Tab: Danh sách -->
      <div
        class="tab-pane fade"
        id="list"
        role="tabpanel"
        aria-labelledby="list-tab"
      >
        <!-- // 4 thẻ năm -->

        <!-- 4 thẻ thống kê năm -->
        <div class="statistics-dashboard">
          <div class="stats-grid">
            <!-- Tổng doanh thu năm -->
            <div class="stat-card revenue">
              <div class="stat-content">
                <div class="stat-icon">
                  <i class="bi bi-cash-stack"></i>
                </div>
                <div class="stat-info">
                  <div
                    class="stat-value revenue-value"
                    id="totalRevenue"
                    th:text="${#numbers.formatDecimal(totalRevenue, 0, 'COMMA', 0, 'POINT')} + ' đ'"
                  >
                    0 đ
                  </div>
                  <div class="stat-label">Tổng doanh thu</div>
                </div>
              </div>
            </div>

            <!-- Đơn dịch vụ năm -->
            <div class="stat-card services">
              <div class="stat-content">
                <div class="stat-icon">
                  <i class="bi bi-gift"></i>
                </div>
                <div class="stat-info">
                  <div
                    class="stat-value"
                    id="totalOrdersInYear1"
                    th:text="${totalOrdersInYear1}"
                  >
                    0
                  </div>
                  <div class="stat-label">Đơn dịch vụ</div>
                </div>
              </div>
            </div>

            <!-- Đơn đặt hàng năm -->
            <div class="stat-card sales">
              <div class="stat-content">
                <div class="stat-icon">
                  <i class="bi bi-bag"></i>
                </div>
                <div class="stat-info">
                  <div
                    class="stat-value"
                    id="totalOrdersInYear"
                    th:text="${totalOrdersInYear}"
                  >
                    0
                  </div>
                  <div class="stat-label">Đơn đặt hàng</div>
                </div>
              </div>
            </div>
            <!-- Đơn giao thành công năm -->
            <div class="stat-card orders">
              <div class="stat-content">
                <div class="stat-icon">
                  <i class="bi bi-check2-circle"></i>
                </div>
                <div class="stat-info">
                  <div
                    class="stat-value"
                    id="deliveredOrdersInYear"
                    th:text="${deliveredOrdersInYear}"
                  >
                    0
                  </div>
                  <div class="stat-label">Đơn hàng hoàn tất</div>
                </div>
              </div>
            </div>
          </div>
        </div>

        <!-- Biểu đồ xu hướng doanh số và danh mục -->
        <div class="container">
          <div class="row">
            <div class="col-md-8 mb-4">
              <div class="chart-card">
                <h5 class="text-center">Xu hướng doanh số</h5>
                <canvas
                  style="width: 100%; height: 173px; position: relative"
                  id="lineChart"
                ></canvas>
              </div>
            </div>
            <div class="col-md-4 mb-4">
              <div class="chart-card">
                <h5 class="text-center">Top danh mục bán chạy</h5>
                <div
                  style="
                    max-width: 300px;
                    margin: 0 auto;
                    height: 300px;
                    position: relative;
                  "
                >
                  <canvas id="topProductsChart"></canvas>
                </div>
                <div id="customLegend" class="legend-grid mt-3"></div>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
  </body>

  <!-- Script xử lý biểu đồ -->
  <script th:inline="javascript">
    // Biểu đồ doanh thu theo tháng
    const lineChart = new Chart(document.getElementById("lineChart"), {
      type: "line",
      data: {
        labels: [
          "Tháng 1",
          "Tháng 2",
          "Tháng 3",
          "Tháng 4",
          "Tháng 5",
          "Tháng 6",
          "Tháng 7",
          "Tháng 8",
          "Tháng 9",
          "Tháng 10",
          "Tháng 11",
          "Tháng 12",
        ],
        datasets: [
          {
            label: "Doanh thu",
            data: Array(12).fill(0),
            borderColor: "#FF6B6B",
            backgroundColor: "rgba(255, 107, 107, 0.2)",
            fill: true,
            tension: 0.4,
          },
        ],
      },
      options: {
        responsive: true,
        plugins: {
          legend: {
            position: "bottom",
            labels: { font: { size: 12 }, color: "#333" },
          },
        },
        scales: {
          y: {
            beginAtZero: true,
            title: {
              display: true,
              text: "Triệu VNĐ",
              font: { size: 12 },
              color: "#333",
            },
            ticks: { font: { size: 12 }, color: "#333" },
          },
          x: {
            ticks: { font: { size: 12 }, color: "#333" },
          },
        },
      },
    });

    function fetchRevenueData(year) {
      fetch(`/api/revenue-by-month?year=${year}`)
        .then((response) => response.json())
        .then((data) => {
          const revenueData = Array(12).fill(0);
          Object.keys(data).forEach((month) => {
            revenueData[parseInt(month) - 1] = data[month] / 1_000_000; // Chia cho 1 triệu để hiển thị đơn vị Triệu VNĐ
          });

          lineChart.data.datasets[0].data = revenueData;
          lineChart.update();
        })
        .catch((error) =>
          console.error("Lỗi khi lấy dữ liệu doanh thu:", error)
        );
    }

    // Biểu đồ doanh thu theo ngày
    const dailyRevenueChart = new Chart(
      document.getElementById("dailyRevenueChart"),
      {
        type: "line",
        data: {
          labels: Array.from({ length: 31 }, (_, i) => `Ngày ${i + 1}`),
          datasets: [
            {
              label: "Doanh thu",
              data: Array(31).fill(0),
              borderColor: "#36A2EB",
              backgroundColor: "rgba(54, 162, 235, 0.2)",
              fill: true,
              tension: 0.4,
            },
          ],
        },
        options: {
          responsive: true,
          plugins: {
            legend: {
              position: "bottom",
              labels: { font: { size: 12 }, color: "#333" },
            },
          },
          scales: {
            y: {
              beginAtZero: true,
              title: {
                display: true,
                text: "Triệu VNĐ",
                font: { size: 12 },
                color: "#333",
              },
              ticks: { font: { size: 12 }, color: "#333" },
            },
            x: {
              ticks: { font: { size: 12 }, color: "#333" },
            },
          },
        },
      }
    );

    function fetchDailyRevenueData(month, year) {
      fetch(`/api/revenue-by-day?month=${month}&year=${year}`)
        .then((response) => response.json())
        .then((data) => {
          const revenueData = Array(31).fill(0);
          Object.keys(data).forEach((day) => {
            revenueData[parseInt(day) - 1] = data[day] / 1_000_000; // Chia cho 1 triệu để hiển thị đơn vị Triệu VNĐ
          });

          const daysInMonth = new Date(year, month, 0).getDate();
          dailyRevenueChart.data.labels = Array.from(
            { length: daysInMonth },
            (_, i) => `Ngày ${i + 1}`
          );
          dailyRevenueChart.data.datasets[0].data = revenueData.slice(
            0,
            daysInMonth
          );
          dailyRevenueChart.update();
        })
        .catch((error) =>
          console.error("Lỗi khi lấy dữ liệu doanh thu theo ngày:", error)
        );
    }

    // Khởi tạo biểu đồ với năm và tháng mặc định
    const defaultYear = /*[[${selectedYear}]]*/ 2025;
    const defaultMonth = /*[[${selectedMonth}]]*/ 8;
    fetchRevenueData(defaultYear);
    fetchTopProducts(defaultYear);
    fetchDailyRevenueData(defaultMonth, defaultYear);
    fetchTopProductsByMonth(defaultMonth, defaultYear); // Thêm để tải dữ liệu top danh mục theo tháng

    // Thay đổi event listeners cho monthSelect và yearSelect
    document
      .getElementById("monthSelect")
      .addEventListener("change", function () {
        const month = this.value;
        const year = document.getElementById("yearSelect").value;
        fetchDailyRevenueData(month, year);
        fetchTopProductsByMonth(month, year);
        window.location.href = `/statistical?month=${month}&year=${year}`; // Di chuyển redirect xuống cuối
      });

    document
      .getElementById("yearSelect")
      .addEventListener("change", function () {
        const year = this.value;
        const month = document.getElementById("monthSelect").value;
        fetchRevenueData(year);
        fetchTopProducts(year);
        fetchDailyRevenueData(month, year);
        fetchTopProductsByMonth(month, year);
        window.location.href = `/statistical?month=${month}&year=${year}`; // Di chuyển redirect xuống cuối
      });

    // Xóa hàm redirectToStatistical() vì không cần thiết nữa

    const pieCtx = document.getElementById("topProductsChart").getContext("2d");
    let pieChart;

    function fetchTopProducts(year) {
      fetch(`/api/top-products?year=${year}`)
        .then((res) => res.json())
        .then((data) => {
          console.log(`Dữ liệu top danh mục năm ${year}:`, data); // Log để debug
          const labels =
            data.length > 0
              ? data.map((item) => item.name || "Không tên")
              : ["Không có dữ liệu"];
          const values =
            data.length > 0
              ? data.map((item) => item.total_quantity_sold || 0)
              : [1]; // Giá trị [1] để hiển thị phần xám
          const colors =
            data.length > 0
              ? [
                  "#FF6384",
                  "#36A2EB",
                  "#FFCE56",
                  "#4BC0C0",
                  "#9966FF",
                  "#FF9F40",
                ]
              : ["#cccccc"]; // Màu xám khi không có dữ liệu

          if (pieChart) {
            pieChart.data.labels = labels;
            pieChart.data.datasets[0].data = values;
            pieChart.data.datasets[0].backgroundColor = colors;
            pieChart.update();
          } else {
            pieChart = new Chart(pieCtx, {
              type: "pie",
              data: {
                labels: labels,
                datasets: [
                  {
                    data: values,
                    backgroundColor: colors,
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false, // Ẩn legend mặc định
                  },
                  tooltip: {
                    enabled: data.length > 0, // Vô hiệu hóa tooltip nếu không có dữ liệu
                  },
                },
                layout: {
                  padding: 20,
                },
              },
            });
          }

          // Tạo custom legend
          const legendContainer = document.getElementById("customLegend");
          legendContainer.innerHTML = ""; // Xóa legend cũ

          labels.forEach((label, index) => {
            const color = colors[index % colors.length];
            const div = document.createElement("div");
            div.className = "legend-item";
            div.innerHTML = `
                    <div class="legend-color-box" style="background-color:${color}"></div>
                    <span>${label}</span>
                `;
            legendContainer.appendChild(div);
          });
        })
        .catch((err) => console.error("Lỗi lấy top sản phẩm:", err));
    }

    const pieCtxByMonth = document
      .getElementById("topProductsByMonthChart")
      .getContext("2d");
    let pieChartByMonth;

    function fetchTopProductsByMonth(month, year) {
      fetch(`/api/top-productsMonth?month=${month}&year=${year}`)
        .then((res) => res.json())
        .then((data) => {
          console.log(`Dữ liệu top danh mục tháng ${month}/${year}:`, data); // Log để debug
          const labels =
            data.length > 0
              ? data.map((item) => item.name || "Không tên")
              : ["Không có dữ liệu"];
          const values =
            data.length > 0
              ? data.map((item) => item.total_quantity_sold || 0)
              : [1];
          const colors =
            data.length > 0
              ? [
                  "#FF6384",
                  "#36A2EB",
                  "#FFCE56",
                  "#4BC0C0",
                  "#9966FF",
                  "#FF9F40",
                ]
              : ["#cccccc"];

          if (pieChartByMonth) {
            pieChartByMonth.data.labels = labels;
            pieChartByMonth.data.datasets[0].data = values;
            pieChartByMonth.data.datasets[0].backgroundColor = colors;
            pieChartByMonth.update();
          } else {
            pieChartByMonth = new Chart(pieCtxByMonth, {
              type: "pie",
              data: {
                labels: labels,
                datasets: [
                  {
                    data: values,
                    backgroundColor: colors,
                    borderWidth: 1,
                  },
                ],
              },
              options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                  legend: {
                    display: false, // Ẩn legend mặc định
                  },
                  tooltip: {
                    enabled: data.length > 0, // Vô hiệu hóa tooltip nếu không có dữ liệu
                  },
                },
                layout: {
                  padding: 20,
                },
              },
            });
          }

          // Tạo custom legend
          const legendContainerByMonth = document.getElementById(
            "customLegendByMonth"
          );
          legendContainerByMonth.innerHTML = ""; // Xóa legend cũ

          labels.forEach((label, index) => {
            const color = colors[index % colors.length];
            const div = document.createElement("div");
            div.className = "legend-item";
            div.innerHTML = `
                        <div class="legend-color-box" style="background-color:${color}"></div>
                        <span>${label}</span>
                    `;
            legendContainerByMonth.appendChild(div);
          });
        })
        .catch((err) => console.error("Lỗi lấy top sản phẩm theo tháng:", err));
    }
  </script>
</html>
