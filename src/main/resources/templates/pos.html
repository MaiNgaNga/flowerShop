<link rel="stylesheet" th:href="@{/css/pos.css}" th:if="${view == 'pos'}" />
<link
  rel="stylesheet"
  href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css"
/>
<div class="pos-center">
  <div class="pos-flex">
    <div class="pos-left">
      <div class="pos-category">
        <h3>Lọc sản phẩm</h3>
        <form method="get" th:action="@{/pos}" id="filterForm">
          <div class="mb-2">
            <input
              type="text"
              name="keyword"
              class="form-control"
              placeholder="Tìm kiếm sản phẩm..."
              th:value="${keyword}"
              autocomplete="off"
              id="filterKeyword"
            />
          </div>
          <div class="mb-2">
            <label>Màu sắc:</label>
            <select
              name="color"
              class="form-select"
              onchange="this.form.submit()"
            >
              <option value="" th:selected="${color == null or color == ''}">
                Tất cả
              </option>
              <option
                th:each="c : ${colors}"
                th:value="${c.name}"
                th:text="${c.name}"
                th:selected="${color == c.name}"
              ></option>
            </select>
          </div>
          <div class="mb-2">
            <label>Loại hoa:</label>
            <select
              name="type"
              class="form-select"
              onchange="this.form.submit()"
            >
              <option value="" th:selected="${type == null or type == ''}">
                Tất cả
              </option>
              <option
                th:each="cat : ${productCategories}"
                th:value="${cat.name}"
                th:text="${cat.name}"
                th:selected="${type == cat.name}"
              ></option>
            </select>
          </div>
          <div class="mb-2">
            <label>Loại hoa:</label>
            <select
              name="category"
              class="form-select"
              onchange="this.form.submit()"
            >
              <option
                value=""
                th:selected="${category == null or category == ''}"
              >
                Tất cả
              </option>
              <option
                th:each="cat : ${categories}"
                th:value="${cat.name}"
                th:text="${cat.name}"
                th:selected="${category == cat.name}"
              ></option>
            </select>
          </div>
          <div class="mb-2" style="text-align: right">
            <button
              type="button"
              class="btn btn-secondary"
              style="
                padding: 6px 18px;
                border-radius: 8px;
                background: linear-gradient(135deg, #d4a5e6, #b2e0e0);
                color: #fff;
                border: none;
                font-weight: 600;
              "
              onclick="resetFilterForm()"
            >
              Làm mới
            </button>
          </div>
        </form>
      </div>
      <div class="pos-product-list">
        <div
          th:if="${#lists.isEmpty(products)}"
          style="
            display: flex;
            justify-content: center;
            align-items: center;
            min-height: 300px;
          "
        >
          <span style="font-size: 22px; color: #888; text-align: center"
            >Không tìm thấy sản phẩm nào</span
          >
        </div>
        <div class="pos-product-grid">
          <div th:each="product : ${products}" class="pos-card">
            <div style="position: relative">
              <img
                th:if="${product.image_url != null and !#strings.isEmpty(product.image_url)}"
                th:src="@{'/images/' + ${product.image_url}}"
                th:alt="${product.name}"
                class="pos-card-img"
              />
              <img
                th:unless="${product.image_url != null and !#strings.isEmpty(product.image_url)}"
                th:src="@{'/images/no-image.png'}"
                th:alt="No image"
                class="pos-card-img"
              />
              <span
                th:if="${product.isDiscountActive()}"
                class="promo-tag"
                style="
                  position: absolute;
                  top: 5px;
                  left: 5px;
                  background: #e53935;
                  color: #fff;
                  padding: 2px 8px;
                  border-radius: 6px;
                  font-size: 13px;
                  z-index: 2;
                "
              >
                -<span th:text="${product.discountPercent}"></span>%
              </span>
            </div>
            <div class="pos-card-title" th:text="${product.name}"></div>
            <div
              class="pos-card-price"
              style="
                display: flex;
                flex-direction: column;
                align-items: flex-start;
              "
              th:if="${product.discountPercent != null && product.discountPercent > 0 && product.discountStart != null && product.discountEnd != null && !T(java.time.LocalDate).now().isBefore(product.discountStart) && !T(java.time.LocalDate).now().isAfter(product.discountEnd)}"
            >
              <span
                style="color: #e53935; font-weight: bold"
                th:text="${#numbers.formatDecimal(product.priceAfterDiscount, 0, 'COMMA', 0, 'POINT')} + ' VND'"
              ></span>
              <span
                style="
                  text-decoration: line-through;
                  color: #888;
                  font-size: 13px;
                  margin-left: 6px;
                "
                th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + ' VND'"
              ></span>
            </div>
            <div
              class="pos-card-price"
              th:unless="${product.discountPercent != null && product.discountPercent > 0 && product.discountStart != null && product.discountEnd != null && !T(java.time.LocalDate).now().isBefore(product.discountStart) && !T(java.time.LocalDate).now().isAfter(product.discountEnd)}"
              th:text="${#numbers.formatDecimal(product.price, 0, 'COMMA', 0, 'POINT')} + ' VND'"
            ></div>
            <button
              class="pos-card-btn"
              type="button"
              th:attr="data-id=${product.id}"
              onclick="addToCart(this)"
            >
              Chọn
            </button>
          </div>
        </div>
        <div
          class="d-flex justify-content-center mt-5"
          th:if="${totalPages > 0}"
        >
          <nav>
            <ul class="pagination custom-pagination">
              <li
                class="page-item"
                th:classappend="${currentPage == 0} ? 'disabled'"
              >
                <a
                  class="page-link"
                  th:href="@{/pos(page=0, color=${color}, type=${type}, category=${category}, keyword=${keyword}, minPrice=${minPrice}, maxPrice=${maxPrice})}"
                  ><i class="fa fa-angle-double-left"></i
                ></a>
              </li>
              <li
                class="page-item"
                th:classappend="${currentPage == 0} ? 'disabled'"
              >
                <a
                  class="page-link"
                  th:href="@{/pos(page=${currentPage - 1}, color=${color}, type=${type}, category=${category}, keyword=${keyword}, minPrice=${minPrice}, maxPrice=${maxPrice})}"
                  ><i class="fa fa-angle-left"></i
                ></a>
              </li>
              <!-- Trang đầu -->
              <li class="page-item" th:if="${currentPage > 2}">
                <a
                  class="page-link"
                  th:href="@{/pos(page=0, color=${color}, type=${type}, category=${category}, keyword=${keyword}, minPrice=${minPrice}, maxPrice=${maxPrice})}"
                  >1</a
                >
              </li>
              <li class="page-item disabled" th:if="${currentPage > 3}">
                <span class="page-link">...</span>
              </li>
              <!-- Các trang lân cận -->
              <li
                class="page-item"
                th:each="i : ${#numbers.sequence(currentPage-2 > 0 ? currentPage-2 : 0, currentPage+2 < totalPages-1 ? currentPage+2 : totalPages-1)}"
                th:classappend="${currentPage == i} ? 'active'"
              >
                <a
                  class="page-link"
                  th:href="@{/pos(page=${i}, color=${color}, type=${type}, category=${category}, keyword=${keyword}, minPrice=${minPrice}, maxPrice=${maxPrice})}"
                  th:text="${i+1}"
                ></a>
              </li>
              <!-- Trang cuối -->
              <li
                class="page-item disabled"
                th:if="${currentPage < totalPages-4}"
              >
                <span class="page-link">...</span>
              </li>
              <li class="page-item" th:if="${currentPage < totalPages-3}">
                <a
                  class="page-link"
                  th:href="@{/pos(page=${totalPages-1}, color=${color}, type=${type}, category=${category}, keyword=${keyword}, minPrice=${minPrice}, maxPrice=${maxPrice})}"
                  th:text="${totalPages}"
                ></a>
              </li>
              <li
                class="page-item"
                th:classappend="${currentPage + 1 == totalPages} ? 'disabled'"
              >
                <a
                  class="page-link"
                  th:href="@{/pos(page=${currentPage + 1}, color=${color}, type=${type}, category=${category}, keyword=${keyword}, minPrice=${minPrice}, maxPrice=${maxPrice})}"
                  ><i class="fa fa-angle-right"></i
                ></a>
              </li>
              <li
                class="page-item"
                th:classappend="${currentPage + 1 == totalPages} ? 'disabled'"
              >
                <a
                  class="page-link"
                  th:href="@{/pos(page=${totalPages - 1}, color=${color}, type=${type}, category=${category}, keyword=${keyword}, minPrice=${minPrice}, maxPrice=${maxPrice})}"
                  ><i class="fa fa-angle-double-right"></i
                ></a>
              </li>
            </ul>
          </nav>
        </div>
      </div>
    </div>
    <div class="pos-right">
      <h2 class="mb-3">Đơn hàng</h2>
      <form id="posForm" th:action="@{/pos/checkout}" method="post">
        <div class="mb-3">
          <label class="form-label">Sản phẩm đã chọn</label>
          <table class="table table-bordered pos-cart-table" id="cartTable">
            <thead>
              <tr>
                <th>Sản phẩm</th>
                <th>Số lượng</th>
                <th>Thành tiền</th>
                <th></th>
              </tr>
            </thead>
            <tbody id="cartRows"></tbody>
          </table>
        </div>
        <div class="mb-3">
          <label class="form-label">Tổng tiền:</label>
          <span id="totalAmount">0</span> VND
        </div>
        <div class="mb-3">
          <label class="form-label">Phương thức thanh toán</label>
          <select
            name="paymentMethod"
            class="form-control"
            id="paymentMethodSelect"
          >
            <option value="cash">💵 Tiền mặt (thanh toán ngay)</option>
            <option value="qr_code">🏦 Chuyển khoản QR (cần xác nhận)</option>
          </select>
          <small class="form-text text-muted">
            <span id="paymentNote"
              >Thanh toán tiền mặt sẽ hoàn tất đơn hàng ngay lập tức.</span
            >
          </small>
        </div>
        <input type="hidden" name="orderType" value="offline" />
        <button type="submit" class="btn btn-success w-100">
          Xác nhận bán hàng
        </button>
      </form>
    </div>
  </div>
</div>
<style>
  .custom-pagination .page-link {
    margin: 0 10px;
    color: #333 !important;
    border: 1.5px solid #d4a5e6 !important;
    background-color: #fff !important;
    border-radius: 50% !important;
    transition: all 0.2s ease-in-out;
    width: 36px;
    height: 36px;
    display: flex;
    align-items: center;
    justify-content: center;
    font-size: 14px;
    font-weight: 500;
    box-shadow: none !important;
    outline: none !important;
    padding: 0;
  }
  .custom-pagination .page-item.active .page-link {
    background-color: #d4a5e6 !important;
    color: #fff !important;
    border-color: #d4a5e6 !important;
  }
  .custom-pagination .page-item.disabled .page-link {
    opacity: 0.5;
    cursor: not-allowed;
    background: #fff !important;
    color: #bbb !important;
    border-color: #d4a5e6 !important;
  }
  .custom-pagination .page-link:hover {
    background: #e0f7f7 !important;
    color: #333 !important;
    border-color: #d4a5e6 !important;
    transform: scale(1.1);
    box-shadow: 0 4px 10px rgba(212, 165, 230, 0.3);
  }
</style>
<script src="/js/pos.js"></script>
<script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
<script>
  AOS.init();
</script>
