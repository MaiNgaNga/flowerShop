<div class="container mt-4" th:fragment="content">
  <h2 class="mb-4">ƒê∆°n h√†ng ƒëang giao</h2>
  <div class="accordion" id="myOrdersAccordion" style="width: 90%">
    <th:block th:if="${#lists.isEmpty(orders)}">
      <div class="text-center my-5">
        <span class="fs-5 text-muted">Hi·ªán ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</span>
      </div>
    </th:block>
    <th:block th:each="order, iterStat : ${orders}">
      <div
        class="accordion-item mb-3"
        style="
          border: 1px solid #e9ecef;
          border-radius: 0.25rem;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        "
      >
        <h2 class="accordion-header" th:id="'heading' + ${iterStat.index}">
          <button
            class="accordion-button collapsed bg-light"
            type="button"
            data-bs-toggle="collapse"
            th:attr="data-bs-target='#order' + ${iterStat.index}"
            style="font-weight: 500; color: #333"
          >
            <span class="badge bg-purple me-2">ID ƒê∆°n h√†ng</span>
            <span th:text="${order.id}" class="fw-bold"></span>
            <span
              class="fw-bold text-primary ms-3"
              th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VND'"
            ></span>
            <span class="ms-2">- üìÖ</span>
            <span
              th:text="${#dates.format(order.deliveryDate, 'dd/MM/yyyy')}"
            ></span>
          </button>
        </h2>
        <div
          th:id="'order' + ${iterStat.index}"
          class="accordion-collapse collapse"
          th:attr="aria-labelledby='heading' + ${iterStat.index}"
          data-bs-parent="#myOrdersAccordion"
        >
          <div class="accordion-body p-4 bg-white">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th class="text-start">S·∫£n ph·∫©m</th>
                  <th>H√¨nh ·∫£nh</th>
                  <th>S·ªë l∆∞·ª£ng</th>
                  <th>ƒê∆°n gi√°</th>
                  <th>Th√†nh ti·ªÅn</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  th:each="detail : ${order.orderDetails}"
                  class="align-middle"
                >
                  <td class="text-start" th:text="${detail.product.name}"></td>
                  <td>
                    <img
                      th:src="@{/images/{image}(image=${detail.product.image_url})}"
                      alt=""
                      width="70px"
                      class="rounded"
                    />
                  </td>
                  <td th:text="${detail.quantity}" class="text-center"></td>
                  <td
                    th:text="${#numbers.formatDecimal(detail.price, 0, 'COMMA', 0, 'POINT')} + ' VND'"
                    class="text-end"
                  ></td>
                  <td
                    th:text="${#numbers.formatDecimal(detail.price * detail.quantity, 0, 'COMMA', 0, 'POINT')} + ' VND'"
                    class="text-end"
                  ></td>
                </tr>
              </tbody>
            </table>
            <div class="card mt-3">
              <div class="card-body p-3">
                <h6 class="card-title fw-bold text-success mb-2">
                  Th√¥ng tin kh√°ch h√†ng
                </h6>
                <p class="mb-1" th:text="'Address: ' + ${order.address}"></p>
                <p class="mb-1" th:text="'Name: ' + ${order.user.name}"></p>
                <p class="mb-0" th:text="'Phone: ' + ${order.sdt}"></p>
              </div>
              <div class="card-body p-3">
                <p class="mb-1" th:text="'M√¥ t·∫£: ' + ${order.description}"></p>
                <p
                  class="mb-1"
                  th:text="'Ng√†y ƒë·∫∑t h√†ng: ' + ${#dates.format(order.createDate, 'dd/MM/yyyy')}"
                ></p>
              </div>
            </div>
            <div class="mt-4 text-end">
              <button
                class="btn btn-info btn-sm me-2"
                onclick="openMapModal(this)"
                th:attr="data-address=${order.address}, data-order-id=${order.id}"
              >
                <i class="bi bi-geo-alt"></i> M·ªü b·∫£n ƒë·ªì ch·ªâ ƒë∆∞·ªùng
              </button>

              <form
                th:action="@{'/shipper/orders/complete/' + ${order.id}}"
                method="post"
                class="d-inline"
              >
                <button
                  type="submit"
                  class="btn btn-success btn-sm me-2"
                  title="ƒê√£ giao"
                >
                  <i class="bi bi-check-circle"></i> ƒê√£ giao
                </button>
              </form>

              <form
                th:action="@{'/shipper/orders/return/' + ${order.id}}"
                method="post"
                class="d-inline"
              >
                <button
                  type="submit"
                  class="btn btn-warning btn-sm me-2"
                  title="Ho√†n t√°c ƒë∆°n"
                >
                  <i class="bi bi-arrow-return-left"></i> Ho√†n t√°c ƒë∆°n
                </button>
              </form>

              <button
                type="button"
                class="btn btn-danger btn-sm"
                title="Giao th·∫•t b·∫°i"
                data-bs-toggle="modal"
                data-bs-target="#failedDeliveryModal"
                th:attr="data-order-id=${order.id}"
              >
                <i class="bi bi-x-circle"></i> Giao th·∫•t b·∫°i
              </button>
            </div>
          </div>
        </div>
      </div>
    </th:block>
  </div>

  <!-- Modal for Failed Delivery Reason -->
  <div
    class="modal fade"
    id="failedDeliveryModal"
    tabindex="-1"
    aria-labelledby="failedDeliveryModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="failedDeliveryModalLabel">
            L√Ω do giao h√†ng th·∫•t b·∫°i
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <form
            id="failedDeliveryForm"
            method="post"
            th:action="@{/shipper/orders/failed}"
          >
            <input type="hidden" name="orderId" id="orderId" />
            <div class="mb-3">
              <label for="failureReason" class="form-label"
                >Ch·ªçn l√Ω do giao h√†ng th·∫•t b·∫°i</label
              >
              <select
                class="form-select"
                id="failureReason"
                name="failureReason"
                required
              >
                <option value="" disabled selected>Ch·ªçn l√Ω do</option>
                <option value="Kh√°ch h√†ng kh√¥ng c√≥ m·∫∑t">
                  Kh√°ch h√†ng kh√¥ng c√≥ m·∫∑t
                </option>
                <option value="ƒê·ªãa ch·ªâ sai">ƒê·ªãa ch·ªâ sai</option>
                <option value="Kh√°ch h√†ng t·ª´ ch·ªëi nh·∫≠n h√†ng">
                  Kh√°ch h√†ng t·ª´ ch·ªëi nh·∫≠n h√†ng
                </option>
                <option value="L·ªói v·∫≠n chuy·ªÉn">L·ªói v·∫≠n chuy·ªÉn</option>
                <option value="Kh√°c">Kh√°c</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="failureDetails" class="form-label"
                >Chi ti·∫øt l√Ω do</label
              >
              <textarea
                class="form-control"
                id="failureDetails"
                name="failureDetails"
                rows="4"
                required
              ></textarea>
            </div>
            <button type="submit" class="btn btn-danger">
              X√°c nh·∫≠n giao th·∫•t b·∫°i
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              ƒê√≥ng
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Cancel Order -->
  <div
    class="modal fade"
    id="cancelOrderModal"
    tabindex="-1"
    aria-labelledby="cancelOrderModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cancelOrderModalLabel">
            L√Ω do h·ªßy ƒë∆°n h√†ng
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <form
            id="cancelOrderForm"
            method="post"
            th:action="@{/shipper/orders/cancel}"
          >
            <input type="hidden" name="orderId" id="cancelOrderId" />
            <div class="mb-3">
              <label for="cancelReason" class="form-label"
                >Ch·ªçn l√Ω do h·ªßy</label
              >
              <select
                class="form-select"
                id="cancelReason"
                name="cancelReason"
                required
              >
                <option value="" disabled selected>Ch·ªçn l√Ω do</option>
                <option value="Kh√°ch h√†ng y√™u c·∫ßu h·ªßy">
                  Kh√°ch h√†ng y√™u c·∫ßu h·ªßy
                </option>
                <option value="Kh√¥ng li√™n l·∫°c ƒë∆∞·ª£c v·ªõi kh√°ch h√†ng">
                  Kh√¥ng li√™n l·∫°c ƒë∆∞·ª£c v·ªõi kh√°ch h√†ng
                </option>
                <option value="L·ªói h·ªá th·ªëng">L·ªói h·ªá th·ªëng</option>
                <option value="Kh√°c">Kh√°c</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="cancelDetails" class="form-label"
                >Chi ti·∫øt l√Ω do</label
              >
              <textarea
                class="form-control"
                id="cancelDetails"
                name="cancelDetails"
                rows="4"
              ></textarea>
            </div>
            <button type="submit" class="btn btn-danger">X√°c nh·∫≠n h·ªßy</button>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              ƒê√≥ng
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // JavaScript cho modal giao h√†ng th·∫•t b·∫°i
    const failedDeliveryModal = document.getElementById("failedDeliveryModal");
    if (failedDeliveryModal) {
      failedDeliveryModal.addEventListener("show.bs.modal", function (event) {
        const button = event.relatedTarget;
        const orderId = button.getAttribute("data-order-id");
        const orderIdInput = failedDeliveryModal.querySelector("#orderId");
        orderIdInput.value = orderId;
      });
    }
    // JavaScript cho modal h·ªßy ƒë∆°n h√†ng
    const cancelOrderModal = document.getElementById("cancelOrderModal");
    if (cancelOrderModal) {
      cancelOrderModal.addEventListener("show.bs.modal", function (event) {
        const button = event.relatedTarget;
        const orderId = button.getAttribute("data-order-id");
        const orderIdInput = cancelOrderModal.querySelector("#cancelOrderId");
        orderIdInput.value = orderId;
      });
    }
  });
</script>

<style>
  .accordion-button:not(.collapsed) {
    color: #000;
    background-color: #fff;
    box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.1);
  }
  .accordion-button:focus {
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    outline: none;
  }
  .table-hover tbody tr:hover {
    background-color: #f8f9fa;
  }
  .table-light th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    text-align: center;
  }
  .text-end {
    text-align: right;
  }
  .text-center {
    text-align: center;
  }
  .card {
    border: 1px solid #e9ecef;
    border-radius: 0.25rem;
  }
  .card-body {
    background-color: #f8f9fa;
  }
  .btn-sm {
    font-size: 0.875rem;
  }
  .bg-purple {
    background-color: #a259e6;
    color: #fff;
  }

  /* Map Modal Styles */
  #mapModal .modal-dialog {
    max-width: 90%;
    width: 900px;
  }

  #map {
    height: 400px;
    width: 100%;
    border-radius: 0.5rem;
    border: 1px solid #dee2e6;
  }

  .route-info {
    background-color: #f8f9fa;
    border-radius: 0.5rem;
    padding: 15px;
    margin-bottom: 15px;
  }

  .loading-spinner {
    display: flex;
    justify-content: center;
    align-items: center;
    height: 60px;
  }
</style>

<!-- Map Modal -->
<div
  class="modal fade"
  id="mapModal"
  tabindex="-1"
  aria-labelledby="mapModalLabel"
  aria-hidden="true"
>
  <div class="modal-dialog modal-lg">
    <div class="modal-content">
      <div class="modal-header">
        <h5 class="modal-title" id="mapModalLabel">
          <i class="bi bi-geo-alt"></i> Ch·ªâ ƒë∆∞·ªùng giao h√†ng
        </h5>
        <button
          type="button"
          class="btn-close"
          data-bs-dismiss="modal"
          aria-label="Close"
        ></button>
      </div>
      <div class="modal-body">
        <div class="route-info" id="routeInfo" style="display: none">
          <div class="row">
            <div class="col-md-6">
              <strong>Kho·∫£ng c√°ch:</strong> <span id="routeDistance">--</span>
            </div>
            <div class="col-md-6">
              <strong>Th·ªùi gian:</strong> <span id="routeDuration">--</span>
            </div>
          </div>
          <div class="mt-2">
            <strong>ƒê·ªãa ch·ªâ giao h√†ng:</strong>
            <span id="deliveryAddress">--</span>
          </div>
        </div>

        <!-- Th√¥ng b√°o v·ªÅ ƒë·ªô ch√≠nh x√°c v·ªã tr√≠ -->
        <div
          class="alert alert-info alert-sm p-2 mb-3"
          style="font-size: 0.875rem"
        >
          <i class="bi bi-info-circle me-1"></i>
          <strong>L∆∞u √Ω:</strong> V·ªã tr√≠ tr√™n m√°y t√≠nh c√≥ th·ªÉ kh√¥ng ch√≠nh x√°c
          b·∫±ng ƒëi·ªán tho·∫°i. N·∫øu v·ªã tr√≠ hi·ªÉn th·ªã sai, h√£y s·ª≠ d·ª•ng n√∫t
          <strong>"B·∫Øt ƒë·∫ßu ƒëi·ªÅu h∆∞·ªõng"</strong> ƒë·ªÉ m·ªü Google Maps v·ªõi ƒë·ªãa ch·ªâ
          ch√≠nh x√°c.
        </div>

        <div class="loading-spinner" id="mapLoading">
          <div class="spinner-border text-primary" role="status">
            <span class="visually-hidden">ƒêang t·∫£i b·∫£n ƒë·ªì...</span>
          </div>
        </div>

        <div id="map" style="display: none"></div>
      </div>
      <div class="modal-footer">
        <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">
          ƒê√≥ng
        </button>
        <button type="button" class="btn btn-primary" id="getCurrentLocation">
          <i class="bi bi-crosshair"></i> V·ªã tr√≠ hi·ªán t·∫°i
        </button>
        <button type="button" class="btn btn-success" id="startNavigation">
          <i class="bi bi-navigation"></i> B·∫Øt ƒë·∫ßu ƒëi·ªÅu h∆∞·ªõng
        </button>
      </div>
    </div>
  </div>
</div>

<!-- Leaflet CSS -->
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css"
  integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY="
  crossorigin=""
/>

<!-- Leaflet JavaScript -->
<script
  src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"
  integrity="sha256-20nQCchB9co0qIjJZRGuk2/Z9VM+kNiyxNV1lvTlZBo="
  crossorigin=""
></script>

<!-- Leaflet Routing Machine -->
<script src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>
<link
  rel="stylesheet"
  href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css"
/>

<script>
  let map;
  let currentLocationMarker;
  let destinationMarker;
  let routeControl;
  let currentOrderAddress = "";

  function openMapModal(button) {
    const address = button.getAttribute("data-address");
    const orderId = button.getAttribute("data-order-id");

    currentOrderAddress = address;
    document.getElementById("deliveryAddress").textContent = address;

    // Reset modal state
    document.getElementById("mapLoading").style.display = "flex";
    document.getElementById("map").style.display = "none";
    document.getElementById("routeInfo").style.display = "none";

    // Show modal
    const modal = new bootstrap.Modal(document.getElementById("mapModal"));
    modal.show();

    // Initialize map after modal is shown
    setTimeout(() => {
      initializeMap(address);
    }, 500);
  }

  function initializeMap(address) {
    // Default location (Vietnam center)
    const defaultLat = 16.0544;
    const defaultLng = 108.2022;

    // Initialize map
    if (map) {
      map.remove();
    }

    map = L.map("map").setView([defaultLat, defaultLng], 13);

    // Add OpenStreetMap tiles
    L.tileLayer("https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png", {
      attribution: "¬© OpenStreetMap contributors",
    }).addTo(map);

    // Hide loading, show map
    document.getElementById("mapLoading").style.display = "none";
    document.getElementById("map").style.display = "block";

    // Resize map to fit container
    setTimeout(() => {
      map.invalidateSize();
    }, 100);

    // Geocode the delivery address
    geocodeAddress(address);

    // Try to get current location
    getCurrentLocationOnMap();
  }

  function geocodeAddress(address) {
    // Th·ª≠ nhi·ªÅu ph∆∞∆°ng ph√°p geocoding ƒë·ªÉ tƒÉng ƒë·ªô ch√≠nh x√°c
    const queries = [
      `${address}, ƒê√† N·∫µng, Vietnam`, // ƒê·∫ßy ƒë·ªß nh·∫•t
      `${address}, Da Nang, Vietnam`, // Ti·∫øng Anh
      `${address}, Vietnam`, // C∆° b·∫£n
      address, // Ch·ªâ ƒë·ªãa ch·ªâ g·ªëc
    ];

    // Th·ª≠ t·ª´ng query cho ƒë·∫øn khi t√¨m ƒë∆∞·ª£c k·∫øt qu·∫£ t·ªët
    tryGeocode(queries, 0);
  }

  function tryGeocode(queries, index) {
    if (index >= queries.length) {
      alert(
        "Kh√¥ng th·ªÉ t√¨m th·∫•y ƒë·ªãa ch·ªâ tr√™n b·∫£n ƒë·ªì. Vui l√≤ng ki·ªÉm tra l·∫°i ƒë·ªãa ch·ªâ."
      );
      return;
    }

    const url = `https://nominatim.openstreetmap.org/search?q=${encodeURIComponent(
      queries[index]
    )}&format=json&limit=3&countrycodes=vn`;

    console.log(`üîç T√¨m ki·∫øm ƒë·ªãa ch·ªâ (l·∫ßn ${index + 1}): ${queries[index]}`);

    fetch(url)
      .then((response) => response.json())
      .then((data) => {
        console.log(`üìç K·∫øt qu·∫£ geocoding:`, data);

        if (data && data.length > 0) {
          // T√¨m k·∫øt qu·∫£ t·ªët nh·∫•t (c√≥ ch·ª©a "ƒê√† N·∫µng" ho·∫∑c "Da Nang")
          let bestResult =
            data.find(
              (item) =>
                item.display_name.includes("ƒê√† N·∫µng") ||
                item.display_name.includes("Da Nang") ||
                item.display_name.includes("H√≤a Kh√°nh")
            ) || data[0];

          const lat = parseFloat(bestResult.lat);
          const lng = parseFloat(bestResult.lon);

          console.log(`‚úÖ ƒê·ªãa ch·ªâ t√¨m ƒë∆∞·ª£c: ${bestResult.display_name}`);
          console.log(`üìç T·ªça ƒë·ªô: ${lat}, ${lng}`);

          // Add destination marker
          if (destinationMarker) {
            map.removeLayer(destinationMarker);
          }

          destinationMarker = L.marker([lat, lng], {
            icon: L.icon({
              iconUrl:
                "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-red.png",
              shadowUrl:
                "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41],
            }),
          }).addTo(map);

          destinationMarker
            .bindPopup(
              `<strong>ƒê·ªãa ch·ªâ giao h√†ng:</strong><br>${currentOrderAddress}<br><br>
             <small><strong>K·∫øt qu·∫£ t√¨m ƒë∆∞·ª£c:</strong><br>${bestResult.display_name}</small>`
            )
            .openPopup();

          // Center map on destination
          map.setView([lat, lng], 15);
        } else {
          // Th·ª≠ query ti·∫øp theo
          tryGeocode(queries, index + 1);
        }
      })
      .catch((error) => {
        console.error("Geocoding error:", error);
        // Th·ª≠ query ti·∫øp theo
        tryGeocode(queries, index + 1);
      });
  } // ƒê√≥ng h√†m tryGeocode

  function getCurrentLocationOnMap() {
    if (navigator.geolocation) {
      // Hi·ªÉn th·ªã loading
      document.getElementById("getCurrentLocation").innerHTML =
        '<i class="spinner-border spinner-border-sm me-2"></i>ƒêang l·∫•y v·ªã tr√≠...';
      document.getElementById("getCurrentLocation").disabled = true;

      navigator.geolocation.getCurrentPosition(
        (position) => {
          const lat = position.coords.latitude;
          const lng = position.coords.longitude;
          const accuracy = position.coords.accuracy;

          console.log(
            `üìç V·ªã tr√≠ hi·ªán t·∫°i: ${lat}, ${lng} (ƒë·ªô ch√≠nh x√°c: ¬±${Math.round(
              accuracy
            )}m)`
          );

          // Add current location marker
          if (currentLocationMarker) {
            map.removeLayer(currentLocationMarker);
          }

          currentLocationMarker = L.marker([lat, lng], {
            icon: L.icon({
              iconUrl:
                "https://raw.githubusercontent.com/pointhi/leaflet-color-markers/master/img/marker-icon-blue.png",
              shadowUrl:
                "https://cdnjs.cloudflare.com/ajax/libs/leaflet/0.7.7/images/marker-shadow.png",
              iconSize: [25, 41],
              iconAnchor: [12, 41],
              popupAnchor: [1, -34],
              shadowSize: [41, 41],
            }),
          }).addTo(map);

          // Popup v·ªõi th√¥ng tin chi ti·∫øt
          const accuracyText =
            accuracy > 100
              ? `‚ö†Ô∏è ƒê·ªô ch√≠nh x√°c th·∫•p: ¬±${Math.round(accuracy)}m`
              : `‚úÖ ƒê·ªô ch√≠nh x√°c t·ªët: ¬±${Math.round(accuracy)}m`;

          currentLocationMarker.bindPopup(
            `<strong>V·ªã tr√≠ hi·ªán t·∫°i c·ªßa b·∫°n</strong><br>
             <small>${accuracyText}</small>`
          );

          // Zoom to current location
          map.setView([lat, lng], 16);

          // Reset button
          document.getElementById("getCurrentLocation").innerHTML =
            '<i class="bi bi-crosshair"></i> V·ªã tr√≠ hi·ªán t·∫°i';
          document.getElementById("getCurrentLocation").disabled = false;

          // If both markers exist, create route
          if (destinationMarker) {
            createRoute();
          }
        },
        (error) => {
          console.error("Geolocation error:", error);

          // Reset button
          document.getElementById("getCurrentLocation").innerHTML =
            '<i class="bi bi-crosshair"></i> V·ªã tr√≠ hi·ªán t·∫°i';
          document.getElementById("getCurrentLocation").disabled = false;

          let errorMessage = "Kh√¥ng th·ªÉ l·∫•y v·ªã tr√≠ hi·ªán t·∫°i. ";
          switch (error.code) {
            case error.PERMISSION_DENIED:
              errorMessage +=
                "Vui l√≤ng cho ph√©p truy c·∫≠p v·ªã tr√≠ trong tr√¨nh duy·ªát.";
              break;
            case error.POSITION_UNAVAILABLE:
              errorMessage += "V·ªã tr√≠ kh√¥ng kh·∫£ d·ª•ng. H√£y th·ª≠ l·∫°i sau.";
              break;
            case error.TIMEOUT:
              errorMessage += "H·∫øt th·ªùi gian ch·ªù. H√£y th·ª≠ l·∫°i.";
              break;
            default:
              errorMessage += "L·ªói kh√¥ng x√°c ƒë·ªãnh.";
              break;
          }

          alert(
            errorMessage +
              "\n\nB·∫°n c√≥ th·ªÉ s·ª≠ d·ª•ng t√≠nh nƒÉng 'B·∫Øt ƒë·∫ßu ƒëi·ªÅu h∆∞·ªõng' ƒë·ªÉ m·ªü Google Maps v·ªõi ƒë·ªãa ch·ªâ ch√≠nh x√°c."
          );
        },
        {
          enableHighAccuracy: true, // Y√™u c·∫ßu ƒë·ªô ch√≠nh x√°c cao
          timeout: 10000, // Timeout 10 gi√¢y
          maximumAge: 300000, // Cache 5 ph√∫t
        }
      );
    } else {
      alert("Tr√¨nh duy·ªát kh√¥ng h·ªó tr·ª£ Geolocation API.");
    }
  } // ƒê√≥ng h√†m getCurrentLocationOnMap

  function createRoute() {
    if (!currentLocationMarker || !destinationMarker) {
      return;
    }

    // Remove existing route
    if (routeControl) {
      map.removeControl(routeControl);
    }

    const startLatLng = currentLocationMarker.getLatLng();
    const endLatLng = destinationMarker.getLatLng();

    // T·∫°o ƒë∆∞·ªùng th·∫≥ng ƒë∆°n gi·∫£n thay v√¨ routing ph·ª©c t·∫°p (tr√°nh OSRM demo server)
    const routeLine = L.polyline(
      [
        [startLatLng.lat, startLatLng.lng],
        [endLatLng.lat, endLatLng.lng],
      ],
      {
        color: "#007bff",
        weight: 4,
        opacity: 0.7,
        dashArray: "10, 10", // ƒê∆∞·ªùng ƒë·ª©t n√©t ƒë·ªÉ ph√¢n bi·ªát v·ªõi ƒë∆∞·ªùng th·∫≠t
      }
    ).addTo(map);

    // T√≠nh kho·∫£ng c√°ch tr·ª±c ti·∫øp (ƒë∆∞·ªùng chim bay)
    const distance = startLatLng.distanceTo(endLatLng);
    const distanceKm = (distance / 1000).toFixed(1);

    // ∆Ø·ªõc l∆∞·ª£ng th·ªùi gian (30km/h trung b√¨nh trong th√†nh ph·ªë)
    const estimatedTime = Math.round((distance / 1000) * 2); // ph√∫t

    document.getElementById("routeDistance").textContent =
      distanceKm + " km (ƒë∆∞·ªùng chim bay)";
    document.getElementById("routeDuration").textContent =
      "~" + estimatedTime + " ph√∫t (∆∞·ªõc l∆∞·ª£ng)";
    document.getElementById("routeInfo").style.display = "block";

    // L∆∞u reference ƒë·ªÉ c√≥ th·ªÉ x√≥a sau
    routeControl = {
      remove: () => map.removeLayer(routeLine),
      addTo: () => routeLine.addTo(map),
    };

    // Zoom ƒë·ªÉ hi·ªÉn th·ªã c·∫£ 2 ƒëi·ªÉm
    const group = new L.featureGroup([
      currentLocationMarker,
      destinationMarker,
    ]);
    map.fitBounds(group.getBounds().pad(0.1));
  }

  // Event listeners
  document
    .getElementById("getCurrentLocation")
    .addEventListener("click", function () {
      getCurrentLocationOnMap();
    });

  document
    .getElementById("startNavigation")
    .addEventListener("click", function () {
      if (currentOrderAddress && currentOrderAddress.trim()) {
        let googleMapsUrl;

        // N·∫øu c√≥ v·ªã tr√≠ hi·ªán t·∫°i, truy·ªÅn c·∫£ ƒëi·ªÉm xu·∫•t ph√°t v√† ƒë√≠ch ƒë·∫øn
        if (currentLocationMarker) {
          const currentPos = currentLocationMarker.getLatLng();
          googleMapsUrl = `https://www.google.com/maps/dir/${currentPos.lat},${
            currentPos.lng
          }/${encodeURIComponent(currentOrderAddress)}`;
          console.log(
            `üó∫Ô∏è M·ªü Google Maps v·ªõi v·ªã tr√≠ hi·ªán t·∫°i: ${currentPos.lat}, ${currentPos.lng}`
          );
        } else {
          // Ch·ªâ c√≥ ƒë·ªãa ch·ªâ ƒë√≠ch, Google Maps s·∫Ω d√πng v·ªã tr√≠ hi·ªán t·∫°i c·ªßa thi·∫øt b·ªã
          googleMapsUrl = `https://www.google.com/maps/dir/?api=1&destination=${encodeURIComponent(
            currentOrderAddress
          )}`;
          console.log(`üó∫Ô∏è M·ªü Google Maps ch·ªâ v·ªõi ƒë·ªãa ch·ªâ ƒë√≠ch`);
        }

        console.log(`üìç ƒê·ªãa ch·ªâ ƒë√≠ch: ${currentOrderAddress}`);
        console.log(`üîó URL: ${googleMapsUrl}`);

        window.open(googleMapsUrl, "_blank");
      } else {
        alert("Kh√¥ng t√¨m th·∫•y ƒë·ªãa ch·ªâ giao h√†ng. Vui l√≤ng th·ª≠ l·∫°i.");
      }
    });

  // Clean up when modal is closed
  document
    .getElementById("mapModal")
    .addEventListener("hidden.bs.modal", function () {
      if (map) {
        map.remove();
        map = null;
      }
      currentLocationMarker = null;
      destinationMarker = null;
      routeControl = null;
    });
</script>
