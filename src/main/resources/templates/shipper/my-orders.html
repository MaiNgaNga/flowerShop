<div class="container mt-4" th:fragment="content">
  <h2 class="mb-4">ƒê∆°n h√†ng ƒëang giao</h2>
  <div class="accordion" id="myOrdersAccordion" style="width: 90%">
    <th:block th:if="${#lists.isEmpty(orders)}">
      <div class="text-center my-5">
        <span class="fs-5 text-muted">Hi·ªán ch∆∞a c√≥ ƒë∆°n h√†ng n√†o</span>
      </div>
    </th:block>
    <th:block th:each="order, iterStat : ${orders}">
      <div
        class="accordion-item mb-3"
        style="
          border: 1px solid #e9ecef;
          border-radius: 0.25rem;
          box-shadow: 0 2px 4px rgba(0, 0, 0, 0.08);
        "
      >
        <h2 class="accordion-header" th:id="'heading' + ${iterStat.index}">
          <button
            class="accordion-button collapsed bg-light"
            type="button"
            data-bs-toggle="collapse"
            th:attr="data-bs-target='#order' + ${iterStat.index}"
            style="font-weight: 500; color: #333"
          >
            <span class="badge bg-purple me-2">ID ƒê∆°n h√†ng</span>
            <span th:text="${order.id}" class="fw-bold"></span>
            <span
              class="fw-bold text-primary ms-3"
              th:text="${#numbers.formatDecimal(order.totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VND'"
            ></span>
            <span class="ms-2">- üìÖ</span>
            <span
              th:text="${#dates.format(order.deliveryDate, 'dd/MM/yyyy')}"
            ></span>
          </button>
        </h2>
        <div
          th:id="'order' + ${iterStat.index}"
          class="accordion-collapse collapse"
          th:attr="aria-labelledby='heading' + ${iterStat.index}"
          data-bs-parent="#myOrdersAccordion"
        >
          <div class="accordion-body p-4 bg-white">
            <table class="table table-hover">
              <thead class="table-light">
                <tr>
                  <th class="text-start">S·∫£n ph·∫©m</th>
                  <th>H√¨nh ·∫£nh</th>
                  <th>S·ªë l∆∞·ª£ng</th>
                  <th>ƒê∆°n gi√°</th>
                  <th>Th√†nh ti·ªÅn</th>
                </tr>
              </thead>
              <tbody>
                <tr
                  th:each="detail : ${order.orderDetails}"
                  class="align-middle"
                >
                  <td class="text-start" th:text="${detail.product.name}"></td>
                  <td>
                    <img
                      th:src="@{/images/{image}(image=${detail.product.image_url})}"
                      alt=""
                      width="70px"
                      class="rounded"
                    />
                  </td>
                  <td th:text="${detail.quantity}" class="text-center"></td>
                  <td
                    th:text="${#numbers.formatDecimal(detail.price, 0, 'COMMA', 0, 'POINT')} + ' VND'"
                    class="text-end"
                  ></td>
                  <td
                    th:text="${#numbers.formatDecimal(detail.price * detail.quantity, 0, 'COMMA', 0, 'POINT')} + ' VND'"
                    class="text-end"
                  ></td>
                </tr>
              </tbody>
            </table>
            <div class="card mt-3">
              <div class="card-body p-3">
                <h6 class="card-title fw-bold text-success mb-2">
                  Th√¥ng tin kh√°ch h√†ng
                </h6>
                <p class="mb-1" th:text="'Address: ' + ${order.address}"></p>
                <p class="mb-1" th:text="'Name: ' + ${order.user.name}"></p>
                <p class="mb-0" th:text="'Phone: ' + ${order.sdt}"></p>
              </div>
              <div class="card-body p-3">
                <p class="mb-1" th:text="'M√¥ t·∫£: ' + ${order.description}"></p>
                <p
                  class="mb-1"
                  th:text="'Ng√†y ƒë·∫∑t h√†ng: ' + ${#dates.format(order.createDate, 'dd/MM/yyyy')}"
                ></p>
              </div>
            </div>
            <div class="mt-4 text-end">
              <div class="btn-group" role="group">
                <form
                  th:action="@{'/shipper/orders/complete/' + ${order.id}}"
                  method="post"
                >
                  <button
                    type="submit"
                    class="btn btn-success btn-sm ms-1"
                    title="ƒê√£ giao"
                  >
                    <i class="bi bi-check-circle"></i> ƒê√£ giao
                  </button>
                </form>
                <form
                  th:action="@{'/shipper/orders/return/' + ${order.id}}"
                  method="post"
                >
                  <button
                    type="submit"
                    class="btn btn-warning btn-sm"
                    title="Ho√†n t√°c ƒë∆°n"
                  >
                    <i class="bi bi-arrow-return-left"></i> Ho√†n t√°c ƒë∆°n
                  </button>
                </form>
                <button
                  type="button"
                  class="btn btn-danger btn-sm ms-1"
                  title="Giao th·∫•t b·∫°i"
                  data-bs-toggle="modal"
                  data-bs-target="#failedDeliveryModal"
                  th:attr="data-order-id=${order.id}"
                >
                  <i class="bi bi-x-circle"></i> Giao th·∫•t b·∫°i
                </button>
              </div>
            </div>
          </div>
        </div>
      </div>
    </th:block>
  </div>

  <!-- Modal for Failed Delivery Reason -->
  <div
    class="modal fade"
    id="failedDeliveryModal"
    tabindex="-1"
    aria-labelledby="failedDeliveryModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="failedDeliveryModalLabel">
            L√Ω do giao h√†ng th·∫•t b·∫°i
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <form
            id="failedDeliveryForm"
            method="post"
            th:action="@{/shipper/orders/failed}"
          >
            <input type="hidden" name="orderId" id="orderId" />
            <div class="mb-3">
              <label for="failureReason" class="form-label"
                >Ch·ªçn l√Ω do giao h√†ng th·∫•t b·∫°i</label
              >
              <select
                class="form-select"
                id="failureReason"
                name="failureReason"
                required
              >
                <option value="" disabled selected>Ch·ªçn l√Ω do</option>
                <option value="Kh√°ch h√†ng kh√¥ng c√≥ m·∫∑t">
                  Kh√°ch h√†ng kh√¥ng c√≥ m·∫∑t
                </option>
                <option value="ƒê·ªãa ch·ªâ sai">ƒê·ªãa ch·ªâ sai</option>
                <option value="Kh√°ch h√†ng t·ª´ ch·ªëi nh·∫≠n h√†ng">
                  Kh√°ch h√†ng t·ª´ ch·ªëi nh·∫≠n h√†ng
                </option>
                <option value="L·ªói v·∫≠n chuy·ªÉn">L·ªói v·∫≠n chuy·ªÉn</option>
                <option value="Kh√°c">Kh√°c</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="failureDetails" class="form-label"
                >Chi ti·∫øt l√Ω do</label
              >
              <textarea
                class="form-control"
                id="failureDetails"
                name="failureDetails"
                rows="4"
                required
              ></textarea>
            </div>
            <button type="submit" class="btn btn-danger">
              X√°c nh·∫≠n giao th·∫•t b·∫°i
            </button>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              ƒê√≥ng
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>

  <!-- Modal for Cancel Order -->
  <div
    class="modal fade"
    id="cancelOrderModal"
    tabindex="-1"
    aria-labelledby="cancelOrderModalLabel"
    aria-hidden="true"
  >
    <div class="modal-dialog">
      <div class="modal-content">
        <div class="modal-header">
          <h5 class="modal-title" id="cancelOrderModalLabel">
            L√Ω do h·ªßy ƒë∆°n h√†ng
          </h5>
          <button
            type="button"
            class="btn-close"
            data-bs-dismiss="modal"
            aria-label="Close"
          ></button>
        </div>
        <div class="modal-body">
          <form
            id="cancelOrderForm"
            method="post"
            th:action="@{/shipper/orders/cancel}"
          >
            <input type="hidden" name="orderId" id="cancelOrderId" />
            <div class="mb-3">
              <label for="cancelReason" class="form-label"
                >Ch·ªçn l√Ω do h·ªßy</label
              >
              <select
                class="form-select"
                id="cancelReason"
                name="cancelReason"
                required
              >
                <option value="" disabled selected>Ch·ªçn l√Ω do</option>
                <option value="Kh√°ch h√†ng y√™u c·∫ßu h·ªßy">
                  Kh√°ch h√†ng y√™u c·∫ßu h·ªßy
                </option>
                <option value="Kh√¥ng li√™n l·∫°c ƒë∆∞·ª£c v·ªõi kh√°ch h√†ng">
                  Kh√¥ng li√™n l·∫°c ƒë∆∞·ª£c v·ªõi kh√°ch h√†ng
                </option>
                <option value="L·ªói h·ªá th·ªëng">L·ªói h·ªá th·ªëng</option>
                <option value="Kh√°c">Kh√°c</option>
              </select>
            </div>
            <div class="mb-3">
              <label for="cancelDetails" class="form-label"
                >Chi ti·∫øt l√Ω do</label
              >
              <textarea
                class="form-control"
                id="cancelDetails"
                name="cancelDetails"
                rows="4"
              ></textarea>
            </div>
            <button type="submit" class="btn btn-danger">X√°c nh·∫≠n h·ªßy</button>
            <button
              type="button"
              class="btn btn-secondary"
              data-bs-dismiss="modal"
            >
              ƒê√≥ng
            </button>
          </form>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // JavaScript cho modal giao h√†ng th·∫•t b·∫°i
    const failedDeliveryModal = document.getElementById("failedDeliveryModal");
    if (failedDeliveryModal) {
      failedDeliveryModal.addEventListener("show.bs.modal", function (event) {
        const button = event.relatedTarget;
        const orderId = button.getAttribute("data-order-id");
        const orderIdInput = failedDeliveryModal.querySelector("#orderId");
        orderIdInput.value = orderId;
      });
    }
    // JavaScript cho modal h·ªßy ƒë∆°n h√†ng
    const cancelOrderModal = document.getElementById("cancelOrderModal");
    if (cancelOrderModal) {
      cancelOrderModal.addEventListener("show.bs.modal", function (event) {
        const button = event.relatedTarget;
        const orderId = button.getAttribute("data-order-id");
        const orderIdInput = cancelOrderModal.querySelector("#cancelOrderId");
        orderIdInput.value = orderId;
      });
    }
  });
</script>

<style>
  .accordion-button:not(.collapsed) {
    color: #000;
    background-color: #fff;
    box-shadow: inset 0 -1px 0 rgba(0, 0, 0, 0.1);
  }
  .accordion-button:focus {
    box-shadow: 0 0 0 0.2rem rgba(0, 123, 255, 0.25);
    outline: none;
  }
  .table-hover tbody tr:hover {
    background-color: #f8f9fa;
  }
  .table-light th {
    background-color: #f8f9fa;
    border-bottom: 2px solid #dee2e6;
    text-align: center;
  }
  .text-end {
    text-align: right;
  }
  .text-center {
    text-align: center;
  }
  .card {
    border: 1px solid #e9ecef;
    border-radius: 0.25rem;
  }
  .card-body {
    background-color: #f8f9fa;
  }
  .btn-sm {
    font-size: 0.875rem;
  }
  .bg-purple {
    background-color: #a259e6;
    color: #fff;
  }
</style>
