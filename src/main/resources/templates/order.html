<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<script>
// Detect khi user quay l·∫°i trang order t·ª´ PayOS v√† c·∫≠p nh·∫≠t ƒë∆°n h√†ng th√†nh "Th·∫•t b·∫°i"
$(document).ready(function() {
    // Ki·ªÉm tra n·∫øu user v·ª´a quay l·∫°i t·ª´ trang thanh to√°n
    if (document.referrer && (document.referrer.includes('payos') || document.referrer.includes('payment'))) {
        console.log('User quay l·∫°i t·ª´ trang thanh to√°n, ƒëang c·∫≠p nh·∫≠t tr·∫°ng th√°i...');
        
        // G·ªçi API ƒë·ªÉ c·∫≠p nh·∫≠t ƒë∆°n h√†ng th√†nh "Th·∫•t b·∫°i"
        $.ajax({
            url: '/payment-status/mark-abandoned',
            type: 'POST',
            success: function(response) {
                console.log('ƒê√£ c·∫≠p nh·∫≠t tr·∫°ng th√°i ƒë∆°n h√†ng:', response);
            },
            error: function(xhr, status, error) {
                console.error('L·ªói khi c·∫≠p nh·∫≠t tr·∫°ng th√°i:', error);
            }
        });
    }
    
    // Backup: C≈©ng ki·ªÉm tra khi trang ƒë∆∞·ª£c load t·ª´ browser back button
    if (performance.navigation.type === 2) { // TYPE_BACK_FORWARD
        console.log('User s·ª≠ d·ª•ng n√∫t back, ki·ªÉm tra ƒë∆°n h√†ng...');
        
        setTimeout(function() {
            $.ajax({
                url: '/payment-status/mark-abandoned',
                type: 'POST',
                success: function(response) {
                    console.log('ƒê√£ ki·ªÉm tra v√† c·∫≠p nh·∫≠t ƒë∆°n h√†ng:', response);
                },
                error: function(xhr, status, error) {
                    console.error('L·ªói khi ki·ªÉm tra ƒë∆°n h√†ng:', error);
                }
            });
        }, 500); // Delay 500ms ƒë·ªÉ ƒë·∫£m b·∫£o trang ƒë√£ load xong
    }
});
</script>
<link rel="stylesheet" th:href="@{/css/order.css}" />
<div class="order-page-container">
  <div class="container mt-4">
    <div id="main-message" class="mt-3">
      <div
        class="alert alert-success"
        th:if="${success}"
        th:text="${success}"
      ></div>
      <div
        class="alert alert-danger"
        th:if="${message}"
        th:text="${message}"
      ></div>
      <div class="alert alert-danger" th:if="${error}" th:text="${error}"></div>
    </div>
    <form th:action="@{/order/checkout}" method="post">
      <div class="row">
        <!-- C·ªôt Th√¥ng tin ƒê·∫∑t h√†ng -->
        <div class="col-md-7">
          <div class="card p-4 mb-4">
            <h5 class="mb-3 mau">Th√¥ng Tin Ng∆∞·ªùi ƒê·∫∑t H√†ng</h5>

            <div class="mb-3">
              <label class="form-label">H·ªç v√† t√™n </label>
              <input
                type="text"
                th:value="${user.name}"
                class="form-control"
                readonly
              />
            </div>
            <div class="mb-3">
              <label class="form-label">Email </label>
              <input
                type="email"
                readonly
                th:value="${user.email}"
                class="form-control"
              />
            </div>
            <th:block th:object="${orderRequest}">
              <div class="mb-3">
                <label class="form-label">S·ªë ƒëi·ªán tho·∫°i *</label>
                <input
                  type="text"
                  th:field="*{sdt}"
                  class="form-control"
                  placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"
                />
                <i class="error text-danger" th:errors="*{sdt}"></i>
              </div>

              <!-- Th√™m ph·∫ßn ch·ªçn ƒë·ªãa ch·ªâ -->

              <div class="mb-3">
                <label class="form-label">X√£/Ph∆∞·ªùng *</label>
                <select name="wardID" id="ward">
                  <th:block th:each="ward : ${wards}">
                    <option
                      th:value="${ward.id}"
                      th:text="${ward.name}"
                      th:data-fee="${ward.zone.shipFee}"
                      th:selected="${ward.id} == ${selectedWardId}"
                    ></option>
                  </th:block>
                </select>
              </div>

              <div class="mb-3">
                <label class="form-label">ƒê·ªãa ch·ªâ c·ª• th·ªÉ *</label>
                <input
                  type="text"
                  id="specific"
                  name="specific"
                  class="form-control"
                  th:value="${specific}"
                  placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ c·ª• th·ªÉ"
                />
                <input type="hidden" th:field="*{address}" id="address" />

                <i class="error text-danger" th:errors="*{address}"></i>
              </div>
              <div class="mb-3">
                <label class="form-label">Ng√†y giao h√†ng *</label>
                <input
                  type="date"
                  th:field="*{deliveryDate}"
                  class="form-control"
                />
                <i class="error text-danger" th:errors="*{deliveryDate}"></i>
              </div>

              <div class="mb-3">
                <label class="form-label">Ghi ch√∫ / M√¥ t·∫£ th√™m</label>
                <textarea
                  th:field="*{description}"
                  class="form-control"
                  rows="3"
                  placeholder="Nh·∫≠p m√¥ t·∫£ n·∫øu c√≥"
                ></textarea>
                <i class="error text-danger" th:errors="*{description}"></i>
              </div>
            </th:block>
          </div>
          <!-- √Åp d·ª•ng m√£ gi·∫£m gi√° - Di chuy·ªÉn l√™n ƒë√¢y -->
          <div class="card mt-4 p-4 mb-3">
            <h6 class="mb-3 mau-small">M√£ Gi·∫£m Gi√°</h6>
            <div class="voucher-form-container">
              <div class="input-group voucher-input">
                <input
                  type="text"
                  id="voucher-input"
                  class="form-control"
                  placeholder="Nh·∫≠p m√£ gi·∫£m gi√°"
                />
                <button
                  type="button"
                  class="btn btn-outline-primary"
                  id="apply-voucher-btn"
                >
                  <i class="fas fa-tags me-1"></i>√Åp d·ª•ng
                </button>
              </div>
            </div>
            <div id="voucher-message" class="mt-2"></div>
          </div>
        </div>

        <!-- C·ªôt ƒê∆°n h√†ng -->
        <div class="col-md-5">
          <div class="card p-4 mb-4">
            <h5 class="mb-3 mau">ƒê∆°n H√†ng C·ªßa B·∫°n</h5>
            <th:block th:each="item : ${cartItems}">
              <div class="order-item-row">
                <img
                  class="order-item-img"
                  th:src="@{/images/{image}(image=*{item.product.image_url})}"
                  alt="·∫¢nh s·∫£n ph·∫©m"
                />
                <div class="order-item-info">
                  <div class="order-item-header">
                    <span
                      class="order-item-name"
                      th:text="${item.product.name}"
                    ></span>
                    <span
                      class="order-item-price"
                      th:text="${#numbers.formatDecimal(item.getTotal(), 0, 'COMMA', 0, 'POINT')} + ' VND'"
                    ></span>
                  </div>
                  <span
                    class="order-item-qty"
                    th:text="'SL:  ' + ${item.quantity}"
                  ></span>
                </div>
              </div>
              <input type="hidden" name="cartItemIds" th:value="${item.id}" />
              <hr />
            </th:block>

            <div class="order-summary">
              <div class="summary-row">
                <span class="summary-label formattedOriginalTotal"
                  >T·ªïng ti·ªÅn h√†ng:</span
                >
                <span
                  class="summary-value"
                  th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VND'"
                ></span>
              </div>
              <div class="summary-row formattedDiscount" style="display: none">
                <span class="summary-label">Gi·∫£m gi√°:</span>
                <span class="summary-value discount-amount">0 VND</span>
              </div>
              <div class="summary-row">
                <span class="summary-label">Ph√≠ v·∫≠n chuy·ªÉn:</span>
                <span class="summary-value shipping-fee-right" id="shippingFee"
                  >0 VND</span
                >
              </div>
              <div class="summary-row">
                <span class="summary-label">T·ªïng thanh to√°n:</span>
                <span
                  class="summary-value finalPrice"
                  th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VND'"
                ></span>
              </div>
            </div>
            <div class="note-alert">
              <div class="note-icon">üå∏</div>
              <div>
                <strong>L∆∞u √Ω quan tr·ªçng:</strong> Do ƒë·∫∑c th√π c·ªßa s·∫£n ph·∫©m hoa
                t∆∞∆°i c·∫ßn ƒë∆∞·ª£c b·∫£o qu·∫£n v√† v·∫≠n chuy·ªÉn c·∫©n th·∫≠n, ch√∫ng t√¥i √°p d·ª•ng
                m·ª©c ph√≠ v·∫≠n chuy·ªÉn ph√π h·ª£p nh·∫±m ƒë·∫£m b·∫£o hoa ƒë·∫øn tay qu√Ω kh√°ch
                t∆∞∆°i ƒë·∫πp nh·∫•t!
              </div>
            </div>
          </div>

          <!-- Ph∆∞∆°ng th·ª©c thanh to√°n - Di chuy·ªÉn l√™n ƒë√¢y -->
          <div class="card p-4 mb-3">
            <h6 class="mb-3 mau-small">Ph∆∞∆°ng Th·ª©c Thanh To√°n</h6>
            <div class="payment-methods-sidebar">
              <div class="form-check payment-option">
                <input
                  class="form-check-input"
                  type="radio"
                  name="paymentMethod"
                  id="paymentCOD"
                  value="COD"
                  checked
                />
                <label class="form-check-label" for="paymentCOD">
                  <div class="payment-icon">
                    <i class="fas fa-money-bill-wave"></i>
                  </div>
                  <div class="payment-text">
                    <span class="payment-title">Thanh to√°n khi nh·∫≠n h√†ng</span>
                    <small class="payment-desc"
                      >Thanh to√°n b·∫±ng ti·ªÅn m·∫∑t khi nh·∫≠n h√†ng</small
                    >
                  </div>
                </label>
              </div>
              <div class="form-check payment-option">
                <input
                  class="form-check-input"
                  type="radio"
                  name="paymentMethod"
                  id="paymentPayOS"
                  value="PAYOS"
                />
                <label class="form-check-label" for="paymentPayOS">
                  <div class="payment-icon">
                    <i class="fas fa-credit-card"></i>
                  </div>
                  <div class="payment-text">
                    <span class="payment-title">Thanh to√°n online</span>
                    <small class="payment-desc"
                      >Thanh to√°n qua PayOS - An to√†n & Nhanh ch√≥ng</small
                    >
                  </div>
                </label>
              </div>
            </div>
          </div>

          <!-- N√∫t ƒê·∫∑t H√†ng g·ª≠i form -->
          <button
            type="submit"
            class="btn btn-success w-100 checkout-button"
            id="checkoutBtn"
          >
            <i class="fas fa-shopping-cart me-2"></i>
            <span>ƒê·∫∂T H√ÄNG NGAY</span>
            <div class="button-shine"></div>
          </button>
        </div>
      </div>
    </form>

    <div th:insert="~{/fragments/chatbot}"></div>
    <script src="https://cdn.jsdelivr.net/npm/aos@2.3.4/dist/aos.js"></script>
    <script>
      AOS.init();

      const wardSelect = document.getElementById("ward");
      const specificInput = document.getElementById("specific");
      const addressInput = document.getElementById("address");
      const shippingFeeSpan = document.getElementById("shippingFee");
      const finalPriceSpan = document.querySelector(".finalPrice");

      // Kh·ªüi t·∫°o c√°c bi·∫øn t√≠nh to√°n
      let originalTotal = parseFloat("[[${totalAmount}]]") || 0;
      let currentDiscount = 0;
      let currentShippingFee = 0;

      function updateAddress() {
        const wardName = wardSelect.selectedOptions[0]?.text || ""; // T√™n x√£
        const wardId = wardSelect.value; // ID ho·∫∑c value trong option
        const specific = specificInput.value.trim();
        if (specific && ward) {
          addressInput.value = `${specific}, ${wardName}, ƒê√† N·∫µng`;
        }

        // C·∫≠p nh·∫≠t ph√≠ v·∫≠n chuy·ªÉn
        const shippingFee = parseFloat(
          wardSelect.selectedOptions[0]?.getAttribute("data-fee") || 0
        );
        currentShippingFee = shippingFee;

        const formattedFee = shippingFee.toLocaleString("vi-VN", {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });
        shippingFeeSpan.textContent = `${formattedFee} VND`;

        // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn
        updateTotalPrice();

        console.log("Ward ID:", wardId);
        console.log("Ward Name:", wardName);
        console.log("Shipping Fee:", shippingFee);
      }

      function updateTotalPrice() {
        const finalTotal = originalTotal - currentDiscount + currentShippingFee;
        const formattedTotal = finalTotal.toLocaleString("vi-VN", {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });
        finalPriceSpan.textContent = `${formattedTotal} VND`;
      }

      // C·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ khi ng∆∞·ªùi d√πng nh·∫≠p ho·∫∑c ch·ªçn
      wardSelect.addEventListener("change", updateAddress);
      specificInput.addEventListener("input", updateAddress);

      // ƒê·∫£m b·∫£o c·∫≠p nh·∫≠t tr∆∞·ªõc khi submit
      document.querySelector("form").addEventListener("submit", function () {
        updateAddress();
      });

      // C·∫≠p nh·∫≠t n√∫t ƒë·∫∑t h√†ng theo ph∆∞∆°ng th·ª©c thanh to√°n
      function updateCheckoutButton() {
        const paymentMethod = document.querySelector(
          'input[name="paymentMethod"]:checked'
        ).value;
        const checkoutBtn = document.getElementById("checkoutBtn");

        if (paymentMethod === "PAYOS") {
          checkoutBtn.innerHTML =
            '<i class="fas fa-credit-card me-2"></i><span>THANH TO√ÅN ONLINE</span><div class="button-shine"></div>';
          checkoutBtn.className = "btn btn-success w-100 checkout-button";
        } else {
          checkoutBtn.innerHTML =
            '<i class="fas fa-shopping-cart me-2"></i><span>ƒê·∫∂T H√ÄNG NGAY</span><div class="button-shine"></div>';
          checkoutBtn.className = "btn btn-success w-100 checkout-button";
        }
      }

      // L·∫Øng nghe thay ƒë·ªïi ph∆∞∆°ng th·ª©c thanh to√°n
      document
        .querySelectorAll('input[name="paymentMethod"]')
        .forEach((radio) => {
          radio.addEventListener("change", updateCheckoutButton);
        });

      // Kh·ªüi t·∫°o ban ƒë·∫ßu
      updateCheckoutButton();

      // T·ª± ƒë·ªông ·∫©n th√¥ng b√°o ch√≠nh sau 4 gi√¢y
      function autoHideMainMessages() {
        const mainMessageDiv = document.getElementById("main-message");
        const alerts = mainMessageDiv.querySelectorAll(".alert");

        alerts.forEach((alert) => {
          if (alert.textContent.trim()) {
            setTimeout(() => {
              alert.style.transition = "opacity 0.5s ease";
              alert.style.opacity = "0";
              setTimeout(() => {
                alert.remove();
              }, 500);
            }, 4000);
          }
        });
      }

      // G·ªçi h√†m t·ª± ƒë·ªông ·∫©n khi trang load
      autoHideMainMessages();
      // X·ª≠ l√Ω √°p d·ª•ng m√£ gi·∫£m gi√°
      document
        .getElementById("apply-voucher-btn")
        .addEventListener("click", function (e) {
          e.preventDefault();

          const voucherInput = document.getElementById("voucher-input");
          const voucher = voucherInput.value.trim();
          const msgDiv = document.getElementById("voucher-message");

          if (!voucher) {
            msgDiv.className = "alert alert-warning mt-3";
            msgDiv.textContent = "Vui l√≤ng nh·∫≠p m√£ gi·∫£m gi√°";
            return;
          }

          fetch("/order/apply-voucher", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams({ voucher }),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                msgDiv.className = "alert alert-success mt-3";
                msgDiv.textContent = data.success;

                // C·∫≠p nh·∫≠t gi√° tr·ªã discount
                currentDiscount = parseFloat(data.discountValue) || 0;

                // Hi·ªÉn th·ªã d√≤ng gi·∫£m gi√°
                const discountRow =
                  document.querySelector(".formattedDiscount");
                const discountAmount =
                  document.querySelector(".discount-amount");

                if (discountRow && discountAmount) {
                  discountRow.style.display = "flex";
                  discountAmount.textContent = `-${data.formattedDiscount} VND`;
                }

                // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn (bao g·ªìm ph√≠ v·∫≠n chuy·ªÉn)
                updateTotalPrice();

                // T·ª± ƒë·ªông ·∫©n th√¥ng b√°o sau 3 gi√¢y
                setTimeout(() => {
                  msgDiv.style.transition = "opacity 0.5s ease";
                  msgDiv.style.opacity = "0";
                  setTimeout(() => {
                    msgDiv.textContent = "";
                    msgDiv.className = "";
                    msgDiv.style.opacity = "1";
                  }, 500);
                }, 3000);
              } else if (data.error) {
                msgDiv.className = "alert alert-danger mt-3";
                msgDiv.textContent = data.error;

                // T·ª± ƒë·ªông ·∫©n th√¥ng b√°o l·ªói sau 4 gi√¢y
                setTimeout(() => {
                  msgDiv.style.transition = "opacity 0.5s ease";
                  msgDiv.style.opacity = "0";
                  setTimeout(() => {
                    msgDiv.textContent = "";
                    msgDiv.className = "";
                    msgDiv.style.opacity = "1";
                  }, 500);
                }, 4000);
              }
            })
            .catch((error) => {
              msgDiv.className = "alert alert-danger mt-3";
              msgDiv.textContent = "C√≥ l·ªói x·∫£y ra khi √°p d·ª•ng m√£ gi·∫£m gi√°";

              // T·ª± ƒë·ªông ·∫©n th√¥ng b√°o l·ªói sau 4 gi√¢y
              setTimeout(() => {
                msgDiv.style.transition = "opacity 0.5s ease";
                msgDiv.style.opacity = "0";
                setTimeout(() => {
                  msgDiv.textContent = "";
                  msgDiv.className = "";
                  msgDiv.style.opacity = "1";
                }, 500);
              }, 4000);
            });
        });

      document
        .getElementById("voucher-input")
        .addEventListener("keydown", function (e) {
          if (e.key === "Enter") {
            e.preventDefault();
            return false;
          }
        });
    </script>
  </div>
</div>
