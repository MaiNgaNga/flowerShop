<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>

<div class="container mt-4">
  <div
    class="success alert alert-success"
    th:if="${success}"
    th:text="${success}"
  ></div>
  <div
    class="success alert alert-danger"
    th:if="${message}"
    th:text="${message}"
  ></div>
  <form th:action="@{/order/checkout}" method="post">
    <div class="row">
      <!-- Cột Thông tin Đặt hàng -->
      <div class="col-md-7">
        <div class="card p-4 mb-4">
          <h5 class="mb-3 mau">Thông Tin Người Đặt Hàng</h5>

          <div class="mb-3">
            <label class="form-label">Họ và tên </label>
            <input
              type="text"
              th:value="${user.name}"
              class="form-control"
              readonly
            />
          </div>
          <div class="mb-3">
            <label class="form-label">Email </label>
            <input
              type="email"
              readonly
              th:value="${user.email}"
              class="form-control"
            />
          </div>
          <th:block th:object="${orderRequest}">
            <div class="mb-3">
              <label class="form-label">Số điện thoại *</label>
              <input
                type="text"
                th:field="*{sdt}"
                class="form-control"
                placeholder="Nhập số điện thoại"
              />
              <i class="error text-danger" th:errors="*{sdt}"></i>
            </div>

            <!-- Thêm phần chọn địa chỉ -->

            <div class="mb-3">
              <label class="form-label">Xã/Phường *</label>
              <select name="wardID" id="ward">
                <th:block th:each="ward : ${wards}">
                  <option
                    th:value="${ward.id}"
                    th:text="${ward.name}"
                    th:data-fee="${ward.zone.shipFee}"
                    th:selected="${ward.id} == ${selectedWardId}"
                  ></option>
                </th:block>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Địa chỉ cụ thể *</label>
              <input
                type="text"
                id="specific"
                name="specific"
                class="form-control"
                th:value="${specific}"
                placeholder="Nhập địa chỉ cụ thể"
              />

              <input type="hidden" th:field="*{address}" id="address" />

              <i class="error text-danger" th:errors="*{address}"></i>
            </div>
            <div class="mb-3">
              <label class="form-label">Ngày giao hàng *</label>
              <input
                type="date"
                th:field="*{deliveryDate}"
                class="form-control"
              />
              <i class="error text-danger" th:errors="*{deliveryDate}"></i>
            </div>

            <div class="mb-3">
              <label class="form-label">Ghi chú / Mô tả thêm</label>
              <textarea
                th:field="*{description}"
                class="form-control"
                rows="3"
                placeholder="Nhập mô tả nếu có"
              ></textarea>
              <i class="error text-danger" th:errors="*{description}"></i>
            </div>
          </th:block>
        </div>
      </div>

      <!-- Cột Đơn hàng -->
      <div class="col-md-5">
        <div class="card p-4 mb-4">
          <h5 class="mb-3 mau">Đơn Hàng Của Bạn</h5>
          <th:block th:each="item : ${cartItems}">
            <div class="d-flex justify-content-between">
              <p th:text="${item.product.name} + ' x ' + ${item.quantity}"></p>
              <span
                th:text="${#numbers.formatDecimal(item.getTotal(), 0, 'COMMA', 0, 'POINT')} + ' VND'"
              ></span>
            </div>
            <input type="hidden" name="cartItemIds" th:value="${item.id}" />
            <hr />
          </th:block>

          <p>
            <span class="formattedOriginalTotal"> </span> <br />
            <strong>Phí vận chuyển: </strong>
            <span class="float-end" name="shippingFee" id="shippingFee">0</span>

            <span class="formattedDiscount"> </span><br />
            <strong>Số tiền phải thanh toán: </strong>

            <span
              class="float-end"
              th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VND'"
            ></span>
          </p>
        </div>

        <!-- Nút Đặt Hàng gửi form -->
        <button type="submit" class="btn btn-success w-100 mt-3">
          ĐẶT HÀNG
        </button>
        <i style="display: block; padding-top: 1rem"
          >Lưu ý: Do đặc thù của sản phẩm hoa tươi cần được bảo quản và vận
          chuyển cẩn thận, chúng tôi áp dụng mức phí vận chuyển phù hợp nhằm đảm
          bảo hoa đến tay quý khách tươi đẹp nhất!</i
        >
      </div>
    </div>
  </form>

  <!-- Áp dụng mã giảm giá -->
  <form action="/order/apply-voucher" method="post" class="mb-3">
    <label for="voucher" class="form-label fw-bold"
      >Mã giảm giá <span class="text-muted">(nếu có)</span></label
    >
    <div class="input-group">
      <input
        type="text"
        id="voucher"
        name="voucher"
        class="form-control"
        placeholder="Nhập mã giảm giá, ví dụ: MA20K"
        required
      />
      <button type="submit" class="btn btn-primary">Áp dụng</button>
    </div>
  </form>
  <div id="voucher-message" class="mt-2"></div>
  <div th:if="${error}" class="alert alert-danger mt-3" role="alert">
    <p th:utext="${error}"></p>
  </div>
  <div th:if="${successApply}" class="alert alert-success mt-3" role="alert">
    <p th:utext="${successApply}"></p>
  </div>

  <script>
    $(document).ready(function () {
      $("#ward").select2({
        placeholder: "Chọn xã/phường",
        allowClear: true,
      });
    });
    const wardSelect = document.getElementById("ward");
    const specificInput = document.getElementById("specific");
    const addressInput = document.getElementById("address");
    const shippingFeeSpan = document.getElementById("shippingFee");

    function updateAddress() {
      const wardName = wardSelect.selectedOptions[0]?.text || ""; // Tên xã
      const wardId = wardSelect.value; // ID hoặc value trong option
      const specific = specificInput.value.trim();
      if (specific && ward) {
        addressInput.value = `${specific}, ${wardName}, Đà Nẵng`;
      }
      const shippingFee =
        wardSelect.selectedOptions[0]?.getAttribute("data-fee") || 0;
      const formattedFee = Number(shippingFee).toLocaleString("en-US", {
        minimumFractionDigits: 0,
        maximumFractionDigits: 0,
      });
      shippingFeeSpan.textContent = ` ${formattedFee} VND`;

      console.log("Ward ID:", wardId);
      console.log("Ward Name:", wardName);
      console.log("Shipping Fee:", shippingFee);
    }

    // Cập nhật địa chỉ khi người dùng nhập hoặc chọn
    wardSelect.addEventListener("change", updateAddress);
    specificInput.addEventListener("input", updateAddress);

    // Đảm bảo cập nhật trước khi submit
    document.querySelector("form").addEventListener("submit", function () {
      updateAddress();
    });
    // Xử lý áp dụng mã giảm giá
    document
      .querySelector('form[action="/order/apply-voucher"]')
      .addEventListener("submit", function (e) {
        e.preventDefault();

        const voucherInput = document.getElementById("voucher");
        const voucher = voucherInput.value.trim();
        const msgDiv = document.getElementById("voucher-message");

        fetch("/order/apply-voucher", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: new URLSearchParams({ voucher }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              msgDiv.className = "alert alert-success mt-3";
              msgDiv.textContent = data.success;

              // Cập nhật tổng cộng
              const totalEl = document.querySelector(".float-end");
              if (totalEl) totalEl.textContent = data.formattedTotal + " VND";
              const originalTotalEl = document.querySelector(
                ".formattedOriginalTotal"
              );
              if (originalTotalEl) {
                originalTotalEl.innerHTML =
                  "<b> Giá gốc: </b> <span class='float-end'>" +
                  data.formattedOriginalTotal +
                  " VND </span>";
              }
              const discountEl = document.querySelector(".formattedDiscount");
              if (discountEl) {
                discountEl.innerHTML =
                  "<b>Giảm giá:</b> <span class='float-end'>" +
                  data.formattedDiscount +
                  " VND</span>";
              }
            } else if (data.error) {
              msgDiv.className = "alert alert-danger mt-3";
              msgDiv.textContent = data.error;
            }
          });
      });
  </script>
</div>
