<script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>
<style>
  /* Order Page Specific Styling - Kh√¥ng ·∫£nh h∆∞·ªüng ƒë·∫øn footer v√† c√°c trang kh√°c */
  .order-page-container {
    background: linear-gradient(135deg, #f8f9fa 0%, #e9ecef 100%);
    min-height: 80vh;
    padding: 20px 0;
  }

  .order-page-container .container {
    max-width: 1200px;
  }

  .order-page-container .shipping-fee-right {
    float: right;
    font-weight: 600;
    color: #28a745;
  }

  .order-page-container .order-item-row {
    display: flex;
    align-items: flex-start;
    margin-bottom: 0;
    gap: 15px;
    padding: 15px 0;
    border-bottom: 1px solid #e9ecef;
  }

  .order-page-container .order-item-row:last-child {
    border-bottom: none;
  }

  .order-page-container .order-item-img {
    width: 65px;
    height: 65px;
    object-fit: cover;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    background: #f8f9fa;
    flex-shrink: 0;
    transition: transform 0.2s ease;
  }

  .order-page-container .order-item-img:hover {
    transform: scale(1.02);
  }

  .order-page-container .order-item-info {
    flex: 1;
    display: flex;
    flex-direction: column;
    min-width: 0;
  }

  .order-page-container .order-item-header {
    display: flex;
    justify-content: space-between;
    align-items: flex-start;
    width: 100%;
  }

  .order-page-container .order-item-name {
    font-weight: 600;
    font-size: 1rem;
    color: #495057;
    line-height: 1.4;
    margin-bottom: 5px;
  }

  .order-page-container .order-item-price {
    color: #dc3545;
    font-weight: 600;
    font-size: 1rem;
    margin-left: 12px;
    white-space: nowrap;
  }

  .order-page-container .order-item-qty {
    color: #6c757d;
    font-size: 0.9rem;
    font-weight: 500;
    margin-top: 4px;
  }

  .order-page-container .card {
    border-radius: 12px;
    border: 1px solid #dee2e6;
    box-shadow: 0 4px 6px rgba(0, 0, 0, 0.07);
    background: #fff;
    transition: box-shadow 0.3s ease;
  }

  .order-page-container .card:hover {
    box-shadow: 0 8px 15px rgba(0, 0, 0, 0.1);
  }

  .order-page-container .card h5.mau {
    color: #495057;
    font-weight: 700;
    letter-spacing: 0.3px;
    margin-bottom: 1.5rem;
    font-size: 1.2rem;
    position: relative;
    padding-bottom: 8px;
  }

  .order-page-container .card h5.mau::after {
    content: "";
    position: absolute;
    bottom: 0;
    left: 0;
    width: 40px;
    height: 2px;
    background: #28a745;
    border-radius: 1px;
  }

  .order-page-container .form-label {
    font-weight: 600;
    color: #495057;
    margin-bottom: 6px;
    font-size: 0.95rem;
  }

  .order-page-container .form-control,
  .order-page-container select,
  .order-page-container textarea {
    border-radius: 8px !important;
    border: 1px solid #ced4da;
    padding: 10px 12px;
    font-size: 0.95rem;
    background: #fff;
    transition: border-color 0.2s ease, box-shadow 0.2s ease;
  }

  .order-page-container .form-control:focus,
  .order-page-container select:focus,
  .order-page-container textarea:focus {
    border-color: #28a745;
    background: #fff;
    box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.1);
  }

  .order-page-container select {
    min-height: 42px;
    cursor: pointer;
  }

  .order-page-container .mb-3 {
    margin-bottom: 1.25rem !important;
  }

  .order-page-container .error.text-danger {
    font-size: 0.85rem;
    margin-top: 4px;
    display: block;
    font-weight: 500;
  }
  .order-page-container textarea.form-control {
    resize: vertical;
    min-height: 80px;
  }

  /* Responsive padding for card */
  @media (max-width: 767px) {
    .order-page-container .card.p-4 {
      padding: 1.25rem !important;
    }
  }

  .order-page-container .note-alert {
    background: #fff3cd;
    border-left: 3px solid #ffc107;
    border-radius: 8px;
    padding: 15px 18px;
    margin-bottom: 18px;
    display: flex;
    align-items: flex-start;
    gap: 10px;
    font-size: 0.95rem;
    color: #856404;
  }

  .order-page-container .note-alert .note-icon {
    font-size: 1.2em;
    margin-right: 6px;
    color: #ffc107;
    flex-shrink: 0;
    line-height: 1.2;
  }

  .order-page-container .input-group {
    display: flex;
    align-items: stretch;
    border-radius: 8px;
    overflow: hidden;
    box-shadow: 0 2px 4px rgba(0, 0, 0, 0.05);
  }

  .order-page-container .input-group .form-control {
    border-radius: 8px 0 0 8px !important;
    border: 1px solid #ced4da;
    background: #fff;
    font-size: 0.95rem;
    transition: border-color 0.2s ease;
  }

  .order-page-container .input-group .form-control:focus {
    border-color: #28a745;
    background: #fff;
    box-shadow: 0 0 0 2px rgba(40, 167, 69, 0.1);
  }

  .order-page-container .input-group .btn {
    border-radius: 0 8px 8px 0 !important;
    font-weight: 600;
    font-size: 0.95rem;
    padding: 0 20px;
    transition: background-color 0.2s ease;
  }

  .order-page-container .input-group .btn-primary {
    background: #007bff;
    border-color: #007bff;
  }

  .order-page-container .input-group .btn-primary:hover {
    background: #0056b3;
    border-color: #0056b3;
  }

  /* Payment Methods Styling */
  .order-page-container .payment-methods {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 16px;
    border: 1px solid #dee2e6;
  }

  .order-page-container .form-check {
    padding: 12px 16px;
    border-radius: 8px;
    border: 1px solid #dee2e6;
    background: #fff;
    transition: all 0.2s ease;
    cursor: pointer;
    margin-bottom: 10px;
  }

  .order-page-container .form-check:hover {
    border-color: #28a745;
    background: #f8fff9;
  }

  .order-page-container .form-check-input:checked + .form-check-label {
    color: #28a745;
    font-weight: 600;
  }

  .order-page-container .form-check-input:checked {
    background-color: #28a745;
    border-color: #28a745;
  }

  .order-page-container .form-check-label {
    cursor: pointer;
    font-size: 0.95rem;
    display: flex;
    align-items: center;
    font-weight: 500;
  }

  .order-page-container .form-check-label i {
    color: #6c757d;
    margin-right: 8px;
    font-size: 1.1em;
  }

  .order-page-container .form-check-input:checked + .form-check-label i {
    color: #28a745;
  }

  /* Order Summary Styling */
  .order-page-container .order-summary {
    background: #f8f9fa;
    border-radius: 8px;
    padding: 16px;
    margin-top: 16px;
    border: 1px solid #dee2e6;
  }

  .order-page-container .summary-row {
    display: flex;
    justify-content: space-between;
    align-items: center;
    padding: 6px 0;
    border-bottom: 1px solid #e9ecef;
  }

  .order-page-container .summary-row:last-child {
    border-bottom: none;
    font-weight: 700;
    font-size: 1.05rem;
    color: #495057;
    padding-top: 12px;
    border-top: 1px solid #28a745;
  }

  .order-page-container .summary-label {
    font-weight: 600;
    color: #495057;
  }

  .order-page-container .summary-value {
    font-weight: 600;
    color: #28a745;
  }

  /* Button Styling */
  .order-page-container .btn {
    border-radius: 8px;
    font-weight: 600;
    padding: 10px 24px;
    transition: all 0.2s ease;
    border: none;
  }

  .order-page-container .btn:hover {
    transform: translateY(-1px);
  }

  .order-page-container .btn-success {
    background: #28a745;
    border-color: #28a745;
  }

  .order-page-container .btn-success:hover {
    background: #218838;
    border-color: #1e7e34;
  }

  .order-page-container .btn-primary {
    background: #007bff;
    border-color: #007bff;
  }

  .order-page-container .btn-primary:hover {
    background: #0056b3;
    border-color: #004085;
  }
</style>
<div class="order-page-container">
  <div class="container mt-4">
    <div
      class="success alert alert-success"
      th:if="${success}"
      th:text="${success}"
    ></div>
    <div
      class="success alert alert-danger"
      th:if="${message}"
      th:text="${message}"
    ></div>
    <div class="alert alert-danger" th:if="${error}" th:text="${error}"></div>
    <form th:action="@{/order/checkout}" method="post">
      <div class="row">
        <!-- C·ªôt Th√¥ng tin ƒê·∫∑t h√†ng -->
        <div class="col-md-7">
          <div class="card p-4 mb-4">
            <h5 class="mb-3 mau">Th√¥ng Tin Ng∆∞·ªùi ƒê·∫∑t H√†ng</h5>

            <div class="mb-3">
              <label class="form-label">H·ªç v√† t√™n </label>
              <input
                type="text"
                th:value="${user.name}"
                class="form-control"
                readonly
              />
            </div>
            <div class="mb-3">
              <label class="form-label">Email </label>
              <input
                type="email"
                readonly
                th:value="${user.email}"
                class="form-control"
              />
            </div>
            <th:block th:object="${orderRequest}">
              <div class="mb-3">
                <label class="form-label">S·ªë ƒëi·ªán tho·∫°i *</label>
                <input
                  type="text"
                  th:field="*{sdt}"
                  class="form-control"
                  placeholder="Nh·∫≠p s·ªë ƒëi·ªán tho·∫°i"
                />
                <i class="error text-danger" th:errors="*{sdt}"></i>
              </div>

              <!-- Th√™m ph·∫ßn ch·ªçn ƒë·ªãa ch·ªâ -->

              <div class="mb-3">
                <label class="form-label">X√£/Ph∆∞·ªùng *</label>
                <select name="wardID" id="ward">
                  <th:block th:each="ward : ${wards}">
                    <option
                      th:value="${ward.id}"
                      th:text="${ward.name}"
                      th:data-fee="${ward.zone.shipFee}"
                      th:selected="${ward.id} == ${selectedWardId}"
                    ></option>
                  </th:block>
                </select>
              </div>

              <div class="mb-3">
                <label class="form-label">ƒê·ªãa ch·ªâ c·ª• th·ªÉ *</label>
                <input
                  type="text"
                  id="specific"
                  name="specific"
                  class="form-control"
                  th:value="${specific}"
                  placeholder="Nh·∫≠p ƒë·ªãa ch·ªâ c·ª• th·ªÉ"
                />
                <input type="hidden" th:field="*{address}" id="address" />

                <i class="error text-danger" th:errors="*{address}"></i>
              </div>
              <div class="mb-3">
                <label class="form-label">Ng√†y giao h√†ng *</label>
                <input
                  type="date"
                  th:field="*{deliveryDate}"
                  class="form-control"
                />
                <i class="error text-danger" th:errors="*{deliveryDate}"></i>
              </div>

              <div class="mb-3">
                <label class="form-label">Ghi ch√∫ / M√¥ t·∫£ th√™m</label>
                <textarea
                  th:field="*{description}"
                  class="form-control"
                  rows="3"
                  placeholder="Nh·∫≠p m√¥ t·∫£ n·∫øu c√≥"
                ></textarea>
                <i class="error text-danger" th:errors="*{description}"></i>
              </div>

              <!-- Ph∆∞∆°ng th·ª©c thanh to√°n -->
              <div class="mb-3">
                <label class="form-label">Ph∆∞∆°ng th·ª©c thanh to√°n *</label>
                <div class="payment-methods">
                  <div class="form-check mb-2">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="paymentMethod"
                      id="paymentCOD"
                      value="COD"
                      checked
                    />
                    <label class="form-check-label" for="paymentCOD">
                      <i class="fas fa-money-bill-wave me-2"></i>
                      Thanh to√°n khi nh·∫≠n h√†ng (COD)
                    </label>
                  </div>
                  <div class="form-check">
                    <input
                      class="form-check-input"
                      type="radio"
                      name="paymentMethod"
                      id="paymentPayOS"
                      value="PAYOS"
                    />
                    <label class="form-check-label" for="paymentPayOS">
                      <i class="fas fa-credit-card me-2"></i>
                      Thanh to√°n online qua PayOS
                    </label>
                  </div>
                </div>
              </div>
            </th:block>
          </div>
        </div>

        <!-- C·ªôt ƒê∆°n h√†ng -->
        <div class="col-md-5">
          <div class="card p-4 mb-4">
            <h5 class="mb-3 mau">ƒê∆°n H√†ng C·ªßa B·∫°n</h5>
            <th:block th:each="item : ${cartItems}">
              <div class="order-item-row">
                <img
                  class="order-item-img"
                  th:src="@{/images/{image}(image=*{item.product.image_url})}"
                  alt="·∫¢nh s·∫£n ph·∫©m"
                />
                <div class="order-item-info">
                  <div class="order-item-header">
                    <span
                      class="order-item-name"
                      th:text="${item.product.name}"
                    ></span>
                    <span
                      class="order-item-price"
                      th:text="${#numbers.formatDecimal(item.getTotal(), 0, 'COMMA', 0, 'POINT')} + ' VND'"
                    ></span>
                  </div>
                  <span
                    class="order-item-qty"
                    th:text="'SL:  ' + ${item.quantity}"
                  ></span>
                </div>
              </div>
              <input type="hidden" name="cartItemIds" th:value="${item.id}" />
              <hr />
            </th:block>

            <div class="order-summary">
              <div class="summary-row">
                <span class="summary-label formattedOriginalTotal"
                  >T·ªïng ti·ªÅn h√†ng:</span
                >
                <span
                  class="summary-value"
                  th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VND'"
                ></span>
              </div>
              <div class="summary-row formattedDiscount" style="display: none">
                <span class="summary-label">Gi·∫£m gi√°:</span>
                <span class="summary-value discount-amount">0 VND</span>
              </div>
              <div class="summary-row">
                <span class="summary-label">Ph√≠ v·∫≠n chuy·ªÉn:</span>
                <span class="summary-value shipping-fee-right" id="shippingFee"
                  >0 VND</span
                >
              </div>
              <div class="summary-row">
                <span class="summary-label">T·ªïng thanh to√°n:</span>
                <span
                  class="summary-value finalPrice"
                  th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VND'"
                ></span>
              </div>
            </div>
            <div class="note-alert">
              <div class="note-icon">üå∏</div>
              <div>
                <strong>L∆∞u √Ω quan tr·ªçng:</strong> Do ƒë·∫∑c th√π c·ªßa s·∫£n ph·∫©m hoa
                t∆∞∆°i c·∫ßn ƒë∆∞·ª£c b·∫£o qu·∫£n v√† v·∫≠n chuy·ªÉn c·∫©n th·∫≠n, ch√∫ng t√¥i √°p d·ª•ng
                m·ª©c ph√≠ v·∫≠n chuy·ªÉn ph√π h·ª£p nh·∫±m ƒë·∫£m b·∫£o hoa ƒë·∫øn tay qu√Ω kh√°ch
                t∆∞∆°i ƒë·∫πp nh·∫•t!
              </div>
            </div>
          </div>
          <!--  -->

          <!-- N√∫t ƒê·∫∑t H√†ng g·ª≠i form -->
          <button
            type="submit"
            class="btn btn-success w-100 mt-4"
            id="checkoutBtn"
            style="
              font-size: 1.1rem;
              padding: 15px 30px;
              position: relative;
              overflow: hidden;
            "
          >
            <i class="fas fa-shopping-cart me-2"></i>ƒê·∫∂T H√ÄNG
          </button>
        </div>
      </div>
    </form>
    <!-- √Åp d·ª•ng m√£ gi·∫£m gi√° -->
    <form action="/order/apply-voucher" method="post" class="mb-3">
      <label for="voucher" class="form-label fw-bold"
        >M√£ gi·∫£m gi√° <span class="text-muted">(n·∫øu c√≥)</span></label
      >
      <div class="input-group">
        <input
          type="text"
          id="voucher"
          name="voucher"
          class="form-control"
          placeholder="Nh·∫≠p m√£ gi·∫£m gi√°, v√≠ d·ª•: MA20K"
          required
        />
        <button type="submit" class="btn btn-primary">√Åp d·ª•ng</button>
      </div>
    </form>
    <div id="voucher-message" class="mt-2"></div>
    <div th:if="${error}" class="alert alert-danger mt-3" role="alert">
      <p th:utext="${error}"></p>
    </div>
    <div th:if="${successApply}" class="alert alert-success mt-3" role="alert">
      <p th:utext="${successApply}"></p>
    </div>

    <script>
      const wardSelect = document.getElementById("ward");
      const specificInput = document.getElementById("specific");
      const addressInput = document.getElementById("address");
      const shippingFeeSpan = document.getElementById("shippingFee");

      function updateAddress() {
        const wardName = wardSelect.selectedOptions[0]?.text || ""; // T√™n x√£
        const wardId = wardSelect.value; // ID ho·∫∑c value trong option
        const specific = specificInput.value.trim();
        if (specific && ward) {
          addressInput.value = `${specific}, ${wardName}, ƒê√† N·∫µng`;
        }

        // C·∫≠p nh·∫≠t ph√≠ v·∫≠n chuy·ªÉn
        const shippingFee = parseFloat(
          wardSelect.selectedOptions[0]?.getAttribute("data-fee") || 0
        );
        currentShippingFee = shippingFee;

        const formattedFee = shippingFee.toLocaleString("vi-VN", {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });
        shippingFeeSpan.textContent = `${formattedFee} VND`;

        // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn
        updateTotalPrice();

        console.log("Ward ID:", wardId);
        console.log("Ward Name:", wardName);
        console.log("Shipping Fee:", shippingFee);
      }

      function updateTotalPrice() {
        const finalTotal = originalTotal - currentDiscount + currentShippingFee;
        const formattedTotal = finalTotal.toLocaleString("vi-VN", {
          minimumFractionDigits: 0,
          maximumFractionDigits: 0,
        });
        finalPriceSpan.textContent = `${formattedTotal} VND`;
      }

      // C·∫≠p nh·∫≠t ƒë·ªãa ch·ªâ khi ng∆∞·ªùi d√πng nh·∫≠p ho·∫∑c ch·ªçn
      wardSelect.addEventListener("change", updateAddress);
      specificInput.addEventListener("input", updateAddress);

      // ƒê·∫£m b·∫£o c·∫≠p nh·∫≠t tr∆∞·ªõc khi submit
      document.querySelector("form").addEventListener("submit", function () {
        updateAddress();
      });

      // C·∫≠p nh·∫≠t n√∫t ƒë·∫∑t h√†ng theo ph∆∞∆°ng th·ª©c thanh to√°n
      function updateCheckoutButton() {
        const paymentMethod = document.querySelector(
          'input[name="paymentMethod"]:checked'
        ).value;
        const checkoutBtn = document.getElementById("checkoutBtn");

        if (paymentMethod === "PAYOS") {
          checkoutBtn.innerHTML =
            '<i class="fas fa-credit-card me-2"></i>THANH TO√ÅN ONLINE';
          checkoutBtn.className = "btn btn-primary w-100 mt-4";
          checkoutBtn.style.fontSize = "1rem";
          checkoutBtn.style.padding = "12px 24px";
        } else {
          checkoutBtn.innerHTML =
            '<i class="fas fa-shopping-cart me-2"></i>ƒê·∫∂T H√ÄNG';
          checkoutBtn.className = "btn btn-success w-100 mt-4";
          checkoutBtn.style.fontSize = "1rem";
          checkoutBtn.style.padding = "12px 24px";
        }
      }

      // L·∫Øng nghe thay ƒë·ªïi ph∆∞∆°ng th·ª©c thanh to√°n
      document
        .querySelectorAll('input[name="paymentMethod"]')
        .forEach((radio) => {
          radio.addEventListener("change", updateCheckoutButton);
        });

      // Kh·ªüi t·∫°o ban ƒë·∫ßu
      updateCheckoutButton();
      // X·ª≠ l√Ω √°p d·ª•ng m√£ gi·∫£m gi√°
      document
        .querySelector('form[action="/order/apply-voucher"]')
        .addEventListener("submit", function (e) {
          e.preventDefault();

          const voucherInput = document.getElementById("voucher");
          const voucher = voucherInput.value.trim();
          const msgDiv = document.getElementById("voucher-message");

          fetch("/order/apply-voucher", {
            method: "POST",
            headers: {
              "Content-Type": "application/x-www-form-urlencoded",
            },
            body: new URLSearchParams({ voucher }),
          })
            .then((res) => res.json())
            .then((data) => {
              if (data.success) {
                msgDiv.className = "alert alert-success mt-3";
                msgDiv.textContent = data.success;

                // C·∫≠p nh·∫≠t gi√° tr·ªã discount
                currentDiscount = parseFloat(data.discountValue) || 0;

                // Hi·ªÉn th·ªã d√≤ng gi·∫£m gi√°
                const discountRow =
                  document.querySelector(".formattedDiscount");
                const discountAmount =
                  document.querySelector(".discount-amount");

                if (discountRow && discountAmount) {
                  discountRow.style.display = "flex";
                  discountAmount.textContent = `-${data.formattedDiscount} VND`;
                }

                // C·∫≠p nh·∫≠t t·ªïng ti·ªÅn (bao g·ªìm ph√≠ v·∫≠n chuy·ªÉn)
                updateTotalPrice();
              } else if (data.error) {
                msgDiv.className = "alert alert-danger mt-3";
                msgDiv.textContent = data.error;
              }
            });
        });
    </script>
  </div>
</div>
