<div class="container mt-4">
  <div
    class="success alert alert-success"
    th:if="${success}"
    th:text="${success}"
  ></div>
  <div
    class="success alert alert-danger"
    th:if="${message}"
    th:text="${message}"
  ></div>
  <form th:action="@{/order/checkout}" method="post">
    <div class="row">
      <!-- Cột Thông tin Đặt hàng -->
      <div class="col-md-7">
        <div class="card p-4 mb-4">
          <h5 class="mb-3 mau">Thông Tin Người Đặt Hàng</h5>

          <div class="mb-3">
            <label class="form-label">Họ và tên </label>
            <input
              type="text"
              th:value="${user.name}"
              class="form-control"
              readonly
            />
          </div>
          <div class="mb-3">
            <label class="form-label">Email </label>
            <input
              type="email"
              readonly
              th:value="${user.email}"
              class="form-control"
            />
          </div>
          <th:block th:object="${orderRequest}">
            <div class="mb-3">
              <label class="form-label">Số điện thoại *</label>
              <input
                type="text"
                th:field="*{sdt}"
                class="form-control"
                placeholder="Nhập số điện thoại"
              />
              <i class="error text-danger" th:errors="*{sdt}"></i>
            </div>

            <!-- Thêm phần chọn địa chỉ -->

            <div class="mb-3">
              <label class="form-label">Xã/Phường *</label>
              <select name="don_vi_hanh_chinh" id="ward">
                <option value="An Hai">An Hải</option>
                <option value="An Khe">An Khê</option>
                <option value="An Thang">An Thắng</option>
                <option value="Avuong">Avương</option>
                <option value="Ba">Ba</option>
                <option value="Ba Na">Bà Nà</option>
                <option value="Ban Thach">Bàn Thạch</option>
                <option value="Ben Giang">Bến Giằng</option>
                <option value="Ben Hien">Bến Hiên</option>
                <option value="Cam Le">Cẩm Lệ</option>
                <option value="Chien Dan">Chiên Đàn</option>
                <option value="Dac Pring">Đắc Pring</option>
                <option value="Dai Loc">Đại Lộc</option>
                <option value="Dien Ban">Điện Bàn</option>
                <option value="Dien Ban Bac">Điện Bàn Bắc</option>
                <option value="Dien Ban Dong">Điện Bàn Đông</option>
                <option value="Dong Duong">Đồng Dương</option>
                <option value="Dong Giang">Prao</option>
                <option value="Duc Phu">Đức Phú</option>
                <option value="Duy Nghia">Duy Nghĩa</option>
                <option value="Duy Xuyen">Duy Xuyên</option>
                <option value="Hai Chau">Hải Châu</option>
                <option value="Hai Van">Hải Vân</option>
                <option value="Ha Nha">Hà Nha</option>
                <option value="Hiep Duc">Tân Bình</option>
                <option value="Hoa Cuong">Hòa Cường</option>
                <option value="Hoa Khanh">Hòa Khánh</option>
                <option value="Hoa Tien">Hòa Tiến</option>
                <option value="Hoa Vang">Hòa Vang</option>
                <option value="Hoa Xuan">Hòa Xuân</option>
                <option value="Hoi An">Hội An</option>
                <option value="Hoi An Dong">Hội An Đông</option>
                <option value="Hoi An Tay">Hội An Tây</option>
                <option value="Hoang Sa">Hoàng Sa</option>
                <option value="Huong Tra">Hương Trà</option>
                <option value="Hung Son">Hùng Sơn</option>
                <option value="Kham Duc">Khâm Đức</option>
                <option value="La Dee">La Dêê</option>
                <option value="La Eee">La Êê</option>
                <option value="Lanh Ngoc">Lãnh Ngọc</option>
                <option value="Lien Chieu">Liên Chiểu</option>
                <option value="Nam Giang">Nam Giang</option>
                <option value="Nam Phuoc">Nam Phước</option>
                <option value="Nam Tra My">Nam Trà My</option>
                <option value="Ngu Hanh Son">Ngũ Hành Sơn</option>
                <option value="Nong Son">Nông Sơn</option>
                <option value="Nui Thanh">Núi Thành</option>
                <option value="Phu Ninh">Phú Ninh</option>
                <option value="Phu Thuan">Phú Thuận</option>
                <option value="Phuoc Chanh">Phước Chánh</option>
                <option value="Phuoc Hiep">Phước Hiệp</option>
                <option value="Phuoc Nang">Phước Năng</option>
                <option value="Phuoc Thanh">Phước Thành</option>
                <option value="Phuoc Tra">Phước Trà</option>
                <option value="Quang Phu">Quảng Phú</option>
                <option value="Que Phuoc">Quế Phước</option>
                <option value="Que Son">Quế Sơn</option>
                <option value="Que Son Trung">Quế Sơn Trung</option>
                <option value="Son Cam Ha">Sơn Cẩm Hà</option>
                <option value="Son Tra">Sơn Trà</option>
                <option value="Song Kon">Sông Kôn</option>
                <option value="Tam Anh">Tam Anh</option>
                <option value="Tam Hai">Tam Hải</option>
                <option value="Tam Ky">Tam Kỳ</option>
                <option value="Tam My">Tam Mỹ</option>
                <option value="Tam Xuan">Tam Xuân</option>
                <option value="Tan Hiep">Tân Hiệp</option>
                <option value="Tay Giang">Tây Giang</option>
                <option value="Tay Ho">Tây Hồ</option>
                <option value="Thanh Binh">Thanh Bình</option>
                <option value="Thanh Khe">Thanh Khê</option>
                <option value="Thanh My">Thạnh Mỹ</option>
                <option value="Thang An">Thăng An</option>
                <option value="Thang Binh">Thăng Bình</option>
                <option value="Thang Dien">Thăng Điền</option>
                <option value="Thang Phu">Thăng Phú</option>
                <option value="Thang Truong">Thăng Trường</option>
                <option value="Thu Bon">Thu Bồn</option>
                <option value="Thuong Duc">Thượng Đức</option>
                <option value="Tien Phuoc">Tiên Phước</option>
                <option value="Tra Doc">Trà Đốc</option>
                <option value="Tra Giap">Trà Giáp</option>
                <option value="Tra Leng">Trà Leng</option>
                <option value="Tra Lien">Trà Liên</option>
                <option value="Tra Linh">Trà Linh</option>
                <option value="Tra My">Trà My</option>
                <option value="Tra Tan">Trà Tân</option>
                <option value="Tra Tap">Trà Tập</option>
                <option value="Tra Van">Trà Vân</option>
                <option value="Vu Gia">Vu Gia</option>
                <option value="Viet An">Việt An</option>
                <option value="Xuan Phu">Xuân Phú</option>
              </select>
            </div>

            <div class="mb-3">
              <label class="form-label">Địa chỉ cụ thể *</label>
              <input
                type="text"
                id="specific"
                class="form-control"
                placeholder="Nhập địa chỉ cụ thể"
              />
              <input type="hidden" th:field="*{address}" id="address" />

              <i class="error text-danger" th:errors="*{address}"></i>
            </div>
            <div class="mb-3">
              <label class="form-label">Ngày giao hàng *</label>
              <input
                type="date"
                th:field="*{deliveryDate}"
                class="form-control"
              />
              <i class="error text-danger" th:errors="*{deliveryDate}"></i>
            </div>

            <div class="mb-3">
              <label class="form-label">Ghi chú / Mô tả thêm</label>
              <textarea
                th:field="*{description}"
                class="form-control"
                rows="3"
                placeholder="Nhập mô tả nếu có"
              ></textarea>
              <i class="error text-danger" th:errors="*{description}"></i>
            </div>
          </th:block>
        </div>
      </div>

      <!-- Cột Đơn hàng -->
      <div class="col-md-5">
        <div class="card p-4 mb-4">
          <h5 class="mb-3 mau">Đơn Hàng Của Bạn</h5>
          <th:block th:each="item : ${cartItems}">
            <div class="d-flex justify-content-between">
              <p th:text="${item.product.name} + ' x ' + ${item.quantity}"></p>
              <span
                th:text="${#numbers.formatDecimal(item.getTotal(), 0, 'COMMA', 0, 'POINT')} + ' VND'"
              ></span>
            </div>
            <input type="hidden" name="cartItemIds" th:value="${item.id}" />
            <hr />
          </th:block>

          <p>
            <span class="formattedOriginalTotal"> </span> <br />

            <span class="formattedDiscount"> </span><br />
            <strong>Số tiền phải thanh toán: </strong>

            <span
              class="float-end"
              th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VND'"
            ></span>
          </p>
        </div>

        <!-- Nút Đặt Hàng gửi form -->
        <button type="submit" class="btn btn-success w-100 mt-3">
          ĐẶT HÀNG
        </button>
      </div>
    </div>
  </form>
  <!-- Áp dụng mã giảm giá -->
  <form action="/order/apply-voucher" method="post" class="mb-3">
    <label for="voucher" class="form-label fw-bold"
      >Mã giảm giá <span class="text-muted">(nếu có)</span></label
    >
    <div class="input-group">
      <input
        type="text"
        id="voucher"
        name="voucher"
        class="form-control"
        placeholder="Nhập mã giảm giá, ví dụ: MA20K"
        required
      />
      <button type="submit" class="btn btn-primary">Áp dụng</button>
    </div>
  </form>
  <div id="voucher-message" class="mt-2"></div>
  <div th:if="${error}" class="alert alert-danger mt-3" role="alert">
    <p th:utext="${error}"></p>
  </div>
  <div th:if="${successApply}" class="alert alert-success mt-3" role="alert">
    <p th:utext="${successApply}"></p>
  </div>

  <script>
    const wardSelect = document.getElementById("ward");
    const specificInput = document.getElementById("specific");
    const addressInput = document.getElementById("address");

    function updateAddress() {
      const ward = wardSelect.selectedOptions[0]?.text || "";
      const specific = specificInput.value.trim();
      if (specific && ward) {
        addressInput.value = `${specific}, ${ward}, Đà Nẵng`;
      }
    }

    // Cập nhật địa chỉ khi người dùng nhập hoặc chọn
    wardSelect.addEventListener("change", updateAddress);
    specificInput.addEventListener("input", updateAddress);

    // Đảm bảo cập nhật trước khi submit
    document.querySelector("form").addEventListener("submit", function () {
      updateAddress();
    });
    // Xử lý áp dụng mã giảm giá
    document
      .querySelector('form[action="/order/apply-voucher"]')
      .addEventListener("submit", function (e) {
        e.preventDefault();

        const voucherInput = document.getElementById("voucher");
        const voucher = voucherInput.value.trim();
        const msgDiv = document.getElementById("voucher-message");

        fetch("/order/apply-voucher", {
          method: "POST",
          headers: {
            "Content-Type": "application/x-www-form-urlencoded",
          },
          body: new URLSearchParams({ voucher }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              msgDiv.className = "alert alert-success mt-3";
              msgDiv.textContent = data.success;

              // Cập nhật tổng cộng
              const totalEl = document.querySelector(".float-end");
              if (totalEl) totalEl.textContent = data.formattedTotal + " VND";
              const originalTotalEl = document.querySelector(
                ".formattedOriginalTotal"
              );
              if (originalTotalEl) {
                originalTotalEl.innerHTML =
                  "<b> Giá gốc: </b> <span class='float-end'>" +
                  data.formattedOriginalTotal +
                  " VND </span>";
              }
              const discountEl = document.querySelector(".formattedDiscount");
              if (discountEl) {
                discountEl.innerHTML =
                  "<b>Giảm giá:</b> <span class='float-end'>" +
                  data.formattedDiscount +
                  " VND</span>";
              }
            } else if (data.error) {
              msgDiv.className = "alert alert-danger mt-3";
              msgDiv.textContent = data.error;
            }
          });
      });
  </script>
</div>
