<head>
  <link rel="stylesheet" th:href="@{/css/nav.css}" />
</head>
<header class="nav-header">
  <div class="nav-container">
    <!-- Logo -->
    <a href="/home" class="logo">
      <img
        th:src="@{/images/2.png}"
        alt="Tr·∫°m Hoa"
        height="100"
        style="text-align: center"
      />
    </a>
    <!-- Navigation links -->
    <nav class="nav-links">
      <a href="/home" class="active">Trang Ch·ªß</a>
      <a href="/services">D·ªãch V·ª•</a>
      <div class="dropdown">
        <a href="#" class="dropdown-category">Danh m·ª•c</a>
        <ul class="dropdown-menu">
          <div class="dropdown-columns">
            <li th:each="proCategory : ${productCategories}">
              <a
                th:href="@{/ProductUser(id=${proCategory.id})}"
                th:text="${proCategory.name}"
                >T√™n danh m·ª•c</a
              >
            </li>
          </div>
        </ul>
      </div>
      <a href="/contact">Li√™n H·ªá</a>
      <a href="/PostUser">B√†i vi·∫øt</a>
    </nav>

    <!-- Search bar -->
    <div class="search-box">
      <form
        th:action="@{/search}"
        method="get"
        class="search-form"
        style="display: flex; gap: 8px; align-items: center; position: relative"
      >
        <input
          type="text"
          name="keyword"
          placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..."
          th:value="${searchKeyword}"
          autocomplete="off"
          id="searchInput"
          style="min-width: 180px"
        />

        <div
          id="search-suggestions"
          class="suggestions-dropdown"
          style="
            position: absolute;
            z-index: 999;
            top: 100%;
            left: 0;
            width: 100%;
          "
        ></div>

        <button type="submit" id="searchBtn">
          <i class="fa-solid fa-magnifying-glass"></i>
        </button>
      </form>
      <!-- Search suggestions dropdown -->
    </div>

    <!-- Icons group: Cart + User -->
    <div class="icons">
      <div class="cart">
        <a href="/cart" style="text-decoration: none">
          üõí
          <span
            id="cart-count"
            class="cart-count"
            th:text="${cartCount != null ? cartCount : 0}"
            >0</span
          ></a
        >
      </div>
      <div class="user-dropdown">
        <div class="user-icon">üë§</div>
        <ul class="dropdown-menu" th:if="${session.user == null}">
          <li>
            <a href="/login" class="btn">ƒêƒÉng nh·∫≠p</a>
          </li>
          <li>
            <a href="/signup" class="btn">ƒêƒÉng k√≠</a>
          </li>
        </ul>
        <ul class="dropdown-menu" th:if="${session.user != null}">
          <!-- n·∫øu role l√† 1 v√† 3 , th√¨ m·ªõi hi·ªÉn th·ªã -->
          <li th:if="${session.user.role == 1 or session.user.role == 3}">
            <a class="dropdown-item" href="/User/index">Qu·∫£n tr·ªã</a>
          </li>
          <li th:if="${session.user.role == 0}">
            <a class="dropdown-item" href="/history">L·ªãch s·ª≠ mua h√†ng</a>
          </li>

          <li><a class="dropdown-item" href="/editProfile">H·ªì s∆°</a></li>
          <li>
            <a class="dropdown-item" href="/changPassword">ƒê·ªïi m·∫≠t kh·∫©u</a>
          </li>

          <li><hr class="dropdown-divider" /></li>
          <li>
            <form action="/logout" method="post">
              <button type="submit" class="dropdown-item text-danger">
                ƒêƒÉng xu·∫•t
              </button>
            </form>
          </li>
        </ul>
      </div>
    </div>
  </div>
</header>

<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- NAV ACTIVE JS ---
    const path = window.location.pathname;
    const navLinks = document.querySelectorAll(
      ".nav-links > a, .nav-links .dropdown-category"
    );
    navLinks.forEach((link) => {
      // X√°c ƒë·ªãnh logic active cho t·ª´ng menu
      if (
        (link.getAttribute("href") === "/home" &&
          (path === "/" || path === "/home")) ||
        (link.getAttribute("href") === "/services" &&
          path.startsWith("/services")) ||
        (link.getAttribute("href") === "/contact" &&
          path.startsWith("/contact")) ||
        (link.getAttribute("href") === "/article" &&
          path.startsWith("/article")) ||
        (link.classList.contains("dropdown-category") &&
          (path.startsWith("/ProductUser") || path.startsWith("/products")))
      ) {
        link.classList.add("active");
      } else {
        link.classList.remove("active");
      }
    });

    const searchForm = document.querySelector(".search-form");
    if (searchForm) {
      searchForm.addEventListener("submit", function (e) {
        const keyword = document.getElementById("searchInput").value.trim();
        if (!keyword) {
          // N·∫øu input tr·ªëng, chuy·ªÉn v·ªÅ trang ch·ªß
          window.location.href = "/home";
          e.preventDefault();
          return false;
        }
        // N·∫øu c√≥ t·ª´ kh√≥a th√¨ cho submit b√¨nh th∆∞·ªùng
      });
    }

    // --- Autocomplete Search Suggestions ---
    const searchInput = document.getElementById("searchInput");
    const suggestionsBox = document.getElementById("search-suggestions");

    searchInput.addEventListener("input", function () {
      const keyword = searchInput.value.trim();
      if (keyword.length < 2) {
        suggestionsBox.style.display = "none";
        return;
      }
      fetch(`/api/search-suggestions?keyword=${encodeURIComponent(keyword)}`)
        .then((res) => res.json())
        .then((data) => {
          console.log(data); // ki·ªÉm tra d·ªØ li·ªáu tr·∫£ v·ªÅ
          if (data.length === 0) {
            suggestionsBox.style.display = "none";
            return;
          }
          suggestionsBox.innerHTML = data
            .map((item) => `<div class="suggestion-item">${item}</div>`)
            .join("");
          suggestionsBox.style.display = "block";
        });
    });

    suggestionsBox.addEventListener("click", function (e) {
      if (e.target.classList.contains("suggestion-item")) {
        searchInput.value = e.target.textContent;
        suggestionsBox.style.display = "none";
        searchInput.form.submit();
      }
    });

    document.addEventListener("click", function (e) {
      if (
        !searchInput.contains(e.target) &&
        !suggestionsBox.contains(e.target)
      ) {
        suggestionsBox.style.display = "none";
      }
    });

    function updateCartCount() {
      fetch("/cart/count")
        .then((response) => response.json())
        .then((count) => {
          document.getElementById("cart-count").textContent = count;
        });
    }
    updateCartCount();
  });
</script>
