<head>
  <link rel="stylesheet" th:href="@{/css/nav.css}" />
</head>
<header class="nav-header">
  <div class="nav-container">
    <!-- Logo -->
    <a href="/home" class="logo">
      <img
        th:src="@{/images/2.png}"
        alt="Tr·∫°m Hoa"
        height="100"
        style="text-align: center"
      />
    </a>
    <!-- Navigation links -->
    <nav class="nav-links">
      <a href="/home" class="active">Trang Ch·ªß</a>
      <a href="/services">D·ªãch V·ª•</a>
      <div class="dropdown">
        <a href="/products" class="dropdown-toggle nav-link">Danh m·ª•c</a>
        <ul class="dropdown-menu">
          <div class="dropdown-columns">
            <li th:each="proCategory : ${productCategories}">
              <a
                th:href="@{/ProductUser(id=${proCategory.id})}"
                th:text="${proCategory.name}"
                >T√™n danh m·ª•c</a
              >
            </li>
          </div>
        </ul>
      </div>
      <a href="/contact">Li√™n H·ªá</a>
      <a href="/PostUser">B√†i vi·∫øt</a>
      <a href="/pos" th:if="${session.user != null and session.user.role == 1}"
        >B√°n h√†ng t·∫°i qu·∫ßy (POS)</a
      >
    </nav>

    <!-- Search bar -->
    <div class="search-box">
      <form
        th:action="@{/search}"
        method="get"
        class="search-form"
        style="display: flex; gap: 8px; align-items: center"
      >
        <input
          type="text"
          name="keyword"
          placeholder="T√¨m ki·∫øm s·∫£n ph·∫©m..."
          th:value="${searchKeyword}"
          autocomplete="off"
          id="searchInput"
          style="min-width: 180px"
        />
        <!-- ƒê√£ lo·∫°i b·ªè select, ch·ªâ c√≤n input t·ª´ kh√≥a -->
        <button type="submit" id="searchBtn">
          <i class="fa-solid fa-magnifying-glass"></i>
        </button>
      </form>
      <!-- Search suggestions dropdown -->
      <div
        class="search-suggestions"
        id="searchSuggestions"
        style="display: none"
      >
        <div class="suggestion-header">
          <i class="fas fa-lightbulb me-2"></i>
          <span>G·ª£i √Ω t√¨m ki·∫øm</span>
        </div>
        <div class="suggestion-list" id="suggestionList">
          <!-- Suggestions will be populated by JavaScript -->
        </div>
      </div>
    </div>

    <!-- Icons group: Cart + User -->
    <div class="icons">
      <div class="cart">
        <a href="/cart"> üõí <span class="cart-count">3</span></a>
      </div>
      <div class="user-dropdown">
        <div class="user-icon">üë§</div>
        <ul class="dropdown-menu" th:if="${session.user == null}">
          <li>
            <a href="/login" class="btn">ƒêƒÉng nh·∫≠p</a>
          </li>
          <li>
            <a href="/signup" class="btn">ƒêƒÉng k√≠</a>
          </li>
        </ul>
        <ul class="dropdown-menu" th:if="${session.user != null}">
          <li th:if="${session.user.role}">
            <a class="dropdown-item" href="/User/index">Qu·∫£n tr·ªã</a>
          </li>
          <li>
            <a class="dropdown-item" href="/history">L·ªãch s·ª≠ mua h√†ng</a>
          </li>

          <li><a class="dropdown-item" href="/editProfile">H·ªì s∆°</a></li>
          <li>
            <a class="dropdown-item" href="/changPassword">ƒê·ªïi m·∫≠t kh·∫©u</a>
          </li>

          <li><hr class="dropdown-divider" /></li>
          <li>
            <a class="dropdown-item text-danger" href="/logout">ƒêƒÉng xu·∫•t</a>
          </li>
        </ul>
      </div>
    </div>
  </div>
</header>

<!-- Search JavaScript & Active nav JS -->
<script>
  document.addEventListener("DOMContentLoaded", function () {
    // --- NAV ACTIVE JS ---
    const path = window.location.pathname;
    const navLinks = document.querySelectorAll(
      ".nav-links > a, .nav-links .dropdown-toggle"
    );
    navLinks.forEach((link) => {
      // X√°c ƒë·ªãnh logic active cho t·ª´ng menu
      if (
        (link.getAttribute("href") === "/home" &&
          (path === "/" || path === "/home")) ||
        (link.getAttribute("href") === "/services" &&
          path.startsWith("/services")) ||
        (link.getAttribute("href") === "/products" &&
          (path.startsWith("/products") || path.startsWith("/ProductUser"))) ||
        (link.getAttribute("href") === "/contact" &&
          path.startsWith("/contact")) ||
        (link.getAttribute("href") === "/article" &&
          path.startsWith("/article")) ||
        (link.getAttribute("href") === "/pos" && path.startsWith("/pos"))
      ) {
        link.classList.add("active");
      } else {
        link.classList.remove("active");
      }
    });

    // --- SEARCH JS gi·ªØ nguy√™n ---
    const searchInput = document.getElementById("searchInput");
    const searchSuggestions = document.getElementById("searchSuggestions");
    const suggestionList = document.getElementById("suggestionList");
    const searchBtn = document.getElementById("searchBtn");
    const commonSuggestions = [
      "B√≥ hoa t∆∞∆°i",
      "Gi·ªè hoa t∆∞∆°i",
      "L√£ng hoa",
      "Hoa c∆∞·ªõi",
      "Hoa sinh nh·∫≠t",
      "Hoa khai tr∆∞∆°ng",
      "Hoa chia bu·ªìn",
      "Hoa h·ªìng",
      "Hoa lan",
      "Hoa c√∫c",
    ];
    let searchTimeout;
    searchInput.addEventListener("focus", function () {
      if (this.value.trim() === "") {
        showSuggestions(commonSuggestions);
      }
    });
    searchInput.addEventListener("input", function () {
      clearTimeout(searchTimeout);
      const query = this.value.trim();
      if (query.length === 0) {
        showSuggestions(commonSuggestions);
        return;
      }
      if (query.length < 2) {
        hideSuggestions();
        return;
      }
      searchTimeout = setTimeout(() => {
        const filteredSuggestions = commonSuggestions.filter((suggestion) =>
          suggestion.toLowerCase().includes(query.toLowerCase())
        );
        if (filteredSuggestions.length > 0) {
          showSuggestions(filteredSuggestions);
        } else {
          hideSuggestions();
        }
      }, 300);
    });
    suggestionList.addEventListener("click", function (e) {
      if (e.target.classList.contains("suggestion-item")) {
        searchInput.value = e.target.textContent;
        hideSuggestions();
        searchInput.focus();
      }
    });
    document.addEventListener("click", function (e) {
      if (
        !searchInput.contains(e.target) &&
        !searchSuggestions.contains(e.target)
      ) {
        hideSuggestions();
      }
    });
    searchInput.addEventListener("keydown", function (e) {
      if (e.key === "Enter") {
        e.preventDefault();
        if (this.value.trim() !== "") {
          this.closest("form").submit();
        }
      }
    });
    function showSuggestions(suggestions) {
      suggestionList.innerHTML = "";
      suggestions.forEach((suggestion) => {
        const item = document.createElement("div");
        item.className = "suggestion-item";
        item.textContent = suggestion;
        suggestionList.appendChild(item);
      });
      searchSuggestions.style.display = "block";
    }
    function hideSuggestions() {
      searchSuggestions.style.display = "none";
    }
    searchBtn.addEventListener("click", function () {
      if (searchInput.value.trim() !== "") {
        this.innerHTML = '<i class="fas fa-spinner fa-spin"></i>';
        setTimeout(() => {
          this.innerHTML = '<i class="fa-solid fa-magnifying-glass"></i>';
        }, 1000);
      }
    });
  });
</script>
