<!DOCTYPE html>
<html lang="vi" xmlns:th="http://www.thymeleaf.org">
  <head>
    <title>Dịch Vụ - Cửa Hàng Hoa</title>
    <link rel="stylesheet" th:href="@{/css/service.css}" />
    <!-- Bootstrap CSS -->
    <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/css/bootstrap.min.css" rel="stylesheet">
    <!-- Animate.css for smooth animations -->
    <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/animate.css/4.1.1/animate.min.css">
    <!-- AOS CSS -->
    <link href="https://unpkg.com/aos@2.3.4/dist/aos.css" rel="stylesheet">
  </head>
  <body>
    <!-- Hero Section -->
    <section class="hero-section">
      <div class="hero-overlay"></div>
      <div class="flower-particles" id="flower-particles"></div>
      <div class="hero-content">
        <h1 data-aos="fade-down">Dịch Vụ Hoa Tươi Lãng Mạn</h1>
        <p data-aos="fade-up" data-aos-delay="200">
          Tạo nên những khoảnh khắc đáng nhớ với những thiết kế hoa tinh tế
        </p>
        <a
          href="#services"
          class="btn btn-primary"
          data-aos="fade-up"
          data-aos-delay="400"
          >Khám Phá Ngay</a
        >
      </div>
    </section>
    <section id="services" class="services-section">
      <div class="container">
        <h2 data-aos="fade-up">Các Dịch Vụ Đặc Biệt</h2>
        <div
          th:each="service, iterStat : ${services}"
          th:class="'service-block ' + (${iterStat.index % 2 == 1} ? 'flex-row-reverse' : '')"
          data-aos="fade-up"
          th:attr="data-aos-delay=${iterStat.index * 200}"
        >
          <div class="service-text">
            <h2 class="display-5 fw-bold mb-4" th:text="${service.name}">
              Tên dịch vụ
            </h2>
            <p class="mb-4" th:text="${service.description}">Mô tả dịch vụ</p>
          </div>
          <div
            class="service-slideshow"
            th:classappend="${iterStat.index % 2 == 0} ? ' first-block' : ' second-block'"
          >
            <div
              th:id="'carousel' + ${service.id}"
              class="carousel slide"
              data-bs-ride="carousel"
            >
              <div class="carousel-inner">
                <div class="carousel-item active" th:if="${service.image_url}">
                  <img
                    th:src="@{/images/{image}(image=${service.image_url})}"
                    alt="Ảnh 1"
                  />
                </div>
                <div class="carousel-item" th:if="${service.image_url2}">
                  <img
                    th:src="@{/images/{image}(image=${service.image_url2})}"
                    alt="Ảnh 2"
                  />
                </div>
                <div class="carousel-item" th:if="${service.image_url3}">
                  <img
                    th:src="@{/images/{image}(image=${service.image_url3})}"
                    alt="Ảnh 3"
                  />
                </div>
              </div>
              <button
                class="carousel-control-prev"
                type="button"
                th:attr="data-bs-target='#carousel' + ${service.id}"
                data-bs-slide="prev"
              >
                <span
                  class="carousel-control-prev-icon"
                  aria-hidden="true"
                ></span>
                <span class="visually-hidden">Previous</span>
              </button>
              <button
                class="carousel-control-next"
                type="button"
                th:attr="data-bs-target='#carousel' + ${service.id}"
                data-bs-slide="next"
              >
                <span
                  class="carousel-control-next-icon"
                  aria-hidden="true"
                ></span>
                <span class="visually-hidden">Next</span>
              </button>
            </div>
          </div>
        </div>

        <!-- PHÂN TRANG ĐƠN GIẢN VÀ ĐẸP -->
        <nav class="mt-5 d-flex justify-content-center" th:if="${totalPages > 1}" data-aos="fade-up">
          <ul class="pagination pagination-elegant">
            <!-- Previous Button -->
            <li class="page-item" th:classappend="${currentPage == 0} ? 'disabled'">
              <a class="page-link" 
                 th:href="@{'/services'(page=${currentPage - 1})}"
                 aria-label="Previous">
                <span><i class="fas fa-chevron-left"></i></span>
              </a>
            </li>

            <!-- Pages around current page -->
            <li class="page-item" 
                th:each="pageNum : ${#numbers.sequence(T(java.lang.Math).max(0, currentPage - 2), T(java.lang.Math).min(totalPages - 1, currentPage + 2))}"
                th:classappend="${pageNum == currentPage} ? 'active'">
              <a class="page-link" 
                 th:href="@{'/services'(page=${pageNum})}"
                 th:text="${pageNum + 1}">1</a>
            </li>

            <!-- Next Button -->
            <li class="page-item" th:classappend="${currentPage + 1 >= totalPages} ? 'disabled'">
              <a class="page-link" 
                 th:href="@{'/services'(page=${currentPage + 1})}"
                 aria-label="Next">
                <span><i class="fas fa-chevron-right"></i></span>
              </a>
            </li>
          </ul>
        </nav>
      </div>
    </section>

    <!-- Contact Form Section -->
    <section class="contact-section">
      <div class="container">
        <h2 data-aos="fade-up">Đặt Dịch Vụ Ngay</h2>
        

        <form
          id="contact-form"
          th:action="@{/services/contact}"
          th:object="${serviceRequest}"
          method="post"
        >
          <div class="row">
            <!-- Họ và tên -->
            <div class="col-md-6 mb-4" data-aos="fade-right">
              <label for="fullName" class="form-label">Họ và Tên</label>
              <input
                type="text"
                class="form-control"
                th:field="*{fullName}"
                placeholder="Nhập họ và tên của bạn"
                readonly
              />
              <div
                class="text-danger small"
                th:if="${#fields.hasErrors('fullName')}"
                th:errors="*{fullName}"
              ></div>
            </div>

            <!-- Email -->
            <div class="col-md-6 mb-4" data-aos="fade-left">
              <label for="email" class="form-label">Email</label>
              <input
                type="email"
                class="form-control"
                th:field="*{email}"
                placeholder="example@email.com"
                readonly
              />
              <div
                class="text-danger small"
                th:if="${#fields.hasErrors('email')}"
                th:errors="*{email}"
              ></div>
            </div>

            <!-- Số điện thoại -->
            <div class="col-md-6 mb-4" data-aos="fade-right">
              <label for="phone" class="form-label">Số Điện Thoại</label>
              <input
                type="text"
                class="form-control"
                th:field="*{phone}"
                placeholder="Nhập số điện thoại"
                readonly
              />
              <div
                class="text-danger small"
                th:if="${#fields.hasErrors('phone')}"
                th:errors="*{phone}"
              ></div>
            </div>

            <!-- Chọn dịch vụ -->
            <div class="col-md-6 mb-4" data-aos="fade-left">
              <label for="service" class="form-label">Chọn Dịch Vụ</label>
              <select class="form-select" th:field="*{service}">
                <option value="">-- Chọn dịch vụ --</option>
                <option
                  th:each="s : ${activeServices}"
                  th:value="${s.id}"
                  th:text="${s.name}"
                ></option>
              </select>
              <div
                class="text-danger small"
                th:if="${#fields.hasErrors('service')}"
                th:errors="*{service}"
              ></div>
            </div>

            <!-- Nút gửi -->
            <div
              class="col-12 text-center"
              data-aos="fade-up"
              data-aos-delay="300"
            >
              <button type="submit" class="btn btn-submit" id="submitBtn">
                <span class="btn-text">Gửi Yêu Cầu</span>
                <i class="fas fa-paper-plane ms-2"></i>
              </button>
            </div>
          </div>
        </form>
      </div>
    </section>

    <!-- FontAwesome for icons -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.0.0/js/all.min.js"></script>
    <!-- Bootstrap JS -->
    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.3/dist/js/bootstrap.bundle.min.js"></script>
    <!-- AOS JS -->
    <script src="https://unpkg.com/aos@2.3.4/dist/aos.js"></script>
    
    <script>
      // Initialize AOS
      AOS.init({
        duration: 800,
        once: true,
        offset: 100
      });

      document.addEventListener("DOMContentLoaded", function () {
        const form = document.getElementById("contact-form");
        const submitBtn = document.getElementById("submitBtn");

        form.addEventListener("submit", function (e) {
          e.preventDefault(); // Ngăn reload trang

          // Kiểm tra đăng nhập trước
          const fullNameInput = form.querySelector('input[name="fullName"]');
          const emailInput = form.querySelector('input[name="email"]');
          const phoneInput = form.querySelector('input[name="phone"]');
          
          // Nếu các trường thông tin cá nhân trống, có thể chưa đăng nhập
          if (!fullNameInput || !fullNameInput.value.trim() || 
              !emailInput || !emailInput.value.trim() || 
              !phoneInput || !phoneInput.value.trim()) {
            showErrorToast("🔐 Vui lòng đăng nhập để sử dụng dịch vụ!");
            setTimeout(() => {
              window.location.href = "/login?redirect=/services&loginRequired=true";
            }, 2000);
            return;
          }

          // Kiểm tra validation dịch vụ
          const serviceSelect = form.querySelector('select[name="service"]');
          if (!serviceSelect || !serviceSelect.value) {
            showErrorToast("⚠️ Vui lòng chọn dịch vụ trước khi gửi yêu cầu!");
            if (serviceSelect) serviceSelect.focus();
            return;
          }

          // Chỉ disable nút để tránh double click
          submitBtn.disabled = true;
          
          const formData = new FormData(form);

          fetch(form.action, {
            method: "POST",
            body: formData,
          })
            .then((response) => {
              // Kiểm tra nếu server redirect đến login
              if (response.url.includes('/login')) {
                showErrorToast("🔐 Vui lòng đăng nhập để sử dụng dịch vụ!");
                setTimeout(() => {
                  window.location.href = "/login?redirect=/services&loginRequired=true";
                }, 2000);
                return;
              }
              
              if (!response.ok) {
                throw new Error(`HTTP ${response.status}: ${response.statusText}`);
              }
              return response.text();
            })
            .then((data) => {
              if (data) { // Chỉ xử lý nếu có data (không phải redirect)
                // Hiển thị thông báo thành công
                showSuccessToast(
                  "🌸 Cảm ơn bạn đã đặt dịch vụ! Chúng tôi sẽ liên hệ với bạn trong thời gian sớm nhất."
                );
                
                // Reset form nhưng giữ lại thông tin người dùng
                resetFormKeepUserInfo();
                
                // Scroll to form để người dùng thấy form đã reset
                form.scrollIntoView({ behavior: 'smooth', block: 'center' });
              }
            })
            .catch((error) => {
              console.error("Error occurred:", error);
              showErrorToast(
                "❌ Đã xảy ra lỗi khi gửi yêu cầu. Vui lòng thử lại!"
              );
            })
            .finally(() => {
              // Luôn enable lại nút
              submitBtn.disabled = false;
            });
        });

        function resetFormKeepUserInfo() {
          // Chỉ reset dropdown dịch vụ, giữ lại thông tin cá nhân
          const serviceSelect = form.querySelector('select[name="service"]');
          if (serviceSelect) {
            serviceSelect.value = "";
          }
        }

        function showSuccessToast(message) {
          console.log("Showing success toast:", message); // Debug
          const toastHtml = `
            <div class="toast toast-elegant toast-success show" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="toast-progress"></div>
              <div class="toast-content">
                <div class="toast-icon">
                  <i class="fas fa-check-circle"></i>
                </div>
                <div class="toast-message">${message}</div>
                <button type="button" class="toast-close" aria-label="Close">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          `;
          showToast(toastHtml);
        }

        function showErrorToast(message) {
          console.log("Showing error toast:", message); // Debug
          const toastHtml = `
            <div class="toast toast-elegant toast-error show" role="alert" aria-live="assertive" aria-atomic="true">
              <div class="toast-progress"></div>
              <div class="toast-content">
                <div class="toast-icon">
                  <i class="fas fa-exclamation-circle"></i>
                </div>
                <div class="toast-message">${message}</div>
                <button type="button" class="toast-close" aria-label="Close">
                  <i class="fas fa-times"></i>
                </button>
              </div>
            </div>
          `;
          showToast(toastHtml);
        }

        function showToast(toastHtml) {
          console.log("Creating toast"); // Debug
          
          // Xóa toast cũ nếu có
          const existingContainer = document.getElementById("customToastContainer");
          if (existingContainer) {
            existingContainer.remove();
          }

          // Tạo container mới
          const container = document.createElement("div");
          container.id = "customToastContainer";
          document.body.appendChild(container);

          container.innerHTML = toastHtml;
          const toastElement = container.querySelector(".toast");
          const progressBar = toastElement.querySelector(".toast-progress");

          console.log("Toast element created:", toastElement); // Debug

          // Thêm hiệu ứng vào
          toastElement.classList.add("animate__animated", "animate__slideInRight");

          // Animate progress bar
          setTimeout(() => {
            if (progressBar) {
              progressBar.style.width = "0%";
            }
          }, 100);

          // Xử lý sự kiện đóng toast
          const closeBtn = toastElement.querySelector(".toast-close");
          if (closeBtn) {
            closeBtn.addEventListener("click", (e) => {
              console.log("Close button clicked"); // Debug
              e.preventDefault();
              e.stopPropagation();
              hideToast();
            });
          }

          // Hàm ẩn toast
          function hideToast() {
            console.log("Hiding toast"); // Debug
            toastElement.classList.remove("animate__slideInRight");
            toastElement.classList.add("animate__slideOutRight");
            
            setTimeout(() => {
              if (container && container.parentNode) {
                container.remove();
                console.log("Toast removed"); // Debug
              }
            }, 500);
          }

          // Auto hide sau 5 giây
          setTimeout(() => {
            if (container && container.parentNode) {
              hideToast();
            }
          }, 5000);
        }

        // Smooth scroll cho pagination
        document.querySelectorAll('.pagination a').forEach(link => {
          link.addEventListener('click', function(e) {
            e.preventDefault();
            const href = this.getAttribute('href');
            
            // Thêm hiệu ứng loading cho pagination
            document.body.style.opacity = '0.7';
            
            setTimeout(() => {
              window.location.href = href;
            }, 200);
          });
        });
      });
    </script>
    
    <script th:src="@{/js/service.js}"></script>
  </body>
</html>
