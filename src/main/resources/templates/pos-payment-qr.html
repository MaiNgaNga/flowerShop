<link rel="stylesheet" th:href="@{/css/pos.css}" />

<!-- POS Payment QR Page Identifier -->
<div id="pos-payment-qr-page" style="display: none">pos-payment-qr</div>

<div class="container-fluid" style="padding: 0; margin: 0">
  <div class="row" style="height: 100vh; margin: 0">
    <!-- QR Code Display - Left Side -->
    <div
      class="col-md-8 d-flex align-items-center justify-content-center"
      style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%)"
    >
      <div class="text-center">
        <div
          class="card shadow-lg border-0"
          style="max-width: 600px; border-radius: 20px"
        >
          <div
            class="card-header text-white text-center"
            style="
              background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
              border-radius: 20px 20px 0 0;
            "
          >
            <h2 class="mb-0">
              <i class="fas fa-qrcode"></i>
              Qu√©t m√£ QR ƒë·ªÉ thanh to√°n
            </h2>
          </div>
          <div class="card-body p-5">
            <!-- QR Code -->
            <div class="text-center mb-4">
              <img
                th:src="${qrCodePath}"
                alt="QR Code thanh to√°n"
                class="img-fluid border rounded-3 shadow"
                style="
                  max-width: 400px;
                  max-height: 400px;
                  border: 5px solid #f8f9fa !important;
                "
                onerror="console.error('QR Code load failed:', this.src); this.style.display='none'; this.nextElementSibling.style.display='block';"
              />
              <!-- Fallback if QR fails to load -->
              <div
                id="qr-fallback"
                style="display: none"
                class="alert alert-warning"
              >
                <p>Kh√¥ng th·ªÉ t·∫£i QR Code</p>
                <p>
                  <strong>ƒê∆∞·ªùng d·∫´n:</strong>
                  <span th:text="${qrCodePath}"></span>
                </p>
                <a
                  th:href="${qrCodePath}"
                  target="_blank"
                  class="btn btn-sm btn-primary"
                  >Xem QR tr·ª±c ti·∫øp</a
                >
              </div>
            </div>

            <!-- Payment Info -->
            <div class="row text-center mb-4">
              <div class="col-6">
                <div class="p-3 bg-light rounded-3">
                  <strong class="text-muted">M√£ ƒë∆°n:</strong><br />
                  <span class="text-primary h5" th:text="${orderCode}"></span>
                </div>
              </div>
              <div class="col-6">
                <div class="p-3 bg-light rounded-3">
                  <strong class="text-muted">S·ªë ti·ªÅn:</strong><br />
                  <span
                    class="text-danger h4"
                    th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'"
                  >
                  </span>
                </div>
              </div>
            </div>

            <!-- Bank Info -->
            <div class="alert alert-info" th:if="${bankInfo}">
              <strong><i class="fas fa-university"></i> Th√¥ng tin NH:</strong
              ><br />
              <span th:text="${bankInfo}"></span>
            </div>

            <!-- Instructions -->
            <div class="card bg-light">
              <div class="card-body">
                <h6 class="card-title">
                  <i class="fas fa-mobile-alt"></i>
                  H∆∞·ªõng d·∫´n thanh to√°n:
                </h6>
                <ol class="mb-0 small">
                  <li>M·ªü ·ª©ng d·ª•ng ng√¢n h√†ng tr√™n ƒëi·ªán tho·∫°i</li>
                  <li>Ch·ªçn ch·ª©c nƒÉng "Qu√©t QR" ho·∫∑c "Chuy·ªÉn kho·∫£n QR"</li>
                  <li>Qu√©t m√£ QR tr√™n m√†n h√¨nh</li>
                  <li>X√°c nh·∫≠n th√¥ng tin v√† ho√†n t·∫•t thanh to√°n</li>
                </ol>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>

    <!-- Control Panel - Right Side -->
    <div class="col-md-4 bg-white border-start" style="padding: 0">
      <div class="p-4 h-100 d-flex flex-column">
        <!-- Header -->
        <div class="text-center mb-4 pb-3 border-bottom">
          <h3 class="text-primary">
            <i class="fas fa-cash-register"></i>
            POS System
          </h3>
          <small class="text-muted">Qu·∫£n l√Ω thanh to√°n</small>
        </div>

        <!-- Order Summary -->
        <div class="card mb-4 flex-grow-1">
          <div class="card-header bg-success text-white">
            <h6 class="mb-0">
              <i class="fas fa-receipt"></i>
              Chi ti·∫øt ƒë∆°n h√†ng
            </h6>
          </div>
          <div class="card-body" style="max-height: 300px; overflow-y: auto">
            <div class="mb-3" th:if="${customerName}">
              <strong>üë§ Kh√°ch h√†ng:</strong>
              <span th:text="${customerName}" class="text-primary"></span>
            </div>

            <div class="table-responsive">
              <table class="table table-sm table-striped">
                <thead class="table-light">
                  <tr>
                    <th>S·∫£n ph·∫©m</th>
                    <th>SL</th>
                    <th>Gi√°</th>
                  </tr>
                </thead>
                <tbody>
                  <tr th:each="detail : ${orderDetails}">
                    <td>
                      <small th:text="${detail.product.name}"></small>
                    </td>
                    <td class="text-center" th:text="${detail.quantity}"></td>
                    <td class="text-end">
                      <small
                        th:text="${#numbers.formatDecimal(detail.price * detail.quantity, 0, 'COMMA', 0, 'POINT')}"
                      ></small>
                    </td>
                  </tr>
                </tbody>
                <tfoot class="table-success">
                  <tr>
                    <th colspan="2">üí∞ T·ªïng:</th>
                    <th
                      class="text-end"
                      th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'"
                    ></th>
                  </tr>
                </tfoot>
              </table>
            </div>
          </div>
        </div>

        <!-- Status & Countdown -->
        <div class="card mb-4">
          <div class="card-body text-center">
            <div class="mb-3">
              <h4 class="text-warning">
                <i class="fas fa-clock"></i>
                <span id="countdown">15:00</span>
              </h4>
              <small class="text-muted">Th·ªùi gian ch·ªù thanh to√°n</small>
            </div>

            <div id="statusAlert" class="alert alert-warning">
              <i class="fas fa-hourglass-half"></i>
              ƒêang ch·ªù kh√°ch h√†ng thanh to√°n...
            </div>

            <!-- Progress Bar -->
            <div class="progress" style="height: 10px">
              <div
                id="progressBar"
                class="progress-bar progress-bar-striped progress-bar-animated bg-warning"
                role="progressbar"
                style="width: 100%"
              ></div>
            </div>
          </div>
        </div>

        <!-- Action Buttons -->
        <div class="d-grid gap-2">
          <button class="btn btn-success btn-lg" id="checkPaymentBtn">
            <i class="fas fa-sync"></i>
            Ki·ªÉm tra thanh to√°n
          </button>

          <button class="btn btn-info" id="printQRBtn">
            <i class="fas fa-print"></i>
            In m√£ QR
          </button>

          <button class="btn btn-warning" onclick="window.location.reload()">
            <i class="fas fa-redo"></i>
            L√†m m·ªõi QR
          </button>

          <a href="/pos" class="btn btn-outline-danger">
            <i class="fas fa-times"></i>
            H·ªßy & Quay l·∫°i POS
          </a>
        </div>
      </div>
    </div>
  </div>
</div>

<script>
  // Countdown Timer (15 minutes)
  let timeLeft = 15 * 60;
  let totalTime = 15 * 60;

  function updateCountdown() {
    const minutes = Math.floor(timeLeft / 60);
    const seconds = timeLeft % 60;
    document.getElementById("countdown").textContent = `${minutes
      .toString()
      .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

    // Update progress bar
    const progressBar = document.getElementById("progressBar");
    const percentage = (timeLeft / totalTime) * 100;
    progressBar.style.width = percentage + "%";

    if (percentage < 30) {
      progressBar.className =
        "progress-bar progress-bar-striped progress-bar-animated bg-danger";
    } else if (percentage < 60) {
      progressBar.className =
        "progress-bar progress-bar-striped progress-bar-animated bg-warning";
    }

    if (timeLeft <= 0) {
      alert("‚è∞ H·∫øt th·ªùi gian thanh to√°n! ƒê∆°n h√†ng s·∫Ω b·ªã h·ªßy.");
      window.location.href = "/pos?error=timeout";
      return;
    }
    timeLeft--;
  }

  // Start countdown
  setInterval(updateCountdown, 1000);

  // Check payment status
  document
    .getElementById("checkPaymentBtn")
    .addEventListener("click", function () {
      const btn = this;
      const originalText = btn.innerHTML;
      btn.disabled = true;
      btn.innerHTML = '<i class="fas fa-spinner fa-spin"></i> ƒêang ki·ªÉm tra...';

      // Simulate API call to check payment
      setTimeout(() => {
        // For demo - randomly succeed after a few checks
        if (Math.random() > 0.7) {
          document.getElementById("statusAlert").innerHTML =
            '<i class="fas fa-check-circle"></i> ‚úÖ Thanh to√°n th√†nh c√¥ng!';
          document.getElementById("statusAlert").className =
            "alert alert-success";

          // Play success sound (if available)
          try {
            new Audio("/sounds/success.mp3").play();
          } catch (e) {}

          setTimeout(() => {
            alert("üéâ Thanh to√°n th√†nh c√¥ng! ƒê∆°n h√†ng ƒë√£ ƒë∆∞·ª£c x·ª≠ l√Ω.");
            window.location.href = "/pos?success=payment_completed";
          }, 2000);
        } else {
          btn.disabled = false;
          btn.innerHTML = originalText;

          // Show temporary message
          const tempAlert = document.createElement("div");
          tempAlert.className = "alert alert-warning mt-2";
          tempAlert.innerHTML =
            "<small>‚è≥ Ch∆∞a nh·∫≠n ƒë∆∞·ª£c thanh to√°n. Vui l√≤ng th·ª≠ l·∫°i.</small>";
          btn.parentNode.appendChild(tempAlert);

          setTimeout(() => {
            tempAlert.remove();
          }, 3000);
        }
      }, 1500);
    });

  // Print QR Code
  document.getElementById("printQRBtn").addEventListener("click", function () {
    // Create print window
    const printWindow = window.open("", "_blank");
    const qrImage = document.querySelector('img[alt="QR Code thanh to√°n"]');
    const orderCode = "[[${orderCode}]]";
    const totalAmount = "[[${totalAmount}]]";

    printWindow.document.write(`
        <html>
        <head>
            <title>In m√£ QR - ${orderCode}</title>
            <style>
                body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
                .qr-container { border: 2px solid #333; padding: 20px; margin: 20px auto; max-width: 400px; }
                img { max-width: 300px; margin: 20px 0; }
                .info { margin: 10px 0; font-size: 14px; }
                .total { font-size: 18px; font-weight: bold; color: #d9534f; }
            </style>
        </head>
        <body>
            <div class="qr-container">
                <h2>üå∏ C·ª≠a H√†ng Hoa</h2>
                <div class="info">M√£ ƒë∆°n h√†ng: <strong>${orderCode}</strong></div>
                <img src="${qrImage.src}" alt="QR Code">
                <div class="total">T·ªïng ti·ªÅn: ${new Intl.NumberFormat(
                  "vi-VN"
                ).format(totalAmount)} VNƒê</div>
                <div class="info">Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</div>
                <div class="info"><small>C·∫£m ∆°n qu√Ω kh√°ch!</small></div>
            </div>
        </body>
        </html>
    `);

    printWindow.document.close();
    printWindow.print();
  });

  // Auto check payment every 20 seconds
  setInterval(() => {
    const orderCode = "[[${orderCode}]]";
    console.log("Checking payment status for order:", orderCode);

    // Silent check for payment status
    fetch("/pos/check-payment-status", {
      method: "POST",
      headers: { "Content-Type": "application/json" },
      body: JSON.stringify({ orderCode: orderCode }),
    })
      .then((response) => response.json())
      .then((data) => {
        console.log("Payment status response:", data);
        if (data.success && data.status === "ƒê√£ thanh to√°n") {
          document.getElementById("statusAlert").innerHTML =
            '<i class="fas fa-check-circle"></i> ‚úÖ Thanh to√°n th√†nh c√¥ng!';
          document.getElementById("statusAlert").className =
            "alert alert-success";

          setTimeout(() => {
            window.location.href = "/pos?success=payment_completed";
          }, 2000);
        }
      })
      .catch((error) => {
        console.log("Auto-check error:", error);
      });
  }, 20000);

  // Prevent page refresh accidentally
  window.addEventListener("beforeunload", function (e) {
    e.preventDefault();
    e.returnValue =
      "B·∫°n c√≥ ch·∫Øc mu·ªën r·ªùi kh·ªèi trang? Giao d·ªãch ƒëang ch·ªù thanh to√°n.";
  });
</script>

<style>
  /* Custom styles for QR payment page */
  .card {
    transition: all 0.3s ease;
  }

  .card:hover {
    transform: translateY(-2px);
    box-shadow: 0 8px 25px rgba(0, 0, 0, 0.15) !important;
  }

  .progress {
    border-radius: 10px;
    background-color: #e9ecef;
  }

  .progress-bar {
    border-radius: 10px;
  }

  @media print {
    .col-md-4 {
      display: none !important;
    }
    .col-md-8 {
      width: 100% !important;
    }
    body {
      background: white !important;
    }
  }

  @media (max-width: 768px) {
    .row {
      height: auto !important;
    }
    .col-md-8,
    .col-md-4 {
      width: 100% !important;
    }
  }
</style>
