<link rel="stylesheet" th:href="@{/css/pos-payment-qr.css}" />

<div class="qr-main-container">
  <div class="qr-left">
    <div class="qr-title">
      <i class="fas fa-qrcode"></i> Qu√©t m√£ QR ƒë·ªÉ thanh to√°n
    </div>
    <img
      th:src="${qrCodePath}"
      alt="QR Code thanh to√°n"
      class="qr-img"
      onerror="console.error('QR Code load failed:', this.src); this.style.display='none'; this.nextElementSibling.style.display='block';"
    />
    <div
      id="qr-fallback"
      style="display: none; color: #b91c1c; text-align: center"
    >
      <p>Kh√¥ng th·ªÉ t·∫£i QR Code</p>
      <p><strong>ƒê∆∞·ªùng d·∫´n:</strong> <span th:text="${qrCodePath}"></span></p>
      <a th:href="${qrCodePath}" target="_blank" class="btn btn-sm btn-primary"
        >Xem QR tr·ª±c ti·∫øp</a
      >
    </div>
    <div class="qr-order-info">
      <div class="info-block">
        <div class="info-label">M√£ ƒë∆°n</div>
        <div class="info-value" th:text="${orderCode}"></div>
      </div>
      <div class="info-block">
        <div class="info-label">S·ªë ti·ªÅn</div>
        <div
          class="info-value text-danger"
          th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'"
        ></div>
      </div>
    </div>
    <div class="qr-bank-info" th:if="${bankInfo}">
      <strong><i class="fas fa-university"></i> Th√¥ng tin NH:</strong>
      <span th:text="${bankInfo}"></span>
    </div>
    <div class="qr-instructions">
      <h6><i class="fas fa-mobile-alt"></i> H∆∞·ªõng d·∫´n thanh to√°n:</h6>
      <ol>
        <li>M·ªü ·ª©ng d·ª•ng ng√¢n h√†ng tr√™n ƒëi·ªán tho·∫°i</li>
        <li>Ch·ªçn ch·ª©c nƒÉng "Qu√©t QR" ho·∫∑c "Chuy·ªÉn kho·∫£n QR"</li>
        <li>Qu√©t m√£ QR tr√™n m√†n h√¨nh</li>
        <li>X√°c nh·∫≠n th√¥ng tin v√† ho√†n t·∫•t thanh to√°n</li>
      </ol>
    </div>
  </div>
  <div class="qr-right">
    <div class="qr-summary-title">
      <i class="fas fa-cash-register"></i> Chi ti·∫øt ƒë∆°n h√†ng
    </div>
    <div style="max-height: 220px; overflow-y: auto; margin-bottom: 10px">
      <table class="table qr-summary-table">
        <thead>
          <tr>
            <th>S·∫£n ph·∫©m</th>
            <th>SL</th>
            <th>Gi√°</th>
          </tr>
        </thead>
        <tbody>
          <tr th:each="detail : ${orderDetails}">
            <td><small th:text="${detail.product.name}"></small></td>
            <td class="text-center" th:text="${detail.quantity}"></td>
            <td class="text-end">
              <small
                th:text="${#numbers.formatDecimal(detail.price * detail.quantity, 0, 'COMMA', 0, 'POINT')}"
              ></small>
            </td>
          </tr>
        </tbody>
        <tfoot>
          <tr>
            <th colspan="2">üí∞ T·ªïng:</th>
            <th
              class="text-end"
              th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'"
            ></th>
          </tr>
        </tfoot>
      </table>
    </div>
    <div class="qr-countdown">
      <span id="countdown">15:00</span>
      <div style="font-size: 0.95em; color: #888">Th·ªùi gian ch·ªù thanh to√°n</div>
      <div class="progress" style="height: 8px; margin-top: 6px">
        <div
          id="progressBar"
          class="progress-bar progress-bar-striped progress-bar-animated bg-warning"
          role="progressbar"
          style="width: 100%"
        ></div>
      </div>
    </div>
    <div id="statusAlert" class="qr-status alert alert-warning">
      <i class="fas fa-hourglass-half"></i> ƒêang ch·ªù kh√°ch h√†ng thanh to√°n...
    </div>
    <div class="qr-actions">
      <button class="btn btn-success" id="manualConfirmBtn">
        <i class="fas fa-check"></i> X√°c nh·∫≠n ƒë√£ thanh to√°n
      </button>
      <button class="btn btn-info" id="printQRBtn">
        <i class="fas fa-print"></i> In m√£ QR
      </button>
      <button
        class="btn btn-warning"
        id="refreshQRBtn"
        type="button"
        th:attr="data-ordercode=${orderCode}"
      >
        <i class="fas fa-redo"></i> L√†m m·ªõi QR
      </button>
      <a href="/pos" class="btn btn-outline-danger">
        <i class="fas fa-times"></i> H·ªßy & Quay l·∫°i POS
      </a>
    </div>
  </div>
</div>

<script src="/js/pos-payment-qr.js"></script>
<script>
  document.addEventListener("DOMContentLoaded", function () {
    var refreshBtn = document.getElementById("refreshQRBtn");
    if (refreshBtn) {
      refreshBtn.onclick = function () {
        var orderCode = this.getAttribute("data-ordercode");
        if (orderCode) {
          window.location.href = "/pos/payment-qr?orderCode=" + orderCode;
        }
      };
    }
  });
</script>
