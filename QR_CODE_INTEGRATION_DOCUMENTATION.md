# H·ªÜ TH·ªêNG T√çCH H·ª¢P V√Ä T·∫†O QR CODE CHO B√ÅN H√ÄNG OFFLINE

## T·ªîNG QUAN

H·ªá th·ªëng POS (Point of Sale) t√≠ch h·ª£p nhi·ªÅu ph∆∞∆°ng th·ª©c thanh to√°n, ƒë·∫∑c bi·ªát l√† QR Code payment ƒë·ªÉ h·ªó tr·ª£ b√°n h√†ng offline. T√†i li·ªáu n√†y m√¥ t·∫£ chi ti·∫øt c√°ch t√≠ch h·ª£p v√† c√†i ƒë·∫∑t QR code payment trong h·ªá th·ªëng.

## KI·∫æN TR√öC H·ªÜ TH·ªêNG

### 1. C·∫•u tr√∫c th√†nh ph·∫ßn ch√≠nh

```
üìÅ QR Code Payment System
‚îú‚îÄ‚îÄ üèóÔ∏è Backend Components
‚îÇ   ‚îú‚îÄ‚îÄ QRCodeService.java              # Service t·∫°o QR code
‚îÇ   ‚îú‚îÄ‚îÄ PosController.java              # Controller x·ª≠ l√Ω POS
‚îÇ   ‚îî‚îÄ‚îÄ PayOSServiceImpl.java           # Service PayOS (t√πy ch·ªçn)
‚îú‚îÄ‚îÄ üé® Frontend Components
‚îÇ   ‚îú‚îÄ‚îÄ pos.html                        # Giao di·ªán POS ch√≠nh
‚îÇ   ‚îú‚îÄ‚îÄ pos-payment-qr.html             # Trang hi·ªÉn th·ªã QR
‚îÇ   ‚îú‚îÄ‚îÄ pos.js                          # Logic POS
‚îÇ   ‚îî‚îÄ‚îÄ pos-payment-qr.js               # Logic x·ª≠ l√Ω QR
‚îî‚îÄ‚îÄ üìö Resources
    ‚îú‚îÄ‚îÄ static/images/qr/               # Th∆∞ m·ª•c l∆∞u QR codes
    ‚îî‚îÄ‚îÄ application.properties          # C·∫•u h√¨nh PayOS
```

## C√ÅC PH∆Ø∆†NG TH·ª®C THANH TO√ÅN

### 1. Thanh to√°n ti·ªÅn m·∫∑t (CASH)

- **Lu·ªìng**: Ch·ªçn s·∫£n ph·∫©m ‚Üí Checkout ‚Üí X√°c nh·∫≠n ti·ªÅn m·∫∑t ‚Üí Ho√†n t·∫•t
- **Tr·∫°ng th√°i**: Tr·ª±c ti·∫øp chuy·ªÉn sang "Ho√†n t·∫•t"
- **In h√≥a ƒë∆°n**: T·ª± ƒë·ªông redirect ƒë·∫øn trang in bill

### 2. Thanh to√°n QR chuy·ªÉn kho·∫£n ng√¢n h√†ng

- **API**: VietQR API
- **Lu·ªìng**: Ch·ªçn s·∫£n ph·∫©m ‚Üí Checkout QR ‚Üí T·∫°o QR ‚Üí Hi·ªÉn th·ªã ‚Üí X√°c nh·∫≠n th·ªß c√¥ng
- **ƒê·∫∑c ƒëi·ªÉm**: S·ª≠ d·ª•ng VietQR API ƒë·ªÉ t·∫°o QR chuy·ªÉn kho·∫£n tr·ª±c ti·∫øp

### 3. Thanh to√°n QR th·∫ª (EMV QR)

- **Chu·∫©n**: EMV QR Code Standard
- **Lu·ªìng**: T∆∞∆°ng t·ª± QR ng√¢n h√†ng nh∆∞ng s·ª≠ d·ª•ng chu·∫©n EMV
- **ƒê·∫∑c ƒëi·ªÉm**: T·∫°o QR code theo chu·∫©n qu·ªëc t·∫ø EMV

## CHI TI·∫æT TRI·ªÇN KHAI

### 1. QRCodeService Implementation

#### 1.1. C·∫•u h√¨nh c∆° b·∫£n

```java
@Service
public class QRCodeService {
    private static final String QR_CODE_IMAGE_PATH = "target/classes/static/images/qr/";

    // Ph∆∞∆°ng th·ª©c t·∫°o QR code c∆° b·∫£n
    public String generateQRCodeImage(String text, int width, int height, String fileName)
            throws WriterException, IOException {
        QRCodeWriter qrCodeWriter = new QRCodeWriter();
        BitMatrix bitMatrix = qrCodeWriter.encode(text, BarcodeFormat.QR_CODE, width, height);
        Path path = FileSystems.getDefault().getPath(QR_CODE_IMAGE_PATH + fileName);
        MatrixToImageWriter.writeToPath(bitMatrix, "PNG", path);
        return "/images/qr/" + fileName;
    }
}
```

#### 1.2. QR Chuy·ªÉn kho·∫£n ng√¢n h√†ng (VietQR)

```java
public String generateBankTransferQR(String orderCode, double amount,
                                   String bankAccount, String bankCode, String accountName) {
    try {
        // C·∫•u h√¨nh th√¥ng tin ng√¢n h√†ng
        String acqId = "970407";  // Techcombank AcqId
        String addInfo = "Thanh toan don hang " + orderCode;
        String apiUrl = "https://api.vietqr.io/v2/generate";

        // T·∫°o JSON request body
        String jsonBody = String.format(
            "{\"accountNo\":\"%s\",\"accountName\":\"%s\",\"acqId\":\"%s\"," +
            "\"amount\":%.0f,\"addInfo\":\"%s\",\"format\":\"png\"}",
            bankAccount, accountName, acqId, amount, addInfo
        );

        // G·ªçi API VietQR
        URL url = new URL(apiUrl);
        HttpURLConnection conn = (HttpURLConnection) url.openConnection();
        conn.setRequestMethod("POST");
        conn.setRequestProperty("Content-Type", "application/json");
        conn.setDoOutput(true);

        // G·ª≠i request
        try (OutputStream os = conn.getOutputStream()) {
            byte[] input = jsonBody.getBytes("utf-8");
            os.write(input, 0, input.length);
        }

        // ƒê·ªçc response v√† extract base64 image
        if (conn.getResponseCode() == 200) {
            // Parse JSON response ƒë·ªÉ l·∫•y base64 image
            String json = readResponse(conn);
            String base64 = extractBase64FromJson(json);

            if (base64 != null) {
                // Decode v√† l∆∞u file
                byte[] imageBytes = Base64.getDecoder().decode(base64);
                String fileName = "transfer_" + orderCode + ".png";
                Path path = Paths.get(QR_CODE_IMAGE_PATH + fileName);
                Files.write(path, imageBytes);
                return "/images/qr/" + fileName;
            }
        }
    } catch (Exception e) {
        e.printStackTrace();
    }
    return null;
}
```

#### 1.3. QR Thanh to√°n th·∫ª (EMV Standard)

```java
public String generatePaymentQRCode(String orderCode, double amount, String bankAccount) {
    try {
        // T·∫°o n·ªôi dung QR theo chu·∫©n EMV
        String qrContent = String.format(
            "00020101021138570010A00000072701270006970455011%s0208QRIBFTTA5303704540%.0f5802VN6304",
            bankAccount, amount
        );

        String fileName = "payment_" + orderCode + ".png";
        return generateQRCodeImage(qrContent, 300, 300, fileName);
    } catch (Exception e) {
        e.printStackTrace();
        return null;
    }
}
```

### 2. PosController Implementation

#### 2.1. Checkout Process

```java
@PostMapping("/checkout")
public String checkout(@RequestParam String paymentMethod,
                      HttpSession session, Model model) {
    try {
        // L·∫•y gi·ªè h√†ng t·ª´ session
        List<CartItemDTO> cart = (List<CartItemDTO>) session.getAttribute("cart");
        if (cart == null || cart.isEmpty()) {
            return "redirect:/pos?error=empty_cart";
        }

        // T·∫°o ƒë∆°n h√†ng
        Order order = createOrderFromCart(cart, session);

        // X·ª≠ l√Ω theo ph∆∞∆°ng th·ª©c thanh to√°n
        if ("qr_code".equalsIgnoreCase(paymentMethod)) {
            return handleQRCodePayment(order, session);
        } else if ("card".equalsIgnoreCase(paymentMethod)) {
            return handleCardPayment(order, session);
        } else {
            return handleCashPayment(order, session);
        }
    } catch (Exception e) {
        return "redirect:/pos?error=system_error";
    }
}
```

#### 2.2. QR Payment Handler

```java
private String handleQRCodePayment(Order order, HttpSession session) {
    try {
        // C·∫•u h√¨nh th√¥ng tin ng√¢n h√†ng
        String bankAccount = "19039778212018";
        String bankCode = "TCB";
        String accountName = "BUI ANH THIEN";

        // T·∫°o th∆∞ m·ª•c QR n·∫øu ch∆∞a c√≥
        File qrDir = new File("target/classes/static/images/qr/");
        if (!qrDir.exists()) qrDir.mkdirs();

        // T·∫°o QR code
        String qrCodePath = qrCodeService.generateBankTransferQR(
            order.getOrderCode(),
            order.getTotalAmount(),
            bankAccount,
            bankCode,
            accountName
        );

        if (qrCodePath != null) {
            // L∆∞u th√¥ng tin v√†o session
            session.setAttribute("pendingOrder", order.getOrderCode());
            session.setAttribute("qrCodePath", qrCodePath);
            session.removeAttribute("cart");

            return "redirect:/pos/payment-qr?orderCode=" + order.getOrderCode();
        } else {
            return "redirect:/pos?error=qr_generation_failed";
        }
    } catch (Exception e) {
        e.printStackTrace();
        return "redirect:/pos?error=qr_generation_failed";
    }
}
```

#### 2.3. Manual Payment Confirmation

```java
@PostMapping("/manual-confirm-payment")
@ResponseBody
public Map<String, Object> manualConfirmPayment(@RequestBody Map<String, String> requestBody) {
    Map<String, Object> response = new HashMap<>();
    try {
        String orderCode = requestBody.get("orderCode");
        if (orderCode == null || orderCode.isEmpty()) {
            response.put("success", false);
            response.put("message", "Vui l√≤ng nh·∫≠p m√£ ƒë∆°n h√†ng");
            return response;
        }

        Optional<Order> orderOpt = orderDAO.findByOrderCode(orderCode);
        if (orderOpt.isPresent()) {
            Order order = orderOpt.get();
            // C·∫≠p nh·∫≠t tr·∫°ng th√°i thanh to√°n
            order.setStatus("Ho√†n t·∫•t");
            order.setPaymentStatus("ƒê√£ thanh to√°n");
            orderDAO.save(order);

            response.put("success", true);
            response.put("message", "ƒê√£ x√°c nh·∫≠n thanh to√°n cho ƒë∆°n h√†ng");
            response.put("redirectUrl", "/pos/bill?orderCode=" + orderCode);
        } else {
            response.put("success", false);
            response.put("message", "Kh√¥ng t√¨m th·∫•y ƒë∆°n h√†ng");
        }
    } catch (Exception e) {
        response.put("success", false);
        response.put("message", "L·ªói: " + e.getMessage());
    }
    return response;
}
```

### 3. Frontend Implementation

#### 3.1. QR Payment Display (pos-payment-qr.html)

```html
<div class="qr-main-container">
  <div class="qr-left">
    <div class="qr-title">
      <i class="fas fa-qrcode"></i> Qu√©t m√£ QR ƒë·ªÉ thanh to√°n
    </div>

    <!-- QR Code Image -->
    <img
      th:src="${qrCodePath}"
      alt="QR Code thanh to√°n"
      class="qr-img"
      onerror="handleQRLoadError(this)"
    />

    <!-- Order Information -->
    <div class="qr-order-info">
      <div class="info-block">
        <div class="info-label">M√£ ƒë∆°n</div>
        <div class="info-value" th:text="${orderCode}"></div>
      </div>
      <div class="info-block">
        <div class="info-label">S·ªë ti·ªÅn</div>
        <div
          class="info-value text-danger"
          th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'"
        ></div>
      </div>
    </div>

    <!-- Payment Instructions -->
    <div class="qr-instructions">
      <h6><i class="fas fa-mobile-alt"></i> H∆∞·ªõng d·∫´n thanh to√°n:</h6>
      <ol>
        <li>M·ªü ·ª©ng d·ª•ng ng√¢n h√†ng tr√™n ƒëi·ªán tho·∫°i</li>
        <li>Ch·ªçn ch·ª©c nƒÉng "Qu√©t QR" ho·∫∑c "Chuy·ªÉn kho·∫£n QR"</li>
        <li>Qu√©t m√£ QR tr√™n m√†n h√¨nh</li>
        <li>X√°c nh·∫≠n th√¥ng tin v√† ho√†n t·∫•t thanh to√°n</li>
      </ol>
    </div>
  </div>

  <div class="qr-right">
    <!-- Order Details -->
    <div class="qr-summary-title">
      <i class="fas fa-cash-register"></i> Chi ti·∫øt ƒë∆°n h√†ng
    </div>

    <!-- Order Items Table -->
    <table class="table qr-summary-table">
      <thead>
        <tr>
          <th>S·∫£n ph·∫©m</th>
          <th>SL</th>
          <th>Gi√°</th>
        </tr>
      </thead>
      <tbody>
        <tr th:each="detail : ${orderDetails}">
          <td><small th:text="${detail.product.name}"></small></td>
          <td class="text-center" th:text="${detail.quantity}"></td>
          <td class="text-end">
            <small
              th:text="${#numbers.formatDecimal(detail.price * detail.quantity, 0, 'COMMA', 0, 'POINT')}"
            ></small>
          </td>
        </tr>
      </tbody>
      <tfoot>
        <tr>
          <th colspan="2">üí∞ T·ªïng:</th>
          <th
            class="text-end"
            th:text="${#numbers.formatDecimal(totalAmount, 0, 'COMMA', 0, 'POINT')} + ' VNƒê'"
          ></th>
        </tr>
      </tfoot>
    </table>

    <!-- Countdown Timer -->
    <div class="qr-countdown">
      <span id="countdown">15:00</span>
      <div style="font-size: 0.95em; color: #888">Th·ªùi gian ch·ªù thanh to√°n</div>
      <div class="progress" style="height: 8px; margin-top: 6px">
        <div
          id="progressBar"
          class="progress-bar progress-bar-striped progress-bar-animated bg-warning"
          role="progressbar"
          style="width: 100%"
        ></div>
      </div>
    </div>

    <!-- Payment Status -->
    <div id="statusAlert" class="qr-status alert alert-warning">
      <i class="fas fa-hourglass-half"></i> ƒêang ch·ªù kh√°ch h√†ng thanh to√°n...
    </div>

    <!-- Action Buttons -->
    <div class="qr-actions">
      <button
        class="btn btn-success"
        id="manualConfirmBtn"
        data-bs-toggle="modal"
        data-bs-target="#confirmPaymentModal"
      >
        <i class="fas fa-check"></i> X√°c nh·∫≠n ƒë√£ thanh to√°n
      </button>
      <button class="btn btn-info" id="printQRBtn">
        <i class="fas fa-print"></i> In m√£ QR
      </button>
      <button
        type="button"
        class="btn btn-outline-danger"
        data-bs-toggle="modal"
        data-bs-target="#cancelOrderModal"
      >
        <i class="fas fa-times"></i> H·ªßy & Quay l·∫°i POS
      </button>
    </div>
  </div>
</div>
```

#### 3.2. JavaScript Functionality (pos-payment-qr.js)

```javascript
// Countdown Timer
let timeLeft = 15 * 60; // 15 ph√∫t
let totalTime = 15 * 60;

function updateCountdown() {
  const minutes = Math.floor(timeLeft / 60);
  const seconds = timeLeft % 60;
  document.getElementById("countdown").textContent = `${minutes
    .toString()
    .padStart(2, "0")}:${seconds.toString().padStart(2, "0")}`;

  // C·∫≠p nh·∫≠t progress bar
  const progress = (timeLeft / totalTime) * 100;
  document.getElementById("progressBar").style.width = progress + "%";

  if (timeLeft <= 0) {
    // H·∫øt th·ªùi gian
    document.getElementById("statusAlert").innerHTML =
      '<i class="fas fa-clock"></i> H·∫øt th·ªùi gian thanh to√°n!';
    document.getElementById("statusAlert").className =
      "qr-status alert alert-danger";
  }

  timeLeft--;
}

// Ch·∫°y countdown m·ªói gi√¢y
setInterval(updateCountdown, 1000);

// Print QR Code
const printQRBtn = document.getElementById("printQRBtn");
if (printQRBtn) {
  printQRBtn.addEventListener("click", function () {
    const qrImage = document.querySelector('img[alt="QR Code thanh to√°n"]');
    const orderCode =
      document.querySelector(".info-value")?.textContent.trim() || "";
    const totalAmount =
      document.querySelector(".info-value.text-danger")?.textContent.trim() ||
      "";

    function printQR(qrImageHtml) {
      const printWindow = window.open("", "_blank");
      printWindow.document.write(`
                <html>
                <head>
                    <title>In m√£ QR - ${orderCode}</title>
                    <style>
                        body { font-family: Arial, sans-serif; text-align: center; padding: 20px; }
                        .qr-container { border: 2px solid #333; padding: 20px; margin: 20px auto; max-width: 400px; }
                        img { max-width: 300px; margin: 20px 0; }
                        .info { margin: 10px 0; font-size: 14px; }
                        .total { font-size: 18px; font-weight: bold; color: #d9534f; }
                    </style>
                </head>
                <body>
                    <div class="qr-container">
                        <h2>üå∏ C·ª≠a H√†ng Hoa</h2>
                        <div class="info">M√£ ƒë∆°n h√†ng: <strong>${orderCode}</strong></div>
                        ${qrImageHtml}
                        <div class="total">T·ªïng ti·ªÅn: ${totalAmount}</div>
                        <div class="info">Qu√©t m√£ QR ƒë·ªÉ thanh to√°n</div>
                        <div class="info"><small>C·∫£m ∆°n qu√Ω kh√°ch!</small></div>
                    </div>
                </body>
                </html>
            `);
      printWindow.document.close();
      printWindow.print();
    }

    // Convert image to base64 cho print
    if (qrImage && qrImage.src && !qrImage.src.startsWith("data:")) {
      fetch(qrImage.src)
        .then((res) => res.blob())
        .then((blob) => {
          const reader = new FileReader();
          reader.onloadend = function () {
            printQR(`<img src="${reader.result}" alt="QR Code">`);
          };
          reader.readAsDataURL(blob);
        });
    } else {
      let qrImageHtml =
        qrImage && qrImage.src
          ? `<img src="${qrImage.src}" alt="QR Code">`
          : "<div style='color:red;'>Kh√¥ng c√≥ m√£ QR</div>";
      printQR(qrImageHtml);
    }
  });
}

// Manual Payment Confirmation
const confirmPaymentModal = document.getElementById("confirmPaymentModal");
if (confirmPaymentModal) {
  confirmPaymentModal.addEventListener("show.bs.modal", function () {
    let confirmBtn = document.getElementById("confirmPaymentActionBtn");
    if (confirmBtn) {
      confirmBtn.onclick = function () {
        let orderCode = this.getAttribute("data-ordercode");
        if (!orderCode) {
          alert("Kh√¥ng t√¨m th·∫•y m√£ ƒë∆°n h√†ng!");
          return;
        }

        fetch("/pos/manual-confirm-payment", {
          method: "POST",
          headers: { "Content-Type": "application/json" },
          body: JSON.stringify({ orderCode: orderCode }),
        })
          .then((res) => res.json())
          .then((data) => {
            if (data.success) {
              // Th√†nh c√¥ng
              document.getElementById("statusAlert").innerHTML =
                '<i class="fas fa-check-circle"></i> ƒê√£ x√°c nh·∫≠n thanh to√°n th√†nh c√¥ng!';
              document.getElementById("statusAlert").className =
                "qr-status alert alert-success";

              // ·∫®n modal v√† chuy·ªÉn trang
              const modal = bootstrap.Modal.getInstance(confirmPaymentModal);
              modal.hide();

              setTimeout(() => {
                if (data.redirectUrl) {
                  window.location.href = data.redirectUrl;
                } else {
                  window.location.href = "/pos?success=payment_completed";
                }
              }, 1500);
            } else {
              alert("L·ªói: " + data.message);
            }
          })
          .catch((error) => {
            console.error("Error:", error);
            alert("C√≥ l·ªói x·∫£y ra khi x√°c nh·∫≠n thanh to√°n!");
          });
      };
    }
  });
}
```

## C·∫§U H√åNH V√Ä THI·∫æT L·∫¨P

### 1. Dependencies (pom.xml)

```xml
<!-- QR Code Generation -->
<dependency>
    <groupId>com.google.zxing</groupId>
    <artifactId>core</artifactId>
    <version>3.5.1</version>
</dependency>
<dependency>
    <groupId>com.google.zxing</groupId>
    <artifactId>javase</artifactId>
    <version>3.5.1</version>
</dependency>

<!-- PayOS SDK (Optional) -->
<dependency>
    <groupId>vn.payos</groupId>
    <artifactId>payos-java</artifactId>
    <version>1.0.1</version>
</dependency>
```

### 2. Application Properties

```properties
# PayOS Configuration (n·∫øu s·ª≠ d·ª•ng)
payos.client-id=your-client-id
payos.api-key=your-api-key
payos.checksum-key=your-checksum-key

# QR Code Settings
qr.code.directory=target/classes/static/images/qr/
qr.code.size.width=300
qr.code.size.height=300

# Bank Transfer Settings
bank.account.number=19039778212018
bank.code=TCB
bank.account.name=BUI ANH THIEN
bank.acq.id=970407
```

### 3. C·∫•u tr√∫c th∆∞ m·ª•c

```
src/main/resources/static/
‚îú‚îÄ‚îÄ images/
‚îÇ   ‚îî‚îÄ‚îÄ qr/                    # Th∆∞ m·ª•c l∆∞u QR codes ƒë∆∞·ª£c t·∫°o
‚îÇ       ‚îú‚îÄ‚îÄ transfer_POS1.png  # QR chuy·ªÉn kho·∫£n
‚îÇ       ‚îú‚îÄ‚îÄ payment_POS2.png   # QR thanh to√°n th·∫ª
‚îÇ       ‚îî‚îÄ‚îÄ ...
‚îú‚îÄ‚îÄ css/
‚îÇ   ‚îî‚îÄ‚îÄ pos-payment-qr.css     # Styling cho QR payment
‚îî‚îÄ‚îÄ js/
    ‚îî‚îÄ‚îÄ pos-payment-qr.js      # Logic x·ª≠ l√Ω QR payment
```

## WORKFLOW HO√ÄN CH·ªàNH

### 1. Lu·ªìng Thanh To√°n QR Code

```
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Ch·ªçn s·∫£n ph·∫©m  ‚îÇ -> ‚îÇ   Th√™m v√†o gi·ªè   ‚îÇ -> ‚îÇ Ch·ªçn thanh to√°n ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
                                                          ‚îÇ
                                                          v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ T·∫°o ƒë∆°n h√†ng    ‚îÇ <- ‚îÇ   POST /checkout ‚îÇ <- ‚îÇ   QR Payment    ‚îÇ
‚îÇ Status: Ch·ªù TT  ‚îÇ    ‚îÇ                  ‚îÇ    ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ G·ªçi VietQR API  ‚îÇ -> ‚îÇ  T·∫°o QR Image    ‚îÇ -> ‚îÇ   L∆∞u v√†o file  ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ  Hi·ªÉn th·ªã QR    ‚îÇ -> ‚îÇ Kh√°ch qu√©t & TT  ‚îÇ -> ‚îÇ X√°c nh·∫≠n th·ªß c√¥ng‚îÇ
‚îÇ  + Countdown    ‚îÇ    ‚îÇ                  ‚îÇ    ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
          ‚îÇ
          v
‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê    ‚îå‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îê
‚îÇ C·∫≠p nh·∫≠t Order  ‚îÇ -> ‚îÇ  In h√≥a ƒë∆°n      ‚îÇ -> ‚îÇ   Ho√†n t·∫•t      ‚îÇ
‚îÇ Status: Ho√†n t·∫•t‚îÇ    ‚îÇ                  ‚îÇ    ‚îÇ                 ‚îÇ
‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò    ‚îî‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îÄ‚îò
```

### 2. Tr·∫°ng th√°i ƒë∆°n h√†ng

```
Tr·∫°ng th√°i ƒë∆°n h√†ng POS:
‚îú‚îÄ‚îÄ "Ch·ªù thanh to√°n"     # V·ª´a t·∫°o, ƒëang hi·ªÉn th·ªã QR
‚îú‚îÄ‚îÄ "Ho√†n t·∫•t"           # ƒê√£ thanh to√°n (ti·ªÅn m·∫∑t ho·∫∑c x√°c nh·∫≠n QR)
‚îî‚îÄ‚îÄ "ƒê√£ h·ªßy"             # H·ªßy trong qu√° tr√¨nh thanh to√°n QR

Tr·∫°ng th√°i thanh to√°n:
‚îú‚îÄ‚îÄ "Ch∆∞a thanh to√°n"    # QR code payments
‚îú‚îÄ‚îÄ "ƒê√£ thanh to√°n"      # Sau khi x√°c nh·∫≠n
‚îî‚îÄ‚îÄ "ƒê√£ h·ªßy"             # H·ªßy thanh to√°n
```

## T√çNH NƒÇNG N√ÇNG CAO

### 1. Auto-refresh Payment Status

```javascript
// Polling ƒë·ªÉ ki·ªÉm tra tr·∫°ng th√°i thanh to√°n t·ª± ƒë·ªông
function checkPaymentStatus() {
  const orderCode = getCurrentOrderCode();

  fetch(`/pos/payment-status?orderCode=${orderCode}`)
    .then((res) => res.json())
    .then((data) => {
      if (data.status === "PAID") {
        // T·ª± ƒë·ªông chuy·ªÉn trang khi thanh to√°n th√†nh c√¥ng
        window.location.href = `/pos/bill?orderCode=${orderCode}`;
      }
    })
    .catch(console.error);
}

// Ki·ªÉm tra m·ªói 10 gi√¢y
setInterval(checkPaymentStatus, 10000);
```

### 2. QR Code Error Handling

```javascript
function handleQRLoadError(img) {
  // Hi·ªÉn th·ªã fallback khi QR load l·ªói
  img.style.display = "none";
  const fallback = document.getElementById("qr-fallback");
  if (fallback) {
    fallback.style.display = "block";
  }

  // Log l·ªói ƒë·ªÉ debug
  console.error("QR Code load failed:", img.src);
}
```

### 3. Print Functionality Enhancement

```javascript
function enhancedPrintQR() {
  // T·∫°o template in ƒë·∫πp h∆°n v·ªõi logo, th√¥ng tin shop
  const printContent = `
        <div class="receipt">
            <div class="header">
                <img src="/images/logo.png" alt="Logo">
                <h1>FLOWER SHOP</h1>
                <p>ƒê·ªãa ch·ªâ: 123 ƒê∆∞·ªùng ABC, Qu·∫≠n XYZ</p>
                <p>Hotline: 0123.456.789</p>
            </div>
            <div class="qr-section">
                <h2>THANH TO√ÅN QR CODE</h2>
                <img src="${qrCodeSrc}" alt="QR Payment">
                <p>M√£ ƒë∆°n: ${orderCode}</p>
                <p>T·ªïng ti·ªÅn: ${totalAmount}</p>
            </div>
            <div class="footer">
                <p>C·∫£m ∆°n qu√Ω kh√°ch!</p>
                <p>Th·ªùi gian: ${new Date().toLocaleString()}</p>
            </div>
        </div>
    `;

  // M·ªü c·ª≠a s·ªï in v·ªõi CSS ƒë∆∞·ª£c t·ªëi ∆∞u
  const printWindow = window.open("", "_blank");
  printWindow.document.write(getPrintTemplate(printContent));
  printWindow.print();
}
```

## B·∫¢O M·∫¨T V√Ä T·ªêI ∆ØU

### 1. B·∫£o m·∫≠t th√¥ng tin

- **M√£ h√≥a th√¥ng tin nh·∫°y c·∫£m**: S·ª≠ d·ª•ng environment variables cho API keys
- **Validate input**: Ki·ªÉm tra t·∫•t c·∫£ input t·ª´ frontend
- **Rate limiting**: Gi·ªõi h·∫°n s·ªë l·∫ßn t·∫°o QR code per session
- **HTTPS**: ƒê·∫£m b·∫£o all communications qua HTTPS

### 2. T·ªëi ∆∞u performance

- **QR Code caching**: Cache QR codes ƒë√£ t·∫°o
- **Image optimization**: T·ªëi ∆∞u k√≠ch th∆∞·ªõc QR images
- **Session management**: Clean up expired sessions
- **Database indexing**: Index tr√™n orderCode, status

### 3. Error Handling Best Practices

```java
@ExceptionHandler(Exception.class)
public String handleQRGenerationError(Exception e, Model model) {
    log.error("QR Generation Error: ", e);
    model.addAttribute("errorMessage", "Kh√¥ng th·ªÉ t·∫°o m√£ QR. Vui l√≤ng th·ª≠ l·∫°i.");
    return "redirect:/pos?error=qr_generation_failed";
}
```

## TESTING V√Ä DEBUGGING

### 1. Test Cases ch√≠nh

- ‚úÖ T·∫°o QR code th√†nh c√¥ng
- ‚úÖ X·ª≠ l√Ω l·ªói API VietQR
- ‚úÖ Timeout countdown
- ‚úÖ Manual confirmation
- ‚úÖ Print functionality
- ‚úÖ Order cancellation
- ‚úÖ Session management

### 2. Debug Tools

```javascript
// Debug mode cho development
const DEBUG_MODE = true;

if (DEBUG_MODE) {
  console.log("QR Code Path:", qrCodePath);
  console.log("Order Code:", orderCode);
  console.log("Total Amount:", totalAmount);

  // Th√™m debug buttons
  addDebugButtons();
}

function addDebugButtons() {
  const debugPanel = document.createElement("div");
  debugPanel.innerHTML = `
        <div style="position: fixed; top: 10px; right: 10px; background: #fff; padding: 10px; border: 1px solid #ccc;">
            <h5>Debug Panel</h5>
            <button onclick="simulatePaymentSuccess()">Simulate Payment Success</button>
            <button onclick="simulateTimeout()">Simulate Timeout</button>
            <button onclick="showQRInfo()">Show QR Info</button>
        </div>
    `;
  document.body.appendChild(debugPanel);
}
```

## K·∫æT LU·∫¨N

H·ªá th·ªëng QR Code Payment ƒë√£ ƒë∆∞·ª£c t√≠ch h·ª£p ho√†n ch·ªânh v·ªõi c√°c t√≠nh nƒÉng:

### ‚úÖ ƒê√£ ho√†n th√†nh

- T·∫°o QR chuy·ªÉn kho·∫£n ng√¢n h√†ng (VietQR API)
- T·∫°o QR thanh to√°n th·∫ª (EMV standard)
- Giao di·ªán hi·ªÉn th·ªã QR ƒë·∫πp v√† responsive
- Countdown timer v√† progress bar
- X√°c nh·∫≠n thanh to√°n th·ªß c√¥ng
- Print QR code functionality
- Error handling v√† fallback
- Session management

### üîÑ C√≥ th·ªÉ m·ªü r·ªông

- Webhook payment verification
- Real-time payment status updates
- Multiple payment gateways integration
- Advanced analytics v√† reporting
- Mobile app integration
- Inventory real-time updates

### üìã Maintenance Notes

- ƒê·ªãnh k·ª≥ ki·ªÉm tra VietQR API status
- Monitor QR code file storage
- Clean up expired order sessions
- Update bank information n·∫øu c·∫ßn
- Performance monitoring v√† optimization

---

**T√†i li·ªáu n√†y cung c·∫•p ƒë·∫ßy ƒë·ªß th√¥ng tin ƒë·ªÉ hi·ªÉu, tri·ªÉn khai v√† maintenance h·ªá th·ªëng QR Code Payment trong ·ª©ng d·ª•ng POS. ƒê·ªÉ bi·∫øt th√™m chi ti·∫øt v·ªÅ t·ª´ng component, vui l√≤ng tham kh·∫£o source code t∆∞∆°ng ·ª©ng.**
